



<!DOCTYPE html>
<html>

<!-- Mirrored from gestplus.okmas.net/GestPlus/okeymasTiendaProductos?idProveedor=1 by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 02 Apr 2025 10:35:34 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>


</head>
<body> 
<div id="content-block">
	 



 
 
<!DOCTYPE html>
<html lang="en">

<body class="fonts-1">





 
 

<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no, minimal-ui"/>
    
    <!-- fonts -->
    <link href="https://fonts.googleapis.com/css?family=Questrial|Raleway:700,900" rel="stylesheet">

<link href="resources/jimTienda/designUX/css/bootstrap.min-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/bootstrap.extension-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/style-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/swiper-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/sumoselect-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/font-awesome.min-2.css"  rel="stylesheet"></link>
    
<!-- scripts -->
<script  src="resources/jimTienda/designUX/js/jquery-2.2.4.min.js"></script>
<script  src="resources/jimTienda/designUX/js/swiper.jquery.min.js"></script>
<script  src="resources/jimTienda/designUX/js/global.js"></script>

<!-- range slider -->
<script  src="resources/jimTienda/designUX/js/jquery-ui.min.js"></script>
<script  src="resources/jimTienda/designUX/js/jquery.ui.touch-punch.min.js"></script>


<script  src="resources/jimTienda/designUX/js/jquery.sumoselect.min.js"></script>


<script  src="resources/jimTienda/designUX/js/jquery.classycountdown.js"></script>
<script  src="resources/jimTienda/designUX/js/jquery.knob.js"></script>
<script  src="resources/jimTienda/designUX/js/jquery.throttle.js"></script>

<!-- masonry -->
<script src="resources/jimTienda/designUX/js/isotope.pkgd.min.js"></script>

<!--  estos scripts son necesarios para la parte de añadir productos a la cesta -->
<script src="../../cdn-na.infragistics.com/igniteui/latest/js/infragistics.core.js"></script>
<script src="../../cdn-na.infragistics.com/igniteui/latest/js/infragistics.dv.js"></script> 


<!-- MAP -->



<!-- CONTACT --> 
<script  src="resources/jimTienda/designUX/js/contact.form.js"></script>
    
<!-- OTROS -->  
<script src="resources/script/sweetalert.min.js"></script>
<script src="../../unpkg.com/bootstrap-table%401.15.5/dist/bootstrap-table.min.js"></script>


<link rel="shortcut icon" href="resources/jimTienda/designUX/img/favicon.ico" />

 <script src="../../cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
 
 <style>
        /* Loader toda la pantalla*/
        #loader {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* Fondo semitransparente */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* Animación de rotación */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Aplica la animación al SVG */
        #loader img {
            width: 50px; /* Ajusta el tamaño del SVG */
            height: 50px;
            animation: spin 1.5s linear infinite;
        }

        /* Ocultar el loader cuando esté listo */
        #loader.hidden {
            display: none;
        }
        
         /* Mostrar el loader cuando esté listo */
        #loader.show {
            display: block;
        }
        
    </style>
<title> </title>
</head>

<body>

<script type="text/javascript">
/***************************VARIABLES****************************/
var productosCarrito = [];
var numProdCarrito = 0;
var totales = 0; 
var pag = 1; 
var xPag = 30;//total de imágenes por página 
var nPag = 0;
var offset = 0;
var hasta = 0;

var cantidad=0;
var costeEnvio = 5;
var precioTotal = 0;
var listCarrito = [];
var jimSelect = 0;
var jimVarianteSelect = 0;
var listFilter = new Array(); 
var totalProd = 0;
var arrayProductos  = new Array();
var allProducts;
var allProductsJim; 
var allProductsHyper;
var allProductsNatur;

var elCliente;
var laDireccionEnvio;

var txtIva = " EUR (IVA INCLUIDO)"; 

var j=1;

var idProductoDevolver = 0;

var precio = '';
var nombre = '';
var ref =''; 
var stock = '';
var prov = '';
var nomProv = '';
var idProducto= '';
var idProdVariant = '';
var desc = '';

var isLoggedIn = '';
var direccionEnvio = '';
var emailLogged = '';
var pwdLogged = '';
var elProv ='1';
var idCli = '';


// var prodSesion = [];
/*
//Inicialmente agrega un estado ficticio al historial
history.pushState({ page: 1 }, "title 1", window.location.href);


// Escucha el evento "popstate"
window.addEventListener("popstate", function (event) {
  if (event.state && event.state.page === 1) {
    // Aquí se detecta cuando el usuario presiona "atrás"
    console.log("Botón 'Atrás' presionado");
    window.location.href = "https://gestplus.okmas.net/GestPlus/okeymasTiendaUX";
  }
});
*/ 

//------------------------------- Formulario de contacto -----------------------------------

/**
 * @author Juan Garcia
 *
 * Envia la respuesta recibida del formulario disponible en la pagina "okeymasTiendaContacto"
 */
function fn_sendContactForm() {
	
	var popup = ''; 
	
	// Rescatamos los datos del formulario con id = contactForm {contacto.jsp}
	var name 		= contactFormNombre.value;
	var lastname 	= contactFormApellidos.value;
	var phoneNumber = contactFormTelefono.value;
	var email		= contactFormEmail.value;
	var message		= contactFormMensaje.value;
	
	if(name && name !== ''
			&& lastname 	&& lastname !== ''
			&& phoneNumber 	&& phoneNumber !== ''
			&& email 		&& email !== ''
			&& message 		&& message !== ''){
		
		var params = {};
			params["nombre"] 	= name;
			params["apellidos"]	= lastname;
			params["movil"]		= phoneNumber;
			params["email"]		= email;
			params["mensaje"]	= message;
			
		 $.ajax({
	            url: "/GestPlus/sendContactForm",
	            type: "POST",
	            data: params,
	            success: function(data, textStatus) {
	                var errorMessage = data.error;
	                if (typeof (errorMessage) !== "undefined" && errorMessage !== null && errorMessage !== '') {
	                    swal("Se ha producido un error: " + errorMessage);
	                } else {
	                	
	                	popup = `
	    					<div class="popup-wrapper active">
	    					    <div class="bg-layer"></div>
	    					    <div class="popup-content active" data-rel="1">
	    					        <div class="layer-close"></div>
	    					        <div class="popup-container size-1">
	    					            <div class="popup-align">
	    					                <h3 class="h3 text-center">Gracias por confiar en nosotros</h3>
	    					                <div class="empty-space col-xs-b30"></div>
	    					                <h5 class="h5 text-center">Su solicitud será procesada por uno de nuestros agentes</h5>
	    					            </div>
	    					            <div class="button-close"></div>
	    					        </div>
	    					    </div>
	    					</div>`;
	    					
	                	// Inyectamos el popup en el cuerpo del documento
	                	document.body.innerHTML += popup;
	    					
	                }
	            },
	            dataType: "json"
	        });
	}else{
		popup = `
					<div class="popup-wrapper active">
					    <div class="bg-layer"></div>
					    <div class="popup-content active" data-rel="1">
					        <div class="layer-close"></div>
					        <div class="popup-container size-1">
					            <div class="popup-align">
					                <h3 class="h3 text-center">No podemos procesar la solicitud</h3>
					                <div class="empty-space col-xs-b30"></div>
					                <h5 class="h5 text-center">Debe rellenar todos los campos</h5>
					            </div>
					            <div class="button-close"></div>
					        </div>
					    </div>
					</div>`;
			// Inyectamos el popup en el cuerpo del documento
			document.body.innerHTML += popup;
					
	}
}

/*************************** INICIAR/CERRAR SESIÓN Y REGISTRO ****************************/

var compruebaEmail = function(email){ 
	if (email!==""){
		var params = {};
		params["email"]=email;
		$.ajax({
			url : "/GestPlus/compruebaEmailTienda",
			type : "POST",
			data : params,
			// myDataTable migth not exist
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"	&& errorMessage !== null 	&& errorMessage !== '') {
					swal("Se ha producido un error: "	+ errorMessage); 
				} else {
					var existeEmail = data.emailRegistrado; 
					if (existeEmail === true){
						swal("Este email ya pertenece a un usuario registrado.");
						$('#email').val(""); 
						$('#idEmailEnvio').val(""); 
					}
				}
			},
			dataType : "json"
		});	
	}
}
						
function fn_olvidoPwd(){
	
	if(idForgotEmail.value == ''){
		swal("Por favor, introduzca un email válido.");
		return false;
	}else if(idForgotPwd.value == ''){
		swal("Por favor, introduzca una nueva contraseña.");
		return false;
	}
	
	var params = {};
	params["email"] = idForgotEmail.value;
	params["newPwd"] = idForgotPwd.value;
	$.ajax({
		url : "/GestPlus/olvidoPwd",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal(errorMessage);
			} else {
				window.location.href= "okeymasTiendaMiCuenta.html";
			}
		},
		dataType : "json"
	});
}

function fn_login(isLogged){
	 
	if(idEmailLogin.value == ''){
		swal("Por favor, introduzca un email válido.");
		return false;
	}else if(idPwdLogin.value == ''){
		swal("Por favor, introduzca su contraseña.");
		return false;
	}
	
	var params = {};
	
	if(isLogged){
		params["email"] = emailLogged;
		params["pwd"] = pwdLogged;
	}else{
		params["email"] = idEmailLogin.value;
		params["pwd"] = idPwdLogin.value;
	}

	$.ajax({
		url : "/GestPlus/loginTienda",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal(errorMessage); 
			} else {
				// Si la cuenta existe, mostrar modal con el resumen de la compra
				// y un botón que lleve a la pasarela de pago 

			
				window.location.href= "okeymasTiendaMiCuenta.html";
				
				elCliente = data.cliente;
			}
		},
		/*error : function(data, textStatus) {
			var errorMessage = data.error;
			swal(errorMessage);  
		},*/
		dataType : "json"
	}); 
}

function fn_loginCh(isLogged){
	 
	if(idEmailLoginCh.value == ''){
		swal("Por favor, introduzca un email válido.");
		return false;
	}else if(idPwdLoginCh.value == ''){
		swal("Por favor, introduzca su contraseña.");
		return false;
	}
	
	var params = {};
	
	if(isLogged){
		params["email"] = emailLogged;
		params["pwd"] = pwdLogged;
	}else{
		params["email"] = idEmailLoginCh.value;
		params["pwd"] = idPwdLoginCh.value;
	}

	$.ajax({
		url : "/GestPlus/loginTienda",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal(errorMessage); 
			} else {
				// Si la cuenta existe, mostrar modal con el resumen de la compra
				// y un botón que lleve a la pasarela de pago 
				elCliente = data.cliente;
				window.location.href= "okeymasTiendaMiCuenta.html";
			}
		},
	
		dataType : "json"
	}); 
}

function fn_cerrarSesion(){
	if(confirm("¿Está seguro de cerrar sesión?")){
		var params = {};
		$.ajax({
			url : "/GestPlus/logoutTienda",
			type : "POST",
			data : params,
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal(errorMessage); 
				} else {
					window.location.href= "okeymasTiendaUX.html";

					
					//localStorage.clear(); // para limpiar el carrito almacenado en el navegador 
					//location.reload();
				}
			},
			dataType : "json"
		}); 
	}	
}

function fn_registrar(){
	if(validarCliente()){
		var params = {};
		params["nombre"] = nombreCliente.value;
		params["apellidos"] = apellidos.value;
		params["email"] = email.value;
		params["movil"] = movil.value;
		params["pwd"] = idPwd.value;
		
		params["direccion.provincia"] =  provincia.value; 
		params["direccion.street"] =  direccion.value; 
		params["direccion.street2"] = numero.value; 
		params["direccion.zip"] = codPost.value; 
		params["direccion.city"] = localidad.value;
		var tipoDirec = document.getElementById("tipo");
		params["direccion.tipo"] = tipoDirec.value;
		params["direccion.country_code"] = "ES";
		
		//params["direccion.partner_ref"] ="0001";//esto sería el purchase para identificar el pedido, por ejemplo j29231003125 
		//params["direccion.observations"] = "PEDIDO DE PRUEBA, NO TRAMITAR (SABE PABLO)";//observ.value
		//params["direccion.note"] ="Pedido Web DEPOROCIO\nReferencia Web, 0001";
		
		if(idAceptaCond.checked)
			params["aceptaCondiciones"]=1;
		else
			params["aceptaCondiciones"]=0;
		
		if(idAceptaPromos.checked)
			params["aceptaPromos"]=1;
		else
			params["aceptaPromos"]=0;
		
		if(idAceptaComun.checked)
			params["aceptaComunicaciones"]=1;
		else
			params["aceptaComunicaciones"]=0;
		
		$.ajax({
			url : "/GestPlus/registroTiendaOkmas",
			type : "POST",
			data : params,
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal(errorMessage);
				} else {
					elCliente = data.cliente;
					swal("Registro realizado con éxito");
					document.querySelector(".swal-button--confirm")?.addEventListener("click", () => window.location.href= "okeymasTiendaMiCuenta.html");
					// window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaMiCuenta"; 
				}
			},
			dataType : "json"
		});
	}
}

function validarCliente(){
	if ($('#nombreCliente').val()==''){
		swal("Nombre vacío.");
		return false;
	} else if ($('#apellidos').val()==''){
		swal("Apellidos  vacío.");
		return false;
	} else if ($('#email').val()==''){
		swal("Email  vacío.");
		return false;
	} else if ($('#movil').val()==''){
		swal("Móvil  vacío.");
		return false;
	} else if ($('#idPwd').val()==''){
		swal("Password  vacío.");
		return false;
	}  else if ($('#idRepeatPwd').val()==''){
		swal("Repite password  vacío.");
		return false;
	} else if ($('#idPwd').val() != $('#idRepeatPwd').val()){
		swal("Los passwords no coinciden.");
		return false;
	} else if ($('#direccion').val()==''){
		swal("Dirección  vacía."); 
		return false;
	} else if(!idAceptaCond.checked){
		swal("Debes aceptar las condiciones."); 
		return false;
	}
	return true;  
}

function fn_updateCuenta(){
	if(confirm("¿Está seguro de que desea modificar sus datos?")){
		var params = {};
		params["idCliente"] = idCuentaCliente;
		params["nombre"] = idMiNombre.value;
		params["apellidos"] = idMisApellidos.value;
		params["movil"] = idMiMovil.value;
		
		params["direccion.tipo"] = idCuentaTipo.value;
		params["direccion.provincia"] =  idCuentaProv.value; 
		params["direccion.street"] =  idCuentaDireccion.value; 
		params["direccion.street2"] = idCuentaNum.value; 
		params["direccion.zip"] = idCuentaCodPost.value; 
		params["direccion.city"] = idCuentaLocalidad.value;
		
		params["direccion.country_code"] = "ES";

		$.ajax({
			url : "/GestPlus/updateCuenta",
			type : "POST",
			data : params,
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal(errorMessage); 
				} else {
					elCliente = data.cliente;
					window.location.href= "okeymasTiendaMiCuenta.html"; 
					
				}
			},
			dataType : "json"
		}); 
	}	
}
/*************************** CARRITO ****************************/

/**
 * @author Deporocio
 *
 *
 * Almacena los productos del carrito en una variable de sesión.
 */
function fn_saveCarrito(){
	var params = {};
	var i = 0; 
	
	listCarrito.forEach((element) => {
		params["productos["+i+"].quantity"] = element.quantity,
	    params["productos["+i+"].product_id"] = element.idProduct;
	    params["productos["+i+"].variant_id"] = element.prodVariant; 
	    params["productos["+i+"].idProveedor"] = element.idProveedor;
	    params["productos["+i+"].price"] = element.price;
	    params["productos["+i+"].imageData"] = element.imageData;
	    params["productos["+i+"].reference"] = element.reference;
	    params["productos["+i+"].nameEs"] = element.nameEs;
	    i++;
	});  
	$.ajax({
		url : "/GestPlus/saveCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist 
		success : function(data, textStatus) {
			var s = data.productos;
			productosCarrito = data.productos;
		}
	}); 
}

/*function fn_verCarrito(){ // click en la cesta
	var params = {};
	var i=0;  
	
	if( prodSesion )
		prodSesion.forEach((element) => {  
	        params["productos[" + i + "].quantity"] 	= element.quantity;
	        params["productos[" + i + "].product_id"] 	= element.idProduct;
	        params["productos[" + i + "].variant_id"]	= element.prodVariant; 
	        params["productos[" + i + "].idProveedor"] 	= element.idProveedor;
	        params["productos[" + i + "].price"] 		= element.price;
	        params["productos[" + i + "].imageData"] 	= element.imageData;
	        params["productos[" + i + "].reference"] 	= element.reference;
	        params["productos[" + i + "].nameEs"] 		= element.nameEs;
	        
	        console.log("producto del carrito: " + element.nameEs + ", cantidad: " + element.quantity);
	        i++;
	    });  
	
	$.ajax({
		url : "/GestPlus/verCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist 
		success : function(data, textStatus) {
			var s = data.productos;
			productosCarrito = data.productos;
				
			//var url = "https://gestplus.okmas.net/GestPlus/okeymasTiendaCarrito?productosCarrito";
			//window.open(url,'_self'); //en la misma página
			//window.open(url);//en otra página
			//fn_abrirCarrito();
			window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaCarrito";

		}
	}); 
}*/

async function fn_verCarrito(){ 
	if(numProdCarrito < 1){
		swal("No hay productos en el carrito.");
		return;
	}
	
	const prodSesion = await traerProdSesion();
	var params = {};
	var i=0;  
	
	if( prodSesion )
		prodSesion.forEach((element) => {  
	        params["productos[" + i + "].quantity"] 	= element.quantity;
	        params["productos[" + i + "].product_id"] 	= element.idProduct;
	        params["productos[" + i + "].variant_id"]	= element.prodVariant; 
	        params["productos[" + i + "].idProveedor"] 	= element.idProveedor;
	        params["productos[" + i + "].price"] 		= element.price;
	        params["productos[" + i + "].imageData"] 	= element.imageData;
	        params["productos[" + i + "].reference"] 	= element.reference;
	        params["productos[" + i + "].nameEs"] 		= element.nameEs;
	        
	        console.log("producto del carrito: " + element.nameEs + ", cantidad: " + element.quantity);
	        i++;
	    });  
	
	$.ajax({
		url : "/GestPlus/verCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist 
		success : function(data, textStatus) {
			var s = data.productos;
			productosCarrito = data.productos;
				
			//window.open(url,'_self'); //en la misma página
			//window.open("https://gestplus.okmas.net/GestPlus/okeymasTiendaCarrito");//en otra página
			//fn_abrirCarrito();
			
			window.location.href= "okeymasTiendaCarrito.html";
			
		}
	}); 
}

/**
 * @author Deporocio
 * Trae los productos asociados a la variable de sesion del cliente.
 *
 *
 * @return {void}
 */
 function traerProdSesion() {
	  return new Promise((resolve, reject) => {
	    var params = {};

	    $.ajax({
	      url: "/GestPlus/verProdSesion",
	      type: "POST",
	      data: params,
	      success: function(data, textStatus) {
	        var errorMessage = data.error;
	        if (typeof errorMessage !== "undefined" && errorMessage !== null && errorMessage !== '') {
	          swal(errorMessage);
	          reject(new Error(errorMessage));
	        } else {
	          var prodSesion = data.productos;
	          console.log("Recibida respuesta del servidor, prodSesion: " + prodSesion);
	          resolve(prodSesion);
	        }
	      },
	      dataType: "json"
	    });
	  });
}
 
 /*
 function fn_comprobarCarrito(){
	 if(numProdCarrito < 1){
		 swal("No hay productos en el carrito");
	 }else{
		 window.location.href="https://gestplus.okmas.net/GestPlus/okeymasTiendaCheckout";
	 }
 }
 
 
/*function fn_checkout(){
	if(numProdCarrito == 0){
		swal("No hay productos en el carrito.");
		return;
	}
	
	var params = {};
	
	var i=0;   
	listCarrito.forEach((element) => {
		params["productos["+i+"].quantity"] = element.quantity,
	    params["productos["+i+"].product_id"] = element.idProduct;
	    params["productos["+i+"].variant_id"] = element.prodVariant; 
	    params["productos["+i+"].idProveedor"] = element.idProveedor;
	    params["productos["+i+"].price"] = element.price;
	    params["productos["+i+"].imageData"] = element.imageData;
	    params["productos["+i+"].reference"] = element.reference;
	    params["productos["+i+"].nameEs"] = element.nameEs;
	    i++;
	});  
	$.ajax({
		url : "/GestPlus/saveCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist 
		success : function(data, textStatus) {
			var s = data.productos;
			productosCarrito = data.productos;
				
			window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaCheckout";
		}
	}); 
}*/



async function fn_checkout() {
	console.log("----------------- fn_checkout() -----------------");
   
	if(numProdCarrito == 0){
		swal("No hay productos en el carrito.");
		return;
	}
	
	var params = {};
    var outOfStockProducts = []; // Lista para productos sin stock
    var i = 0;

    for (const element of listCarrito) {
    	try {
            var response = await fn_checkStock(element.idProduct, element.prodVariant, element.idProveedor, element.quantity);
            
            if (response === true) {
            	params["productos[" + i + "].quantity"] 	= element.quantity,
    		    params["productos[" + i + "].product_id"] 	= element.idProduct;
    		    params["productos[" + i + "].variant_id"] 	= element.prodVariant; 
    		    params["productos[" + i + "].idProveedor"]	= element.idProveedor;
    		    params["productos[" + i + "].price"] 		= element.price;
    		    params["productos[" + i + "].imageData"] 	= element.imageData;
    		    params["productos[" + i + "].reference"] 	= element.reference;
    		    params["productos[" + i + "].nameEs"] 		= element.nameEs;
               
            } else {
            	outOfStockProducts.push(element.nameEs);
            }
            i++;
            
        } catch (error) {
            console.error("Error verificando stock para :" + error);
        }
    }

    // Si hay productos sin stock, mostrarlos y detener el proceso
    if (outOfStockProducts.length > 0) {
        swal("Los siguientes productos no tienen stock suficiente: \n" + outOfStockProducts.join(", "));
        return;
    }

    // Si todos los productos tienen stock, hacer la petición AJAX
    $.ajax({
        url: "/GestPlus/saveCarrito",
        type: "POST",
        data: params,
        success: function (data, textStatus) {
            productosCarrito = data.productos;
            window.location.href = "okeymasTiendaCheckout.html";
        },
        error: function (xhr, status, error) {
            console.error("Error en la petición AJAX:", error);
        }
    });
}

function removeProducto(idItem){
	var params = {};
	params["idItemCesta"] = idItem;
	$.ajax({
		url : "/GestPlus/removeProdCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal("", "Error: " + errorMessage, "warning");
			}else{
				var s = data.productos;
				productosCarrito = data.productos;
					
				window.location.href= "okeymasTiendaCarrito.html";
			}
		},
		dataType : "json"
	});
}

function fn_recalcularMas(idItem, precio,pos,item){
	let numero = Number.parseInt(item.parent().parent().find("input[name='contador']").val());  
    item.parent().parent().find("input[name='contador']").val(numero + 1);
	
	 cantidad += 1; 
	 $("#cantidadCarrito").val("Carrito (" + cantidad + ")");   
	 precioTotal += precio;
	 $("#idTotal").val(precioTotal.toFixed(2) + txtIva); 
	 
	 // hay que actualizar el campo prodSelect[idItem].cantidad = numero+1;
	 listCarrito[pos].cantidad = numero+1;
	 //fn_clonar(); 
}

function fn_recalcularMenos(idItem, precio, pos,item){
	 let numero = Number.parseInt(item.parent().parent().find("input[name='contador']").val());
     if(numero>1){ // así evitamos los negativos y el 0
     	item.parent().parent().find("input[name='contador']").val(numero - 1);	
     	cantidad -= 1; 
		$("#cantidadCarrito").val("Carrito (" + cantidad + ")");   
		 precioTotal -= precio;
		 $("#idTotal").val(precioTotal.toFixed(2) + txtIva); 
		 listCarrito[pos].cantidad = numero-1;
		 //fn_clonar();  
     }
}

async function fn_checkStock(idProduct, idVariant, idProveedor, quantity) {
	try{
		console.log("--------------- fn_checkStock()-----------------");
		 var product = await fn_getProductById(idProduct, idVariant, idProveedor);
		 
		 if(!product || typeof product.stock === "undefined"){
			 console.log("El producto no se encuentra disponible");
			 return false;
		 }
		 
		 if(product.stock < quantity){
			 console.log("No hay suficiente stock del producto seleccionado");
			 return false;
		 }
		 
	}catch(error) {
		console.log("Ha ocurrido un error durante la solicitud: " + error);
		swal("No se ha podido procesar la solicitud, intentelo más tarde");
		return false;
	}
	console.log("Hay stock del producto " + idProduct);
	 return true;
}

/*function fn_addProd(){
	var cantSelec = document.getElementById('idSpanCantidad').innerText;
	console.log("Cantidad seleccionada: " + cantSelec);
	var stockDisp = document.getElementById('idStockProd').innerText;
	
	if(stockDisp.equals('0')){
		swal("No hay stock.");
	}else if(parseInt(stockDisp) < parseInt(cantSelec)){
		swal("No hay stock suficiente para la cantidad elegida.");
	}else{
		fn_addCarrito(idProducto, idProdVariant, elProv, cantSelec);
	}
}*/

function fn_addProd(){
	console.log("--------------- fn_addProd()-----------------");
	var cantSelec = document.getElementById('idSpanCantidad').innerText;
	var stockDisp = document.getElementById('idStockProd').innerText;
	
	if(stockDisp.equals('0')){
		swal("No hay stock.");
	}else if(parseInt(stockDisp) < parseInt(cantSelec)){
		swal("No hay stock suficiente para la cantidad elegida.");
	}else{
		/**
		*
		* idProducto, idProdVariant, elProv, cantSelec son variables globales, cuyos valores
		* han sido extraidos del codigo HTML
		*
		*/
		fn_addCarrito(idProducto, idProdVariant, elProv, cantSelec);
	}
}

function fn_learnMore(idProduct,prodVariant,idProveedor){
// 	Jim - https://gestplus.okmas.net/GestPlus/findVariantByProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=1
// 	Hyper - https://gestplus.okmas.net/GestPlus/findVariantByHyperProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=2
// 	Natur - https://gestplus.okmas.net/GestPlus/findVariantByNaturProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=3
		
	console.log("Encontrado producto: " + idProduct + ", " + prodVariant + ", " + idProveedor);
		
	var params = {};
	params["jim_id"] = idProduct;
	params["idProveedor"]=idProveedor;
	switch (idProveedor) {
	case 1: // jim sport
		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+idProduct+"&idProveedor=1";
		break;
	case 2: // hypertrophy
		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+idProduct+"&idProveedor=2";
		break;
	case 3: // naturatal
		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+idProduct+"&idProveedor=3";
		break;
	default:
		break;
	}
}

function fn_findVariant(idProduct,prodVariant,idProveedor){

	var params = {};
	switch (idProveedor) {
	case 1: // jim sport
		params["jim_id"] = idProduct;
		$.ajax({
			url : "/GestPlus/findVariantByProductOld",
			type : "POST",
			data : params,
			// myDataTable migth not exist
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal("", "Error: " + errorMessage, "warning");
				}else{
					fn_learnMore(idProduct,prodVariant,idProveedor);
					/*if(data.totalRecords <= 1){ 
						fn_addCarrito(idProduct, prodVariant, idProveedor, 1);
					}else{
						fn_learnMore(idProduct,prodVariant,idProveedor);
					}*/
				}
			},
			dataType : "json"
		});
		break;
	case 2: // hypertrophy
		params["idProduct"] = idProduct;	
		$.ajax({
			url : "/GestPlus/findVariantByHyperProductOld",
			type : "POST",
			data : params,
			// myDataTable migth not exist
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal("", "Error: " + errorMessage, "warning");
				}else{
					fn_learnMore(idProduct,prodVariant,idProveedor);
					/*if(data.totalRecords <= 1){ 
						fn_addCarrito(idProduct,prodVariant,idProveedor,1);
					}else{
						fn_learnMore(idProduct,prodVariant,idProveedor);
					}*/
				}
			},
			dataType : "json"
		});
		break;
	case 3: // naturatal
		params["idProduct"] = idProduct;		
		$.ajax({
			url : "/GestPlus/findVariantByNaturProductOld",
			type : "POST",
			data : params,
			// myDataTable migth not exist
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal("", "Error: " + errorMessage, "warning");
				}else{
					
					fn_learnMore(idProduct, prodVariant, idProveedor);
					/*if(data.totalRecords <= 1){ 
						fn_addCarrito(idProduct, prodVariant, idProveedor, 1);
					}else{
						fn_learnMore(idProduct,prodVariant,idProveedor);
					}*/
				}
			},
			dataType : "json"
		});
		break;
	default:
		break;
	}
}

/*
function fn_updateCarrito(prod,cant){
	console.log("updateee");
	var params = {};
	params["idItemCesta"] = prod;
	params["cantidad"] = cant;
	$.ajax({
		url : "/GestPlus/updateCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal("", "Error: " + errorMessage, "warning");
			}else{
				var s = data.productos;
				productosCarrito = data.productos;
				window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaCarrito";
			}
		},
		dataType : "json"
	});
}*/


function fn_actualizarVblesGlobales(){
	precioTotal = '0'; // sin el IVA
	precioTotal = parseFloat(precioTotal);
	numProdCarrito = '0';
	if(numProdCarrito != null){
		if(!numProdCarrito.equals(""))
			numProdCarrito = parseInt(numProdCarrito); 
		else{
			numProdCarrito = 0; 
		}
	}
	console.log("precioTotal: " + precioTotal);
	console.log("numProdCarrito:  " + numProdCarrito);   
}

/*function fn_actualizarCarrito(){
 	var subT = 0;
	// Obtener todas las filas del tbody
	const filas = document.querySelectorAll('#idTablaCarrito tbody tr');
	
	filas.forEach((fila, i) => {
		  // Obtener todas las celdas de la fila
		  var p = fila.querySelector("#idProductoCarrito").innerText;
		  var c = fila.querySelector("#idCantidadCarrito").innerText;
		  //actualizo el total de esa fila:
		  fila.querySelector("#idTotalProductoCarrito").innerText = c * fila.querySelector("#idPriceCarrito").innerText;
		  //actualizo el subtotal:
		  subT += parseFloat(fila.querySelector("#idTotalProductoCarrito").innerText);
		  //falta actualizar la variable de sesión "productos" en el action
		  fn_updateCarrito(p,c);
	});
	//document.getElementById('idSubTotal').innerHTML = subT.toFixed(2);
	//document.getElementById('idTotalPagar').innerHTML = subT+5;
}*/

async function fn_actualizarCarrito(){
	console.log("--------------- fn_actualizarCarrito()-----------------");
	
	if( window.location.href.includes("okeymasTiendaCarrito") ) {
		console.log("Actualizando vista okeymasTiendaCarrito...");
		var subT = 0;
		// Obtener todas las filas del tbody
		const filas = document.querySelectorAll('#idTablaCarrito tbody tr');
		
		   for (const fila of filas) {
		        // Obtener todas las celdas de la fila
		        var idProduct = fila.querySelector("#idProductoCarrito").innerText;
		        var idVariant = fila.querySelector("#idVariantCarrito").innerText;
		        var idProveedor = fila.querySelector("#idProvCarrito").innerText;
		        var productQuantity = fila.querySelector("#idCantidadCarrito").innerText;
		        
		        try {
		            // Esperar la respuesta de fn_checkStock
		            var response = await fn_checkStock(idProduct, idVariant, idProveedor, productQuantity);
		            if (response) {
		                // Actualizo el total de esa fila:
		                fila.querySelector("#idTotalProductoCarrito").innerText = productQuantity * parseFloat(fila.querySelector("#idPriceCarrito").innerText);
		                
		                // Actualizo el subtotal:
		                subT += parseFloat(fila.querySelector("#idTotalProductoCarrito").innerText);
		                
		                // Faltaría actualizar la variable de sesión "productos" en el action
		                fn_updateCarrito(idProduct, productQuantity);
		            } else {
		                console.log("Stock insuficiente");
		            }
		        } catch (error) {
		            console.log("Ha ocurrido un error procesando la solicitud, por favor intentalo más tarde");
		        }
		    }
		   	
			document.getElementById('idSubTotal').innerHTML = subT.toFixed(2);
			document.getElementById('idTotalPagar').innerHTML = subT+5;
			location.reload();
	}else{
		console.log(" El cliente no esta situado en la ventana okeymastiendacarrito. ");
	}
}



/*function fn_addCarrito(idP,idV,idProveedor,quantity){
	//aquí ya hay q guardar en la sesión los productos de la cesta
	
	cantidad = 0; 
	//$(window).scrollTop(0);  // para volver al inicio de la página  
	if(idP == null && idV == null) {  
		cantidad += quantity; 
		var prodSelect = null; 
		prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 
		if(prodSelect != null){
			listCarrito.add(prodSelect[0]);   
			//session.setAttribute("listaCarrito",listCarrito);
			$('#idCesta').append("<div class='cart-entry clearfix' id="+ prodSelect[0].id +">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+prodSelect[0].nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+prodSelect[0].price+"</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
			//$('#idCestaProd').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+prodSelect[0].nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+prodSelect[0].price+"</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>     <td>      <div class='button-close'></div>     </td>    </tr>   </table>  </div> </div>");
			numProdCarrito += quantity;
			document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
			document.getElementById('idCircleCarrito').innerHTML = numProdCarrito;
			precioTotal += prodSelect[0].price;
			document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
			document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
			fn_saveCarrito();
		} 
	}else{ 
		var params = {};
		switch (idProveedor) {
		case '1': // JIMSPORT
		case 1: // JIMSPORT
			params["jim_id"] = idP;
			params["idVariant"] = idV;
			$.ajax({
				url : "/GestPlus/findVariantProduct",
				type : "POST",
				data : params,
				// myDataTable migth not exist
				success : function(data, textStatus) {
					var errorMessage = data.error;
					if (typeof (errorMessage) !== "undefined"
							&& errorMessage !== null && errorMessage !== '') {
						swal("", "Error: " + errorMessage, "warning");
					}else{
						listCarrito.add(data.variantProduct); 
						cantidad += quantity; 
						var t = cantidad * data.variantProduct.price;
						precioTotal += t;
						$('#idCesta').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src="+data.variantProduct.image+" alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+data.variantProduct.nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+data.variantProduct.price+"</div>      <div class='simple-article size-1'>TOTAL: "+t.toFixed(2)+"</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>   </tr>   </table>  </div> </div>");
						
						numProdCarrito += cantidad;
						document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
						document.getElementById('idCircleCarrito').innerHTML = numProdCarrito;
						document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
						document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
						fn_saveCarrito();
					}
				},
				dataType : "json"
			});
			break;
		case '2': // HYPERTROPHY
		case 2: // HYPERTROPHY
			params["idProduct"] = idP;
			params["idVariant"] = idV;
			$.ajax({
				url : "/GestPlus/findHyperVariantProduct",
				type : "POST",
				data : params,
				// myDataTable migth not exist
				success : function(data, textStatus) {
					var errorMessage = data.error;
					if (typeof (errorMessage) !== "undefined"
							&& errorMessage !== null && errorMessage !== '') {
						swal("", "Error: " + errorMessage, "warning");
					}else{
						cantidad += quantity; 
						listCarrito.add(data.variantProduct); 
						var t = cantidad * data.variantProduct.price;
						precioTotal += t;
						$('#idCesta').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src="+data.variantProduct.imageData+" alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+data.variantProduct.nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+data.variantProduct.price+"</div>      <div class='simple-article size-1'>TOTAL: "+t.toFixed(2)+"</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>   </tr>   </table>  </div> </div>");
						//$('#idCestaProd').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src="+data.variantProduct.imageData+" alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+data.variantProduct.nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+data.variantProduct.price+"</div>      <div class='simple-article size-1'>TOTAL: "+t+"</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>     <td>      <div class='button-close'></div>     </td>    </tr>   </table>  </div> </div>");
						numProdCarrito += cantidad;
						document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
						document.getElementById('idCircleCarrito').innerHTML = numProdCarrito;
						document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
						document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
						fn_saveCarrito();
					}
				},
				dataType : "json"
			});
			break;
			case '3': // NATURATAL
			case 3: // NATURATAL
				params["idProduct"] = idP;
				$.ajax({
					url : "/GestPlus/findNaturProductById",
					type : "POST",
					data : params,
					// myDataTable migth not exist
					success : function(data, textStatus) {
						var errorMessage = data.error;
						if (typeof (errorMessage) !== "undefined"
								&& errorMessage !== null && errorMessage !== '') {
							swal("", "Error: " + errorMessage, "warning");
						}else{
							cantidad += quantity; 
							listCarrito.add(data.infoProduct); 							
							var t = cantidad * data.infoProduct.price;
							precioTotal += t;
							$('#idCesta').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src="+data.infoProduct.image+" alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+data.infoProduct.nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+data.infoProduct.price+"</div>      <div class='simple-article size-1'>TOTAL: "+t.toFixed(2)+"</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>   </tr>   </table>  </div> </div>");
							numProdCarrito += cantidad;
							document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
							document.getElementById('idCircleCarrito').innerHTML = numProdCarrito;
							document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
							document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
							fn_saveCarrito();
						}
					},
					dataType : "json"
				});
				break;
		default:
			break;
		}
	}
}*/

function fn_getTotalProductsInCart(cartProducts){
	console.log("--------------- fn_getTotalProductsInCart()-----------------");
	 var totalProducts = 0;
	 console.log(cartProducts);
	 if( cartProducts ){
		 cartProducts.forEach((cartProduct) => {
			 totalProducts += parseInt(cartProduct.quantity);
		 });
	 }

	 return totalProducts;
}

function fn_getProductById(idP, idV, idProveedor){
	console.log("--------------- fn_getProductById()-----------------");
	 return new Promise((resolve, reject) => {
	        var params = {};
	        var actionURL = null;

	        switch(idProveedor) {
	            case '1': case 1:  /* JimSport */
	                params["jim_id"] = idP;
	                params["idVariant"] = idV;
	                actionURL = "findVariantProduct.json";
	                break;

	            case '2': case 2: /* HyperTrophy */
	                params["idProduct"] = idP;
	                params["idVariant"] = idV;
	                actionURL = "findHyperVariantProduct.json";
	                break;

	            case '3': case 3: /* Naturatal */
	                params["idProduct"] = idP;
	                actionURL = "findNaturProductById.json";
	                break;

	            default:
	                console.log("El producto seleccionado no pertenece a ningun proveedor - Pongase en contacto con el administrador de la web.");
	                break;
	        }

	        $.ajax({
	            url: "/GestPlus/" + actionURL + "",
	            type: "POST",
	            data: params,
	            success: function(data, textStatus) {
	                var errorMessage = data.error;
	                if (typeof (errorMessage) !== "undefined" && errorMessage !== null && errorMessage !== '') {
	                    swal("Error: " + errorMessage, "warning");
	                    reject(new Error(errorMessage));
	                } else {
	                	product = data.variantProduct;
	                    console.log(product);
	                    if (idProveedor == 3) { 
	                        product = data.infoProduct; 
	                        console.log("El producto es de naturatal" + data.infoProduct);
	                    }
	                    resolve(product);
	                }
	            },
	            dataType: "json"
	        });
		 
	 });
}

/*async function fn_addCarrito(idP, idV, idProveedor, quantity) {
    //TASK: aquí ya hay que guardar en la sesión los productos de la cesta
    listCarrito = [];
    cantidad = 0;
    quantity = parseInt(quantity);

    const cartProducts = await traerProdSesion();

    if (idP == null && idV == null) {  
        cantidad += quantity; 
        var prodSelect = null; 
        prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 

        if (prodSelect != null) {
            listCarrito.add(prodSelect[0]);
            $('#idCesta').append("<div class='cart-entry clearfix' id=" + prodSelect[0].id + ">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>" + prodSelect[0].nameEs + "</a></div>      <div class='simple-article size-1'>CANTIDAD: " + cantidad + "</div>     </td>     <td>      <div class='simple-article size-3 grey'>" + prodSelect[0].price + "</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
            numProdCarrito += quantity;
            document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
            precioTotal += prodSelect[0].price;
            document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
            document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
            fn_saveCarrito();
        }
    } else { 
        try{
      	  var product = await fn_getProductById(idP, idV, idProveedor);
            
            if( product ) {
                var productSession = null;
                cantidad += quantity;
     

                if (cartProducts) {
                    cartProducts.forEach(function(e) { 
                        console.log("Elemento de cartProducts: " + e.nameEs + ", idProveedor = " + e.idProveedor + ", idProducto = " + e.product_id + ", variante = " + e.variant_id);
                    });
                    productSession = cartProducts.find((p) => (p.idProveedor == idProveedor && p.product_id == idP && p.variant_id == idV));
                }

                if (productSession == null) {
                    console.log("El producto no existe, añadimos con cantidad 1, y el valor de isNewProduct = " + productSession);
                    product.quantity = quantity;
                } else {
                    product.quantity = (parseInt(productSession.quantity) + cantidad);
                    console.log("Producto " + product.nameEs + ", cantidad: " + product.quantity + "stock: " + product.stock);
                }
                
                if (document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito')) document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito').innerHTML = totalPorProducto;
                if (document.getElementById('idStockProd')) document.getElementById('idStockProd').innerHTML = product.stock;
                if (document.getElementById('cantidadCarrito')) document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
                if (document.getElementById('idTotal')) document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
                if (document.getElementById('totalConIva')) document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;

                fn_saveCarrito();
            } else {
                swal("No hay Stock del producto. ");
            }
            
      }catch(error) {
    	  	console.log("Ha ocurrido un error durante la solicitud: " + error);
  			alert("No se ha podido procesar la solicitud, intentelo más tarde");
      }
    }
}*/

async function fn_addCarrito(idP, idV, idProveedor, quantity) {
	console.log("--------------- fn_addCarrito()-----------------");
    //TASK: aquí ya hay que guardar en la sesión los productos de la cesta
    listCarrito = [];
    cantidad = 0;
    quantity = parseInt(quantity);

    const cartProducts = await traerProdSesion();

    if (idP == null && idV == null) {  
        cantidad += quantity; 
        var prodSelect = null; 
        prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 

        if (prodSelect != null) {
            listCarrito.add(prodSelect[0]);
            $('#idCesta').append("<div class='cart-entry clearfix' id=" + prodSelect[0].id + ">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>" + prodSelect[0].nameEs + "</a></div>      <div class='simple-article size-1'>CANTIDAD: " + cantidad + "</div>     </td>     <td>      <div class='simple-article size-3 grey'>" + prodSelect[0].price + "</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
            numProdCarrito += quantity;
            document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
            precioTotal += prodSelect[0].price;
            document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
            document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
            fn_saveCarrito();
        }
    } else { 
        try{
      	  var product = await fn_getProductById(idP, idV, idProveedor);
            
            if( product ) {
                var productSession = null;
                cantidad += quantity;
     

                if (cartProducts) {
                    cartProducts.forEach(function(e) { 
                        console.log("Elemento de cartProducts: " + e.nameEs + ", idProveedor = " + e.idProveedor + ", idProducto = " + e.product_id + ", variante = " + e.variant_id);
                    });
                    productSession = cartProducts.find((p) => (p.idProveedor == idProveedor && p.product_id == idP && p.variant_id == idV));
                }

                if (productSession == null) {
                    console.log("El producto no existe, añadimos con cantidad 1, y el valor de isNewProduct = " + productSession);
                    product.quantity = quantity;
                } else {
                    product.quantity = (parseInt(productSession.quantity) + cantidad);
                    console.log("Producto " + product.nameEs + ", cantidad: " + product.quantity + "stock: " + product.stock);
                }
                
                var  response = await fn_checkStock(idP, idV, idProveedor, parseInt(product.quantity));
                if( response === true ) {
                	product.stock = parseInt(product.stock) - parseInt(product.quantity);
                    listCarrito.add(product);

                    precioTotal += product.price;
                    var totalPorProducto = product.quantity * product.price;

                    if ($('#idCesta').find('#' + idP + idV + idProveedor).length) {
                        $('#idCesta').find('#' + idP + idV + idProveedor).remove();
                    }

                    $('#idCesta').append(
                        "<div id=\"" + idP + idV + idProveedor + "\" class='cart-entry clearfix'>"
                        + " <a style='width: 15%;' class='cart-entry-thumbnail' href='#'>"
                        + "<img src='" + product.imageData + "' alt='' />"
                        + "</a>"
                        + " <div class='cart-entry-description'>"
                        + "   <table>"
                        + "     <tr>"
                        + "       <td>"
                        + "         <div class='h6'>"
                        + "           <a href='#'>" + product.nameEs + "</a>"
                        + "         </div>"
                        + "         <div class='simple-article size-1'>CANTIDAD: <div id='" + idP + idV + idProveedor + "'>" + product.quantity + "</div></div>"
                        + "       </td>"
                        + "       <td>"
                        + "         <div class='simple-article size-3 grey'>" + product.price + "</div>"
                        + "         <div class='simple-article size-1'>TOTAL: " + totalPorProducto + "</div>"
                        + "       </td>"
                        + "       <td>"
                        + "         <div class='cart-color' style='background: #facc22;'></div>"
                        + "       </td>"
                        + "       <td>"
                        + "        </div>"
                        + "       </td>"
                        + "     </tr>"
                        + "   </table>"
                        + " </div>"
                        + "</div>"
                    );

                    if( productSession ) { 
                    	numProdCarrito = fn_getTotalProductsInCart( cartProducts ) + quantity;
                    }else{
                    	numProdCarrito += cantidad;
                    }
                    
                    if (document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito')) document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito').innerHTML = totalPorProducto;
                    if (document.getElementById('idStockProd')) document.getElementById('idStockProd').innerHTML = product.stock;
                    if (document.getElementById('cantidadCarrito')) document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
                    if (document.getElementById('idTotal')) document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
                    if (document.getElementById('totalConIva')) document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
					
                    fn_saveCarrito();
                } else {
                    swal("No hay Stock del producto. ");
                }
                fn_actualizarCarrito();
            }
            
      }catch(error) {
    	  	console.log("Ha ocurrido un error durante la solicitud: " + error);
  			swal("No se ha podido procesar la solicitud, intentelo más tarde");
      }
    }
}

/*async function fn_removeCarrito(idP, idV, idProveedor, quantity) {
	    //TASK: aquí ya hay que guardar en la sesión los productos de la cesta
	    listCarrito = [];
	    cantidad = 0;
	    quantity = parseInt(quantity);
	    const cartProducts = await traerProdSesion();

	    if (idP == null && idV == null) {  
	        cantidad += quantity; 
	        var prodSelect = null; 
	        prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 

	        if (prodSelect != null) {
	            listCarrito.add(prodSelect[0]);
	            $('#idCesta').append("<div class='cart-entry clearfix' id=" + prodSelect[0].id + ">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>" + prodSelect[0].nameEs + "</a></div>      <div class='simple-article size-1'>CANTIDAD: " + cantidad + "</div>     </td>     <td>      <div class='simple-article size-3 grey'>" + prodSelect[0].price + "</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
	            numProdCarrito += quantity;
	            document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
	            precioTotal += prodSelect[0].price;
	            document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
	            document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
	            fn_saveCarrito();
	        }
	    } else { 
	        var product = await fn_getProductById(idP, idV, idProveedor);
	        
	        if( product ) {
	            var productSession = null;
	            cantidad += quantity;
	            console.log(product);

	            if (cartProducts) {
	                cartProducts.forEach(function(e) { 
	                    console.log("Elemento de cartProducts: " + e.nameEs + ", idProveedor = " + e.idProveedor + ", idProducto = " + e.product_id + ", variante = " + e.variant_id);
	                });
	                productSession = cartProducts.find((p) => (p.idProveedor == idProveedor && p.product_id == idP && p.variant_id == idV));
	            }

	            if (productSession) {
	                product.quantity = (parseInt(productSession.quantity) - cantidad);
	                console.log("Producto " + product.nameEs + ", cantidad: " + product.quantity + "stock: " + product.stock);
	            }
	            product.stock = parseInt(product.stock) + cantidad;
	            
	            if( product.stock > 0 ) {
	                listCarrito.add(product);

	                precioTotal -= product.price;
	                var totalPorProducto = product.quantity * product.price;

	                if ($('#idCesta').find('#' + idP + idV + idProveedor).length) {
	                    $('#idCesta').find('#' + idP + idV + idProveedor).remove();
	                }

	                $('#idCesta').append(
	                    "<div id=\"" + idP + idV + + idProveedor + "\" class='cart-entry clearfix'>"
	                    + " <a style='width: 15%;' class='cart-entry-thumbnail' href='#'>"
	                    + "<img src='" + product.imageData + "' alt='' />"
	                    + "</a>"
	                    + " <div class='cart-entry-description'>"
	                    + "   <table>"
	                    + "     <tr>"
	                    + "       <td>"
	                    + "         <div class='h6'>"
	                    + "           <a href='#'>" + product.nameEs + "</a>"
	                    + "         </div>"
	                    + "         <div class='simple-article size-1'>CANTIDAD: <div id='" + idP + idV + idProveedor + "'>" + product.quantity + "</div></div>"
	                    + "       </td>"
	                    + "       <td>"
	                    + "         <div class='simple-article size-3 grey'>" + product.price + "</div>"
	                    + "         <div class='simple-article size-1'>TOTAL: " + totalPorProducto + "</div>"
	                    + "       </td>"
	                    + "       <td>"
	                    + "         <div class='cart-color' style='background: #facc22;'></div>"
	                    + "       </td>"
	                    + "       <td>"
	                    + "         <div class='button-close'></div>"
	                    + "       </td>"
	                    + "     </tr>"
	                    + "   </table>"
	                    + " </div>"
	                    + "</div>"
	                );

	               if( productSession ) { 
                	numProdCarrito = fn_getTotalProductsInCart( cartProducts ) - quantity;
                }else{
                	numProdCarrito += cantidad;
                }
	              
	             	if (document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito')) document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito').innerHTML = totalPorProducto;
	                if (document.getElementById('idStockProd')) document.getElementById('idStockProd').innerHTML = product.stock;
	                if (document.getElementById('cantidadCarrito')) document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
	                if (document.getElementById('idTotal')) document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
	                if (document.getElementById('totalConIva')) document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;

	                fn_saveCarrito();
	            } else {
	                swal("No hay Stock del producto. ");
	            }
	        }
	    }
}*/

async function fn_removeCarrito(idP, idV, idProveedor, quantity) {
	console.log("--------------- fn_removeCarrito()-----------------");
	    //TASK: aquí ya hay que guardar en la sesión los productos de la cesta
	    listCarrito = [];
	    cantidad = 0;
	    quantity = parseInt(quantity);
	    const cartProducts = await traerProdSesion();

	    if (idP == null && idV == null) {  
	        cantidad += quantity; 
	        var prodSelect = null; 
	        prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 

	        if (prodSelect != null) {
	            listCarrito.add(prodSelect[0]);
	            $('#idCesta').append("<div class='cart-entry clearfix' id=" + prodSelect[0].id + ">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>" + prodSelect[0].nameEs + "</a></div>      <div class='simple-article size-1'>CANTIDAD: " + cantidad + "</div>     </td>     <td>      <div class='simple-article size-3 grey'>" + prodSelect[0].price + "</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
	            numProdCarrito += quantity;
	            document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
	            precioTotal += prodSelect[0].price;
	            document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
	            document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
	            fn_saveCarrito();
	        }
	    } else {
	    	try{
	    		 var product = await fn_getProductById(idP, idV, idProveedor);
	 	        
	 	        if( product ) {
	 	            var productSession = null;
	 	            cantidad += quantity;
	 	            console.log(product);

	 	            if (cartProducts) {
	 	                cartProducts.forEach(function(e) { 
	 	                    console.log("Elemento de cartProducts: " + e.nameEs + ", idProveedor = " + e.idProveedor + ", idProducto = " + e.product_id + ", variante = " + e.variant_id);
	 	                });
	 	                productSession = cartProducts.find((p) => (p.idProveedor == idProveedor && p.product_id == idP && p.variant_id == idV));
	 	            }
					
	 	            if (productSession) {
	 	            	if(productSession.quantity > 1) {
	 	            		product.quantity = (parseInt(productSession.quantity) - cantidad);
		 	               	product.stock = parseInt(product.stock) + cantidad;

		 	                listCarrito.add(product);

		 	                precioTotal -= product.price;
		 	                var totalPorProducto = product.quantity * product.price;

		 	                if ($('#idCesta').find('#' + idP + idV + idProveedor).length) {
		 	                    $('#idCesta').find('#' + idP + idV + idProveedor).remove();
		 	                }

		 	                $('#idCesta').append(
		 	                    "<div id=\"" + idP + idV + + idProveedor + "\" class='cart-entry clearfix'>"
		 	                    + " <a style='width: 15%;' class='cart-entry-thumbnail' href='#'>"
		 	                    + "<img src='" + product.imageData + "' alt='' />"
		 	                    + "</a>"
		 	                    + " <div class='cart-entry-description'>"
		 	                    + "   <table>"
		 	                    + "     <tr>"
		 	                    + "       <td>"
		 	                    + "         <div class='h6'>"
		 	                    + "           <a href='#'>" + product.nameEs + "</a>"
		 	                    + "         </div>"
		 	                    + "         <div class='simple-article size-1'>CANTIDAD: <div id='" + idP + idV + idProveedor + "'>" + product.quantity + "</div></div>"
		 	                    + "       </td>"
		 	                    + "       <td>"
		 	                    + "         <div class='simple-article size-3 grey'>" + product.price + "</div>"
		 	                    + "         <div class='simple-article size-1'>TOTAL: " + totalPorProducto + "</div>"
		 	                    + "       </td>"
		 	                    + "       <td>"
		 	                    + "         <div class='cart-color' style='background: #facc22;'></div>"
		 	                    + "       </td>"
		 	                    + "       <td>"
		 	                    + "         </div>"
		 	                    + "       </td>"
		 	                    + "     </tr>"
		 	                    + "   </table>"
		 	                    + " </div>"
		 	                    + "</div>"
		 	                );

		 	               	if( productSession ) { 
		                 		numProdCarrito = fn_getTotalProductsInCart( cartProducts ) - quantity;
		                 	}else{
		                 		numProdCarrito += cantidad;
		                 	}
		 	              
		 	             	if (document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito')) document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito').innerHTML = totalPorProducto;
		 	                if (document.getElementById('idStockProd')) document.getElementById('idStockProd').innerHTML = product.stock;
		 	                if (document.getElementById('cantidadCarrito')) document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
		 	                if (document.getElementById('idTotal')) document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
		 	                if (document.getElementById('totalConIva')) document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;

		 	                fn_saveCarrito();
	 	            	}else{
	 	            		removeProducto(idP);
	 	            	}
	 	            	fn_actualizarCarrito();
	 	            }
	 	        }
	    	}catch{
	    		console.log("Ha ocurrido un error durante la solicitud: " + error);
	  			swal("No se ha podido procesar la solicitud, intentelo más tarde");
	    	} 
	    }
}

/****************************MIS PEDIDOS ****************************************/

function fn_misPedidos(){
	var params = {};
	params["idCliente"] = idCli;
	$.ajax({
		url : "/GestPlus/misPedidos",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal("Se ha producido un error: " + errorMessage);
			} else {
				data.misPedidos.forEach(item => {
					var fila = document.createElement("tr");
					
					var celdaId = document.createElement("td");
					celdaId.textContent = item.id;
					fila.appendChild(celdaId);

					var celdaProd = document.createElement("td");
					celdaProd.textContent = item.producto;
					fila.appendChild(celdaProd);

					var celdaRef = document.createElement("td");
					celdaRef.textContent = item.reference;
					fila.appendChild(celdaRef);

					var celdaFecha = document.createElement("td");
					celdaFecha.textContent = item.fechaCompra;
					fila.appendChild(celdaFecha);
					
					var celdaDev = document.createElement("td");
					if(item.devuelto){
						var celdaLabel = document.createElement("label");
						celdaLabel.textContent = 'Devuelto';
						celdaDev.appendChild(celdaLabel);
					}else{
						var celdaButton = document.createElement("button");
						celdaButton.textContent = 'Devolver';
						//celdaButton.classList.add(fn_devolver(item.id,item.producto));
						celdaButton.addEventListener("click", function() {
				            fn_devolver(item.id,item.producto); 
        				});
						celdaDev.appendChild(celdaButton); 
					}
					
					fila.appendChild(celdaDev);
					
					tablePedidos.appendChild(fila); 
				});
			}
		},
		dataType : "json" 
	});
}

function fn_devolver(idProdDev, nombreProducto){
	idProductoDevolver = idProdDev;
	idNombreProdDev.value = nombreProducto;
	document.getElementById('idDivMotivoDevol').style.display='block';
}

function fn_sendDevolucion(){ // le llega un correo a Pedro y él gestiona la devolución con el proveedor que corresponda
	var params = {};
	params["idProductoPedido"] = idProductoDevolver;
	params["idCliente"] = idCli;
	params["idMotivo"] = idM.value;
	params["observaciones"] = idObservaciones.value;
	
	$.ajax({
		url : "/GestPlus/sendDevolucion",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal("Se ha producido un error: " + errorMessage);
			} else {
				 swal("Producto devuelto con éxito.");
				 window.location.href= "okeymasTiendaMisPedidos.html";
			}
		},
		dataType : "json"
	});
}

function fn_showhidePolitica(){
	if(document.getElementById('politicaDevol').style.display == 'block'){
		document.getElementById('politicaDevol').style.display='none';
	}else{
		document.getElementById('politicaDevol').style.display='block';
	}
}

/***************************TODOS LOS PRODUCTOS****************************/

function traerProductosByProv(idProveedor){ 
	console.log("traerProductosByProv");
	document.getElementById("loader").classList.remove("hidden"); //mostrar el cargando
	switch (idProveedor) { 
	case 1: // JIM
	case '1': // JIM
		document.getElementById('idProvSelecAllProd').innerHTML = "MATERIAL DEPORTIVO";
		document.getElementById('idMenuProvSelec').innerHTML = "MATERIAL DEPORTIVO";
		if(allProductsJim == undefined){
			var allProductsJimPromise = $.getJSON("/GestPlus/findAllProducts", function(json) {
		        allProductsJim = json.listProductos;
		        
		        mostrar(0,xPag,idProveedor);
			    nPag = Math.ceil(allProductsJim.length / xPag);
			    $("#botones").empty();
			    mostrarPaginacion(nPag,allProductsJim,idProveedor); 
		    });
		}else{
	        mostrar(0,xPag,idProveedor);
		    nPag = Math.ceil(allProductsJim.length / xPag);
		    $("#botones").empty();
		    mostrarPaginacion(nPag,allProductsJim,idProveedor); 
		}
		break;
	case 2: // HYPER
	case '2':
		document.getElementById('idProvSelecAllProd').innerHTML = "SUPLEMENTACIÓN DEPORTIVA"; 
		document.getElementById('idMenuProvSelec').innerHTML = "SUPLEMENTACIÓN DEPORTIVA";
		if(allProductsHyper == undefined){
			var allProductsHyperPromise = $.getJSON("/GestPlus/findAllHyperProducts", function(json) {
				allProductsHyper = json.listProductos;
		        mostrar(0,xPag,idProveedor);
			    nPag = Math.ceil(allProductsHyper.length / xPag);
			    $("#botones").empty();
			    mostrarPaginacion(nPag,allProductsHyper,idProveedor); 
		    });
		}else{
			 mostrar(0, xPag, idProveedor);
             nPag = Math.ceil(allProductsHyper.length / xPag);
             $("#botones").empty();
             mostrarPaginacion(nPag, allProductsHyper, idProveedor);
		}
        break;
	     
	case 3: // NATUR 
	case '3':
		document.getElementById('idProvSelecAllProd').innerHTML = "PRODUCTOS NATURALES";
		document.getElementById('idMenuProvSelec').innerHTML = "PRODUCTOS NATURALES";
		
		if(allProductsNatur == undefined){
			var allProductsNaturPromise = $.getJSON("/GestPlus/findAllNaturProducts", function(json) {
		        allProductsNatur = json.listProductos;
		        mostrar(0,xPag,idProveedor);
			    nPag = Math.ceil(allProductsNatur.length / xPag);
			    $("#botones").empty();
			    mostrarPaginacion(nPag,allProductsNatur,idProveedor); 
		    });
		}else{ // para no volver a llamar al action
			mostrar(0,xPag,idProveedor);
		    nPag = Math.ceil(allProductsNatur.length / xPag);
		    $("#botones").empty();
		    mostrarPaginacion(nPag,allProductsNatur,idProveedor); 
		}
		break;
	default:
		break;
	} 
	
	$.when(allProductsJimPromise, allProductsHyperPromise, allProductsNaturPromise).done(function() {
		document.getElementById("loader").classList.add("hidden"); //para quitar el cargando
    });
}


/*function mostrarPaginacion(t,prods,idProveedor){
    var botones = '';
    for(var i = 0; i < t; i++){
        var cada = '';
        cada = "<a class='pagination'>"+(i+1)+"</a>";
        botones += cada; 
    }
    $('#botones').append(botones);
 	  // Poner oyentes a cada botón
    var losBotones = document.querySelectorAll('#botones a');
    for(var i = 0; i < losBotones.length; i++){
        losBotones[i].addEventListener('click',function(){
       	 	quitarActivo(); 
            var indice = parseInt(this.textContent);
            var o = (indice -1) * xPag;
            var h = indice * xPag;
            mostrar(o,h,idProveedor);
            mostrarPaginacion(t,prods,idProveedor);
            $(this).addClass('active');  //para que el botón se vea resaltado
            //$(window).scrollTop(0);  // para volver al inicio de la página  
        });
    } 
}*/

function mostrarPaginacion(t,prods,idProveedor){
	console.log("Se esta llamando a mostrar Paginacion");
	mostrarBotones(t, prods, idProveedor);
	
	/*var botones = '';
    for(var i = 0; i < t; i++){
        var cada = '';
        cada = "<a class='pagination'>"+(i+1)+"</a>";
        botones += cada; 
    }
    $('#botones').append(botones);
 	  // Poner oyentes a cada botón
    var losBotones = document.querySelectorAll('#botones a');
    for(var i = 0; i < losBotones.length; i++){
        losBotones[i].addEventListener('click',function(){
       	 	quitarActivo(); 
            var indice = parseInt(this.textContent);
            var o = (indice -1) * xPag;
            var h = indice * xPag;
            mostrar(o,h,idProveedor);
            mostrarPaginacion(t,prods,idProveedor);
            $(this).addClass('active');  //para que el botón se vea resaltado
            //$(window).scrollTop(0);  // para volver al inicio de la página  
        });
    } */
}

function mostrar(desde,hasta,idProveedor){ // cuando filtramos por proveedor en la pantalla de allProducts
	listFilter = new Array();
	switch (idProveedor) {
	case 1:
	case '1':
		listFilter = allProductsJim;
		totales = listFilter.length;
		break;
	case 2:
	case '2':
		listFilter = allProductsHyper;
		totales = listFilter.length;
		break;
	case 3:
	case '3': 
		listFilter = allProductsNatur;
		totales = listFilter.length;
		break;
	default:
		break;
	}
		
	$("#idContentAllProducts").empty();
	
	var h = hasta;
	if(hasta>totales){
		h=totales;
	}   
	
    
    for(var i = desde; i < h; i++){    
		if(listFilter[i].idProveedor == 1){ // si es Jimsport la imagen no está en base64

			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=1'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",1)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span> <span class='glyphicon glyphicon-euro color'></span></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].descripcion+"</div>   </div> </div> </div>");			
		}else if(listFilter[i].idProveedor == 2){ // si es Hypertrophy la imagen SI está en base64
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+listFilter[i].idProduct+"&idProveedor=2'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",2)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span> <span class='glyphicon glyphicon-euro color'></span></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].nameEs+"</div>   </div> </div> </div>");
		}else if(listFilter[i].idProveedor == 3){ // si es Naturatal
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+listFilter[i].idProduct+"&idProveedor=3'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",3)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span> <span class='glyphicon glyphicon-euro color'></span></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].descripcion+"</div>   </div> </div> </div>");

		}
    }
}

/***************************CARGAR PRODUCTOS****************************/

//para los productos de Hypertrophy
/*var fetchCompressedJson = async function () {
    try {
        // Solicitar los datos
        const response = await fetch('findAllHyperProducts');

        // Leer directamente el JSON sin descomprimir
        const jsonData = await response.json();
        
        return jsonData; // Devolver los datos
    } catch (error) {
        console.error("Error al obtener el JSON:", error);
        return null; // Manejo del error
    }
};*/


function traerProductos(pagina, filtro){ 
	console.log("traerProductos");
	console.log("1: " + new Date());
	console.log("FILTRO:  " + filtro);
	document.getElementById("loader").classList.remove("hidden");//mostrar el cargando
	//window.addEventListener("load", function() {
		// Llamadas AJAX con promesas 
	    var allProductsJimPromise = $.getJSON("/GestPlus/findAllProducts", function(json) {
	        allProductsJim = json.listProductos;
	        //document.getElementById('idCargarJim').click(); // aquí no porque sino no funciona la página de allProducts
	    }); 
	
	    var allProductsNaturPromise = $.getJSON("/GestPlus/findAllNaturProducts", function(json) {
	        allProductsNatur = json.listProductos;
	    });
	    
	    var allProductsHyperPromise = $.getJSON("/GestPlus/findAllHyperProducts", function(json) {
	    	allProductsHyper = json.listProductos;
	    });  
	
	    
	    // Llamada a la función y asignación del resultado
	   //var allProductsHyperPromise = (async () => { allProductsHyper = await fetchCompressedJson();   })();
	    
	    /*var allProductsHyperPromise = $.Deferred(function(defer) {
            fetchCompressedJson().then(function(data) {
                allProductsHyper = data;
                defer.resolve(); // Resolver la promesa Deferred
            }).catch(function(error) {
                defer.reject();
            });
        }).promise();*/   
	
	    // Usar $.when para asegurarte de que todas las llamadas AJAX terminen antes de ejecutar mostrarListaTodos  
	    $.when(allProductsJimPromise, allProductsHyperPromise, allProductsNaturPromise).done(function() {
	        //mostrarListaTodos();  // Se ejecuta solo después de que todas las llamadas AJAX hayan finalizado  
	        console.log("2: " + new Date());  
		    mostrarListaTodos(0,xPag);
		    allProducts = allProductsJim.concat(allProductsHyper).concat(allProductsNatur);	//concateno las listas de todos los proveedores 
		    nPag = Math.ceil(allProducts.length / xPag);
		    mostrarBotones(nPag,allProducts); 
		    document.getElementById("loader").classList.add("hidden"); 
		    
		    if(pagina==0){
		    	document.getElementById('idCargarJim').click();
		    } 
		    if(filtro != null && filtro != '' ){
		    	busqueda(filtro);
		    }
	    });
	//});  
}

function cargarAllProductos(pagina, filtro){ 
	    var allProductsJimPromise = $.getJSON("/GestPlus/findAllProducts", function(json) {
	        allProductsJim = json.listProductos;
	    }); 
	
	    var allProductsNaturPromise = $.getJSON("/GestPlus/findAllNaturProducts", function(json) {
	        allProductsNatur = json.listProductos;
	    });
	    
	    var allProductsHyperPromise = $.getJSON("/GestPlus/findAllHyperProducts", function(json) {
	    	allProductsHyper = json.listProductos;
	    });  
		 return $.when(allProductsJimPromise, allProductsHyperPromise, allProductsNaturPromise).done(function() {
	      
		    allProducts = allProductsJim.concat(allProductsHyper).concat(allProductsNatur);	//concateno las listas de todos los proveedores 
		    
	    }); 
}


function cargarProductosByProv(idProveedor){ // no se puede usar este en allProducts porque no existen los elementos idCargarJim, idCargarHyper...
	switch (idProveedor) { 
	case 0: // todos los proveedores
		break;
	case 1: // JIM
		listFilter = allProductsJim;	
		document.getElementById('idCargarJim').click(); //para habilitar esa parte y sea visible
	break;
	case 2: // HYPER
		listFilter = allProductsHyper;	
		document.getElementById('idCargarHyper').click();
	break;
	case 3: // NATUR
		listFilter = allProductsNatur;	
		document.getElementById('idCargarNatur').click();
	break;
	default:
		break;
	}
	totales = listFilter.length;  
    nPag = Math.ceil(totales / xPag);
    offset = (pag - 1) * xPag;
    hasta = pag * xPag;
	mostrarLista(0,hasta, listFilter,totales);
	
}

/********************************************BÚSQUEDA********************************************/

function busqueda(filter){ //debe buscar en todos los proveedores 
	
	
	if(filter == null) filter = "Buscar...";
	if(txtFilterBase.value == ''){
		txtFilterBase.value = filter;
	}
	//console.log("buscar: " + txtFilterBase.value + ", filter value: " + filter);
	
	// Lee la frase del input
     var input = document.getElementById("txtFilterBase").value;
     
     // Separa la frase en palabras (elimina espacios adicionales)
     var words = input.split(/\s+/).filter(Boolean);
     console.log("Array de palabras:", words);
     
     
	
	//comprobar que las variables globales de los productos no sean null
	//porq hay pantallas donde esas variable están vacías
	
	if(allProductsJim == null || allProductsHyper == null || allProductsNatur == null){
		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProductos?filter="+txtFilterBase.value;
		return;
	}
	
	allProducts = allProductsJim.concat(allProductsHyper).concat(allProductsNatur);	//concateno las listas de todos los proveedores 
	
	//listFilter = allProducts; 
	listFilter = []; 
	try{
		//if(txtFilterBase.value != "Buscar...") 
			
		words.forEach(function(word) {
			//listFilter = allProducts.filter((p) => (p.nameEs.includes(word) ||  p.nameEs.includes(word.toUpperCase()) ||  p.reference.includes(word) ||  p.reference.includes(word.toUpperCase()) || p.descripcion.includes(word) || p.descripcion.includes(word.toUpperCase()) )  );
			
			listFilter = listFilter.concat(allProducts.filter((p) => (
			  p.nameEs.includes(word) ||
			  p.nameEs.includes(word.toUpperCase()) ||
			  p.reference.includes(word) ||
			  p.reference.includes(word.toUpperCase()) ||
			  p.descripcion.includes(word) ||
			  p.descripcion.includes(word.toUpperCase())
			)));
		});
	}catch (e) {
		console.log(e);  
	}
	
	
	$("#contentFilterSearch").empty();
	$("#idContentAllProducts").empty(); 
	
	console.log("Tamaño de la lista de productos: " + listFilter.length);
	if(listFilter.length > 0){
		mostrarResultadoBusqueda(0,pag * xPag, listFilter,listFilter.length);  
		nPag = Math.ceil(listFilter.length / xPag);
	    offset = (pag - 1) * xPag;
	    hasta = pag * xPag;
		
	    mostrarBotones(nPag,listFilter, null);
	}
	
	if(document.getElementById('resultSearch') != null){
		document.getElementById('resultSearch').click();
	}
	
}

function normalizeText(text) {
    return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}

/**
 * Realiza una búsqueda de productos basada en palabras clave ingresadas por el usuario.
 * Aplica un sistema de ponderación para priorizar los resultados más relevantes.
 * 
 * Funcionalidad:
 * - Extrae palabras clave de la consulta eliminando palabras vacías (stopwords).
 * - Normaliza los textos para hacer comparaciones más precisas.
 * - Asigna diferentes pesos a las coincidencias en distintos campos (nombre, categoría, referencia y descripción).
 * - Aplica bonificaciones si todas las palabras clave están en el nombre o si hay coincidencias en la categoría.
 * - Ordena los resultados según el puntaje de relevancia y los muestra en la interfaz.
 * - Si no hay productos cargados en memoria, redirige a otra página para ejecutar la búsqueda allí.
 * 
 * @function busqueda
 * @returns {void}
 */
 
 
/*function busqueda() { 
    document.getElementById("loader").classList.remove("hidden");

    if (txtFilterBase.value == '') return;

    if (allProductsJim == null || allProductsHyper == null || allProductsNatur == null) {
        window.location.href = "https://gestplus.okmas.net/GestPlus/okeymasTiendaProductos?filter=" + txtFilterBase.value;
        return;
    }
    
    function extractKeywords(text) {
        const stopwords = new Set(["de", "la", "los", "el", "las", "y", "a", "en", "con", "por", "para", "del", "un", "una", "unos", "unas", "al"]);
        
        return text
            .split(/\s+/) // Dividir por espacios
            .filter(word => !stopwords.has(word)) // Filtrar palabras vacías
            .join(" "); // Volver a unir en una string limpia
    }
    var cleanedQuery = extractKeywords(normalizeText(txtFilterBase.value));
    console.log("keywords: " + cleanedQuery);

    var words = normalizeText(cleanedQuery).split(" "); // Separar palabras clave
    console.log(words);

    listFilter = allProducts
      .map((p) => {
        // Normalizar los textos de cada campo
        var nameText = normalizeText(p.nameEs);
        var categText = normalizeText(p.categ);
        var referenceText = normalizeText(p.reference);
        var descriptionText = normalizeText(p.descripcion);
        
        if(categText == "balones") categText = "balon";

        // Ajustamos los pesos de los campos
        var weights = {
          name: 5,        
          category: 2,    
          reference: 1.5, 
          description: 0.5 
        };

        // Asignar pesos decrecientes a las palabras según su posición
        var wordWeights = words.map((_, index) => {
          if (index === 0) return 2.0; 
          if (index === 1) return 1.5; 
          return 1.0; 
        });

        // Función para contar coincidencias exactas y aplicar ponderación
        var countMatches = (text, fieldWeight, wordWeight = 1.0) => {
          return words.reduce((total, word, index) => {
            var regex = new RegExp("\\b" + word + "\\b", "gi"); // Búsqueda exacta con regex
            var matches = text.match(regex);
            return total + (matches ? matches.length * fieldWeight * wordWeights[index] : 0);
          }, 0);
        };

        // Calcular el puntaje total ponderado
        var matchCount =
          countMatches(nameText, weights.name) +
          countMatches(categText, weights.category) +
          countMatches(referenceText, weights.reference) +
          countMatches(descriptionText, weights.description);

        //  Si todas las palabras están en el nombre, el producto se prioriza FUERTE
        if (words.every(word => nameText.includes(word))) {
          matchCount *= 2.0; 
        }

        //  Si todas las palabras están en el nombre Y la categoría es relevante, subimos un poco más
        if (words.every(word => nameText.includes(word)) && words.some(word => categText.includes(word))) {
          matchCount *= 1.3; 
        }

        // Si al menos una palabra está en la categoría, le damos un mini-bono
        if (words.some(word => categText.includes(word))) {
          matchCount *= 1.1; 
        }

        if (matchCount > 0)
          console.log("Para el producto " + p.nameEs + ", existen " + matchCount + " coincidencias ponderadas");

        return { product: p, matchCount };
      })
      .filter((item) => item.matchCount > 0) // Filtrar productos con al menos 1 coincidencia
      .sort((a, b) => b.matchCount - a.matchCount) // Ordenar de mayor a menor coincidencia
      .map((item) => item.product); // Extraer los productos


    $("#contentFilterSearch").empty();
    $("#idContentAllProducts").empty(); 

    if (listFilter.length > 0) {
        mostrarResultadoBusqueda(0, pag * xPag, listFilter, listFilter.length);  
        nPag = Math.ceil(listFilter.length / xPag);
        mostrarBotones(nPag, listFilter, null);
    }

    if (document.getElementById('resultSearch') != null) {
        document.getElementById('resultSearch').click();
    }

    document.getElementById("loader").classList.add("hidden");
}*/



 /**
  * Realiza una búsqueda de productos filtrando por una categoría específica.
  * 
  * Funcionalidad:
  * - Asigna el nombre de la categoría al campo de búsqueda (`txtFilterBase`).
  * - Llama a la función `busqueda()` para ejecutar la búsqueda con el nuevo filtro.
  * 
  * @function fn_busquedaCategoria
  * @param {string} productName - Nombre de la categoría a buscar.
  * @returns {void}
  */
function fn_busquedaCategoria(productName) {
	if(normalizeText(productName).trim().toLowerCase() === 'catalogo general') window.location.href = "okeymasTiendaProductos.html";
	
	txtFilterBase.value = productName;
	busqueda();
}


/******************************* INFO DE UNA VARIANTE EN CONCRETO *********************************/

function fn_mostrarVariante(){
	console.log(idListAtrib1.value);
	console.log(idListAtrib2.value);
	//cambiar el precio, la referencia, el stock y la imagen
	
	var params = {};
	params["atributo1"]   = idListAtrib1.value;
	params["atributo2"]   = idListAtrib2.value;
	params["idProveedor"] = elProv;
	params["idProduct"]   = idProducto;
	
	$.ajax({
		url : "/GestPlus/filterByAtributos",
		type : "POST",
		data : params,
		// myDataTable migth not exist  
		success : function(data, textStatus) {
			// Selecciona el elemento por su id
			var imagenProdDiv = document.getElementById("idImagenProd");

			switch (elProv) {
			case '1':
				if(data.productoJim != null){
					// Asigna una nueva URL de imagen
					//const nuevaImagenURL = data.productoJim.imageData;
					//imagenProdDiv.setAttribute("data-background", nuevaImagenURL);
					imagenProdDiv.setAttribute("data-background", data.productoJim.imageData);
					//swiper.lazy.load();
					
					
					document.getElementById('idPrecioProd').innerText = data.productoJim.price;
				    document.getElementById('idNombreProd').innerText = data.productoJim.nameEs;
				    document.getElementById('idProdSelect').innerText = data.productoJim.nameEs;
				    document.getElementById('idRefProd').innerText = data.productoJim.reference;
				    document.getElementById('idStockProd').innerText = data.productoJim.stock;
				    document.getElementById('idProvProd').innerText = data.productoJim.nomProveedor;  // para la info de la derecha
					document.getElementById('idProvSelect').innerText = data.productoJim.nomProveedor;
					idProducto = data.productoJim.idProduct;
					idProdVariant= data.productoJim.prodVariant;
				}else{
					document.getElementById('idPrecioProd').innerText = 'No existe';
				    document.getElementById('idRefProd').innerText = 'No existe';
				    document.getElementById('idStockProd').innerText = 'No existe';
				    document.getElementById('btnAddCarrito').removeAttribute('href');//deshabilito el botón de Añadir
				}
				break;
			case '2':
				if(data.productoHyper != null){
					document.getElementById('idPrecioProd').innerText = data.productoHyper.price;
				    document.getElementById('idNombreProd').innerText = data.productoHyper.nameEs;
				    document.getElementById('idProdSelect').innerText = data.productoHyper.nameEs;
				    document.getElementById('idRefProd').innerText = data.productoHyper.reference;
				    document.getElementById('idStockProd').innerText = data.productoHyper.stock;
				    document.getElementById('idProvProd').innerText = data.productoHyper.nomProveedor;  // para la info de la derecha
					document.getElementById('idProvSelect').innerText = data.productoHyper.nomProveedor;
					idProducto = data.productoHyper.idProduct;
					idProdVariant= data.productoHyper.prodVariant;
				}else{
					document.getElementById('idPrecioProd').innerText = 'No existe';
				    document.getElementById('idRefProd').innerText = 'No existe';
				    document.getElementById('idStockProd').innerText = 'No existe';
				    document.getElementById('btnAddCarrito').removeAttribute('href');//deshabilito el botón de Añadir
				}
				break;
			case '3':
				if(data.productoNatur != null){
					document.getElementById('idPrecioProd').innerText = data.productoNatur.price;
				    document.getElementById('idNombreProd').innerText = data.productoNatur.nameEs;
				    document.getElementById('idProdSelect').innerText = data.productoNatur.nameEs;
				    document.getElementById('idRefProd').innerText = data.productoNatur.reference;
				    document.getElementById('idStockProd').innerText = data.productoNatur.stock;
				    document.getElementById('idProvProd').innerText = data.productoNatur.nomProveedor;  // para la info de la derecha
					document.getElementById('idProvSelect').innerText = data.productoNatur.nomProveedor;
					idProducto = data.productoNatur.idProduct;
					idProdVariant= data.productoNatur.prodVariant;
				}else{
					document.getElementById('idPrecioProd').innerText = 'No existe';
				    document.getElementById('idRefProd').innerText = 'No existe';
				    document.getElementById('idStockProd').innerText = 'No existe'; 
				    document.getElementById('btnAddCarrito').removeAttribute('href');//deshabilito el botón de Añadir
				}
				break;
			}
		}, 
		dataType : "json"   
	});
}

/******************************* VER PRODUCTOS *********************************/
function mostrarBotones(size, products, idProveedor) {
    console.log("Llamada a mostrarBotones");
    var btnItems = ''; // Contenedor de los botones
    var btn;

    var btnActive = document.querySelector('#botones .pagination.active');
    var pageIndex = 1;
    if (btnActive) pageIndex = parseInt(btnActive.textContent); // Si existe un botón activo, obtenemos el valor

    var btnBefore = "<a class='pagination' id='btnBefore'>&lt;</a>";
    var btnNext = "<a class='pagination' id='btnNext'>&gt;</a>";

    // Limpiar el contenedor de los botones
    $('#botones').empty();

    if (size >= 10) {
        var nButtons = 3; // Número de botones
        var firstInit = (pageIndex > 1 && pageIndex <= size - 10) ? pageIndex - 1 : 1;
        var secondInit = (pageIndex <= size - nButtons) ? size - nButtons : size - nButtons + 1;

        for (var i = 0; i < nButtons; i++) {
            if ((firstInit + i) < secondInit) {
                btn = "<a class='pagination'>" + (firstInit + i) + "</a>";
            } else {
                btn = "<a class='pagination'>" + (i + 1) + "</a>";
            }
            btnItems += btn;
        }

        if (secondInit > firstInit) {
            btnItems += "<a class='pagination'> ... </a>";
            for (var i = 0; i < nButtons; i++) {
            	if(secondInit + i < size)
                	btnItems += "<a class='pagination'>" + (secondInit + i) + "</a>";
            }
        }
    } else {
        for (var i = 0; i < size; i++) {
            btnItems += "<a class='pagination'>" + (i + 1) + "</a>";
        }
    }

    $('#botones').append(btnBefore + btnItems + btnNext);
    
    // Seleccionar todos los botones generados
    var btnElements = $('#botones .pagination');
	
    // Marcar como activo boton de la pagina actual
    btnElements.each(function (index, element) {
        if (parseInt($(element).text()) === pageIndex) {
            $(element).addClass('active');
        }
    });

    // Poner oyentes a cada botón
    $('#botones .pagination').click(function () {
        quitarActivo();
        console.log("He pulsado el boton " + this.textContent);

        var indice = parseInt(this.textContent);
        if (!isNaN(indice)) {
            var o = (indice - 1) * xPag;
            var h = indice * xPag;
            $(this).addClass("active");

            mostrarResultadoBusqueda(o, h, products, products.length);
            mostrarBotones(size, products, idProveedor);
        }
    });

    // Evento de clic para "Anterior"
    $('#btnBefore').click(function () {
        if (pageIndex > 1) {
            quitarActivo();
            pageIndex--;
            console.log("He pulsado el boton Anterior");

            var o = (pageIndex - 1) * xPag;
            var h = pageIndex * xPag;
            
            
            
            $('#botones a').each(function () {
                if (parseInt($(this).text()) === pageIndex) {
                    $(this).addClass('active');
                }
            });
            
            mostrarResultadoBusqueda(o, h, products, products.length);
            mostrarBotones(size, products, idProveedor);
        }
    });

    // Evento de clic para "Siguiente"
    $('#btnNext').click(function () {
        if (pageIndex < size) {
            quitarActivo();
            pageIndex++;
            console.log("He pulsado el boton Siguiente");

            var o = (pageIndex - 1) * xPag;
            var h = pageIndex * xPag;
            
            $('#botones a').each(function () {
                if (parseInt($(this).text()) === pageIndex) {
                    $(this).addClass('active');
                }
            });
            mostrarResultadoBusqueda(o, h, products, products.length);
            mostrarBotones(size, products, idProveedor);
        }
    });
}

 
function quitarActivo(){
    var losBotones = document.querySelectorAll('#botones a');
    for(var i = 0; i < losBotones.length; i++){
        $(losBotones[i]).removeClass('active');
    }
}

function mostrarLista(desde,hasta, prods,totales){
	$("#contentFilterJim").empty();
	$("#contentFilterHyper").empty();
	$("#contentFilterNatur").empty();
	var h = hasta;
	if(hasta>totales){
		h=totales;
	} 
	var lista = '';     
	
	for(var i = desde; i < h; i++){    
		if(prods[i].idProveedor == 1){ // si es Jimsport la imagen no está en base64

			$('#contentFilterJim').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>MATERIAL DEPORTIVO</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src=" + prods[i].imageData + " alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+prods[i].idProduct+"&idProveedor=1' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",1)'>	  <span class='button-wrapper'> 	<span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong>  <span class='glyphicon glyphicon-euro'></span>  </div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].descripcion+"</div>  		</div> 	</div> </div>"); 
		}else if(prods[i].idProveedor == 2){ // si es Hypertrophy la imagen SI está en base64
			if(prods[i].imageData != null){
				$('#contentFilterHyper').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>SUPLEMENTACIÓN DEPORTIVA</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'>  <img src=" + prods[i].imageData + " alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=2' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",2)'>		<span class='button-wrapper'> 	<span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span></div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].nameEs+"</div>  	</div> 	</div> </div>");
			}else{
				$('#contentFilterHyper').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>SUPLEMENTACIÓN DEPORTIVA</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src='https://gestplus.okmas.net/GestPlus/resources/image/noImage.png' alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=2' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",2)'>		<span class='button-wrapper'> 	<span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span></div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].nameEs+"</div>  	</div> 	</div> </div>");
			}
		}else if(prods[i].idProveedor == 3){ // si es Naturatal
			$('#contentFilterNatur').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>PRODUCTOS NATURALES</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src=" + prods[i].imageData + " alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=3' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",3)'>	<span class='button-wrapper'> 	<span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span> </div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].descripcion+"</div>  	</div> 	</div> </div>");

		}
    }
	
} 

/**
 * @author Deporocio
 *
 * Función muestra productos pertenecientes al array "listFilter", desde el producto que se encuentre en la posicion indicado por la variable "desde"
 * hasta el producto que se encuentra en la variable "hasta - 1".
 */
function mostrarListaTodos(desde,hasta){
	allProducts = allProductsJim.concat(allProductsHyper).concat(allProductsNatur);	//concateno las listas de todos los proveedores 
	
	listFilter = new Array();
	listFilter = allProducts;
	totales = listFilter.length;
	
	$("#idContentAllProducts").empty();
	
// 	nPag = Math.ceil(totales / xPag); 
//     offset = (pag - 1) * xPag;
//     hasta = pag * xPag;
    
    
	var h = hasta;
	if(hasta>totales){
		h=totales;
	}   
    
    for(var i = desde; i < h; i++){    
		if(listFilter[i].idProveedor == 1){ // si es Jimsport la imagen no está en base64

			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=1'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",1)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].descripcion+"</div>   </div> </div> </div>");			
		}else if(listFilter[i].idProveedor == 2){ // si es Hypertrophy la imagen SI está en base64
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+listFilter[i].idProduct+"&idProveedor=2'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",2)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].nameEs+"</div>   </div> </div> </div>");
		}else if(listFilter[i].idProveedor == 3){ // si es Naturatal
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+listFilter[i].idProduct+"&idProveedor=3'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",3)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].descripcion+"</div>   </div> </div> </div>");

		}
    }
}

//mostrarResultadoBusqueda(0,pag * xPag, listFilter,listFilter.length);  
function mostrarResultadoBusqueda(desde, hasta, prods, totales){
	$("#contentFilterSearch").empty();
	$("#idContentAllProducts").empty();
	
	
	var h = hasta;
	if(hasta>totales){
		h=totales;
	} 
	var lista = '';     
	
	for(var i = desde; i < h; i++){    
		if(prods[i].idProveedor == 1){ 

			//relleno el content de okeymasTiendaUX
			$('#contentFilterSearch').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>MATERIAL DEPORTIVO</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src=" + prods[i].imageData + " alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+prods[i].idProduct+"&idProveedor=1' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",1)'>		<span class='button-wrapper'> 	<span class='icon'><img src='img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span></div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].descripcion+"</div>  		</div> 	</div> </div>"); 
			//relleno el content de okeymasTiendaProductos
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+prods[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ prods[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+prods[i].idProduct+"&idProveedor=1'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",1)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+prods[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+prods[i].descripcion+"</div>   </div> </div> </div>");
		}else if(prods[i].idProveedor == 2){ // si es Hypertrophy la imagen SI está en base64
			$('#contentFilterSearch').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>SUPLEMENTACIÓN DEPORTIVA</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src='https://gestplus.okmas.net/GestPlus/resources/image/noImage.png 'alt=''  /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=2'>  <span class='button-wrapper'>  <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span></span></a> 	</span> 	</a> 	</span> 	</a> 	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",2)'>		<span class='button-wrapper'> 	<span class='icon'><img src='img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span></div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].nameEs+"</div>  		</div> 	</div> </div>");
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+prods[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ prods[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=2'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",2)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+prods[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+prods[i].nameEs+"</div>   </div> </div> </div>");
		}else if(prods[i].idProveedor == 3){ // si es Naturatal
			$('#contentFilterSearch').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>PRODUCTOS NATURALES</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src=" + prods[i].imageData + " alt=''  /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=3'>  <span class='button-wrapper'>  <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span></span></a> 	</span> 	</a>  	</span> 	</a> 	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",3)'>		<span class='button-wrapper'> 	<span class='icon'><img src='img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span> </div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].descripcion+"</div>  		</div> 	</div> </div>");
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+prods[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ prods[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=3'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",3)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+prods[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+prods[i].descripcion+"</div>   </div> </div> </div>");

		}
    }
	
	
	//comprobar si contentFilter está vacío 
	var elem = document.getElementById('contentFilterSearch');
	if(elem != null && elem.children.length == 0){
		$('#contentFilterSearch').append("<div><h3>No hay artículos disponibles</h3></div>"); // una imagen de no hay artículos 
	}
	
	//si estoy en la pantalla de allProducts comprobar si idContentAllProducts está vacío 
	var elem = document.getElementById('idContentAllProducts');
	if(elem != null && elem.children.length == 0){
		$('#idContentAllProducts').append("<div><h3>No hay artículos disponibles</h3></div>"); // una imagen de no hay artículos 
	}

	//$(this).scrollTop(0); 
} 

/******************************************************FILTRO POR CATEGORÍA************************************************/
function filterProducts(categoria,idProveedor){ 
	var params = {};
	params["idCategoria"] = categoria; 
	
	switch (idProveedor) {
	case 1:
		$.ajax({
			url : "/GestPlus/filterByCategory",
			type : "POST",
			data : params,
			// myDataTable migth not exist 
			success : function(data, textStatus) {
				listFilter = new Array();
				listFilter = data.listProductos;
				totales = data.totalRecords;     
				mostrarLista(0,pag * xPag, data.listProductos,totales);  
				nPag = Math.ceil(data.totalRecords / xPag); 
				mostrarBotones(nPag,listFilter);
				document.getElementById('idContentFilterJim').style.display='block';
				document.getElementById('idContentFilterHyper').style.display='none';
				document.getElementById('idContentFilterNatur').style.display='none';
			}, 
			dataType : "json"   
		});  
		break;
	case 2:
		$.ajax({
			url : "/GestPlus/filterByHyperCategory",
			type : "POST",
			data : params,
			// myDataTable migth not exist 
			success : function(data, textStatus) {  
				listFilter = new Array();
				listFilter = data.listProductos;
				totales = data.totalRecords;   
				mostrarLista(0,pag * xPag, data.listProductos,totales);  
				nPag = Math.ceil(data.totalRecords / xPag); 
				mostrarBotones(nPag,listFilter);
			}, 
			dataType : "json"
		});  
	break;
	default:
		break;
	}
}

/******************************************************PAGO************************************************/
function validar(){
	 if ($('#idNombreEnvio').val()==''){
		swal("El nombre es obligatorio.");
		return false;
	 } else if ($('#idApellidosEnvio').val()==''){
		swal("El apellido es obligatorio.");
		return false;
	 } else if ($('#idDireccion').val()==''){
		swal("La dirección es obligatoria");
		return false;
	 } else if ($('#idNumeroEnvio').val()==''){
		swal("El número es obligatorio.");
		return false;
	 }  else if ($('#idLocalidad').val()==''){
		swal("La localidad es obligatoria");
		return false;
	 }else if ($('#idProvinciaEnvio').val()==''){
		swal("La provincia es obligatoria");
		return false;
	 }else if ($('#idCodPost').val()==''){
		swal("El cod postal es obligatorio.");
		return false;
	 } 
	 return true;
}

/*function fn_pago(){ // este paso lo que hace es crear el purchase en bd y abrir la pasarela de pago Redsys 
	
	if(validar()){
		if(confirm("Sus datos serán registrado en nuestra base de datos Es necesario registrarse para proceder con el pago, ¿está de acuerdo en que usemos sus datos?")){
			
			var params = {};
					
			params["nombre"] = idNombreEnvio.value;
			params["apellidos"] = idApellidosEnvio.value;
			params["email"] = idEmailEnvio.value;
			params["movil"] = idMovilEnvio.value;
			params["pwd"] = idPwdEnvio.value;
			//params["pwd"] = idRepeatPwdEnvio.value;
			
			if(idAceptaCondCh.checked)
				params["aceptaCondiciones"]=1;
			else
				params["aceptaCondiciones"]=0;
			
			if(idAceptaPromosCh.checked)
				params["aceptaPromos"]=1;
			else
				params["aceptaPromos"]=0;
			
			if(idAceptaComunCh.checked)
				params["aceptaComunicaciones"]=1;
			else
				params["aceptaComunicaciones"]=0;
		
			params["direccion.tipo"] = idTipoEnvio.value;
			params["direccion.street"] =  idDireccionEnvio.value; 
			params["direccion.street2"] = idNumeroEnvio.value; 
			params["direccion.zip"] = idCodPostEnvio.value; 
			params["direccion.city"] = idLocalidadEnvio.value;
			params["direccion.provincia"] =  idProvinciaEnvio.value; 
			params["direccion.country_code"] = "ES";
			
			var i=0;
			listCarrito.forEach((element) => {
				params["productos["+i+"].quantity"] = 1,
			    params["productos["+i+"].product_id"] = element.idProduct;
			    params["productos["+i+"].variant_id"] = element.prodVariant; 
			    params["productos["+i+"].idProveedor"] = element.idProveedor;
			    params["productos["+i+"].price"] = element.price;
			    params["productos["+i+"].imageData"] = element.imageData;
			    params["productos["+i+"].reference"] = element.reference;
			    params["productos["+i+"].nameEs"] = element.nameEs;
			    i++;
			}); 
		
			params["total"]=document.getElementById('idTotalPagar').innerHTML;  
			//params["total"] = 2.55;   	
			
			$.ajax({
				url : "/GestPlus/pagoTienda",
				type : "POST",
				data : params,
				// myDataTable migth not exist
				success : function(data, textStatus) {
					var errorMessage = data.error;
					if (typeof (errorMessage) !== "undefined"
							&& errorMessage !== null && errorMessage !== '') {
						swal("Se ha producido un error: " + errorMessage);
					} else {
						paramPurchase = data.paramPurchase;
						$("#paramPurchase").val(paramPurchase);
						signaturePurchase = data.signaturePurchase;
						$("#signaturePurchase").val(signaturePurchase);
						$('#frmPurchase').submit();
					}
				},
				dataType : "json"
			});
		}
	}
	return true;
}*/


function fn_pago() { 
    if (validar()) {
    	if(isLoggedIn.equals('true')){ 
	    	pagar(); 
    	}else{
    		if(confirm("Gracias por completar el formulario. Vamos a proceder a crear una cuenta con los datos proporcionados. ¿Desea continuar?")){
	    		pagar();
		    }
    	}
    }
    return true;
}

async function pagar(){
	var params = {};
    
    params["nombre"] = idNombreEnvio.value;
	params["apellidos"] = idApellidosEnvio.value;
	params["email"] = idEmailEnvio.value;
	params["movil"] = idMovilEnvio.value;
	params["pwd"] = idPwdEnvio.value;
	
	if(idAceptaCondCh.checked)
		params["aceptaCondiciones"]=1;
	else
		params["aceptaCondiciones"]=0;
	
	if(idAceptaPromosCh.checked)
		params["aceptaPromos"]=1;
	else
		params["aceptaPromos"]=0;
	
	if(idAceptaComunCh.checked)
		params["aceptaComunicaciones"]=1;
	else
		params["aceptaComunicaciones"]=0;

	params["direccion.tipo"] = idTipoEnvio.value;
	params["direccion.street"] =  idDireccionEnvio.value; 
	params["direccion.street2"] = idNumeroEnvio.value; 
	params["direccion.zip"] = idCodPostEnvio.value; 
	params["direccion.city"] = idLocalidadEnvio.value;
	params["direccion.provincia"] =  idProvinciaEnvio.value; 
	params["direccion.country_code"] = "ES";
	
	
	
    var i = 0;
    var productsWithoutStock = "";

    for (let element of listCarrito) {
        const product = await fn_getProductById(element.idProduct, element.prodVariant, element.idProveedor);

        if (parseInt(product.stock) >= parseInt(element.quantity)) {
            params["productos[" + i + "].quantity"] = element.quantity;
            params["productos[" + i + "].product_id"] = element.idProduct;
            params["productos[" + i + "].variant_id"] = element.prodVariant; 
            params["productos[" + i + "].idProveedor"] = element.idProveedor;
            params["productos[" + i + "].price"] = element.price;
            params["productos[" + i + "].imageData"] = element.imageData;
            params["productos[" + i + "].reference"] = element.reference;
            params["productos[" + i + "].nameEs"] = element.nameEs;
        } else {
            productsWithoutStock = productsWithoutStock + ", " + element.nameEs;
        }

        i++;
    }

    if (productsWithoutStock) {
        swal("Los productos: " + productsWithoutStock + ". No tienen stock suficiente para realizar el pedido");
    }

    params["total"] = document.getElementById('idTotalPagar').innerHTML;

    $.ajax({
        url: "/GestPlus/pagoTienda",
        type: "POST",
        data: params,
        success: function(data, textStatus) {
            var errorMessage = data.error;
            if (typeof (errorMessage) !== "undefined" && errorMessage !== null && errorMessage !== '') {
                swal("Se ha producido un error: " + errorMessage);
            } else {
                paramPurchase = data.paramPurchase;
                $("#paramPurchase").val(paramPurchase);
                signaturePurchase = data.signaturePurchase;
                $("#signaturePurchase").val(signaturePurchase);
                $('#frmPurchase').submit();
            }
        },
        dataType: "json"
    });
}



/******************************************************CONSULTAR UN PRODUCTO************************************************/

function fn_infoProduct(){	
	console.log("fn_infoProducttt");
	switch (elProv) {
	case '1':
	case 1:
		precio = '';
		//nombre = '';
		nombre= '';
		ref = '';
		stock = '';
		prov = '';
		nomProv = '';
		idProducto = '';
		idProdVariant= '';  
		desc = '';
		break;
	case '2':
	case 2:
		precio = ''; 
		nombre = ''; // c:out respeta las ñ y tildes
		ref = '';
		stock = '';
		prov = '';
		nomProv = '';
		idProducto = '';
		idProdVariant= '';  
		desc = '';
		
		break;
	case '3':
	case 3:
		precio = ''; 
		//nombre = '';
		nombre= '';  
		ref = '';
		stock = '';
		prov = '';
		nomProv = '';
		idProducto = '';
		idProdVariant= '';
		
		desc = '';
		
		aptoD = '' === "true" ? "SI" : "NO";
		aptoV = '' === "true" ? "SI" : "NO";
		bio = '' === "true" ? "SI" : "NO";
		cantMedida = '';
		congelado = '' === "true" ? "SI" : "NO";
		frio = '' === "true" ? "SI" : "NO";
		gluten = '' === "true" ? "SI" : "NO";
		huevo = '' === "true" ? "SI" : "NO";
		lactosa = '' === "true" ? "SI" : "NO";
		break;
	default:
		break;
	}
	document.getElementById("loader").classList.add("hidden");
}

function decodeHTML(html) { //para decodificar el texto cuando está escapado
    var textarea = document.createElement('textarea');
    textarea.innerHTML = html;
    //return textarea.value; 
 // Decodificar el texto y eliminar saltos de línea o espacios innecesarios
    return textarea.value.replace(/^\s+|\s+$/g, '').replace(/\n+/g, '\n').trim();
}

function sanitizeHTML(html) {
    // Reemplazar etiquetas duplicadas o mal formadas
    html = html.replace(/&lt;&lt;/g, '&lt;');
    html = html.replace('h2', 'h6');//cambio h2 por h8 
    // Crear un elemento para decodificar el texto
    var textarea = document.createElement('textarea');
    textarea.innerHTML = html;

    return textarea.value;
}

</script>

</body>

<!-- Mirrored from gestplus.okmas.net/GestPlus/okeymasTiendaProductos?idProveedor=1 by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 02 Apr 2025 10:35:34 GMT -->
</html>
         <header>
            <div class="header-top">
                <div class="content-margins">
                    <div class="row">
                        
                        <div class="col-md-12 col-md-text-right">

                            <div class="entry" id="divIniciarSesion"> <!--    display: inline-block -->
                                <a class="open-popup" data-rel="1">iniciar sesión</a>&nbsp; | &nbsp;
                                <a class="open-popup" data-rel="2">registrarme</a>
                                <a class="open-popup" data-rel="3" style="display: none;">recuperar pwd</a>
                            </div>
                            <div class="entry" id="idMiCuenta" style="display: none;">
                                <a href="okeymasTiendaMiCuenta.html" >mi cuenta</a>&nbsp; | &nbsp;
                                <a href="#" onclick="fn_cerrarSesion();">cerrar sesión</a>
                            </div>
                                                        
                            <div class="entry hidden-xs hidden-sm cart">
<!--                                 <a href="javascript:void(0);" onclick="fn_verCarrito();">  -->
<!--  								<a href="javascript:fn_verCarrito();">  -->
									<a href="#" onclick="fn_verCarrito();return false;">
                                    carrito
                                    <span class="cart-icon">
                                        <img src="resources/jimTienda/designUX/img/update-image/Cart.png">
                                        <span id="cantidadCarrito" class="cart-label" ></span>
                                    </span>
                                    <span id="idTotal" class="cart-title hidden-xs" ></span>
                                </a>
                                <div class="cart-toggle hidden-xs hidden-sm">
                                    <div id="idCesta" class="cart-overflow">
                                       
                                    </div>
                                    <div class="empty-space col-xs-b40"></div>
                                    <div class="row">
                                        <div class="col-xs-6">
                                            <div class="cell-view empty-space col-xs-b50"> 
                                                <div class="simple-article size-5 grey">TOTAL <span id="totalConIva" class="color"></span></div>
                                            </div>
                                        </div>
                                        <div class="col-xs-6 text-right">
                                            <a class="button size-2 style-3" href="#" onclick="fn_checkout();return false;">
                                                <span class="button-wrapper">
                                                    <span class="icon"><img src="resources/jimTienda/designUX/img/icon-4.png" alt=""></span>
                                                    <span class="text">proceder a comprar</span>
                                                </span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="hamburger-icon">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-bottom">
                <div class="content-margins">
                    <div class="row">
                        <div class="col-xs-3 col-sm-1 col-md-3">
                            <a id="logo" href="okeymasTiendaUX.html"><img src="resources/jimTienda/designUX/img/update-image/OKEYMAS-blanco.png" alt="" /></a>  
                        </div>
                        <div class="col-xs-9 col-sm-11 col-md-9 text-right">
                            <div class="nav-wrapper">
                                <div class="nav-close-layer"></div>
                                <nav>
                                    <ul>                                                      
                                        <li class="">
                                            <a href="okeymasTiendaUX.html">inicio</a>
                                            
                                        </li>
                                        <li>
                                            <a href="okeymasTiendaProductos.html">productos</a>
                                        </li>
                                        <li>
                                            <a href="https://okeymas.es/">okeymas</a>
                                        </li>
                                       
                                        <li><a href="okeymasTiendaContacto.html">contacto</a></li>
                                    </ul>
                                </nav>
                            </div>
                            
                            
                           <!--  Esta parte es para la parte responsive --> 
<!--                             <div class="header-bottom-icon toggle-search"> -->
<!--                             	<i class="fa fa-search" aria-hidden="true"></i>  -->
<!--                             </div> -->
                            <div class="header-bottom-icon visible-rd">
                                <i class="fa fa-shopping-bag" aria-hidden="true" onclick="fn_verCarrito();return false;"> </i>
                                <span id="idCircleCarrito" class="cart-label"></span>
                            </div>
                        </div>
                    </div>
<!--                     <div class="header-search-wrapper"> -->
<!--                         <div class="header-search-content"> -->
<!--                             <div class="container-fluid"> -->
<!--                                 <div class="row" id="idBusqueda"> -->
<!--                                     <div class="col-sm-8 col-sm-offset-2 col-lg-6 col-lg-offset-3"> -->
<!--                                         <form> -->
<!--                                             <div class="search-submit" > -->
<!--                                                 <i class="fa fa-search" aria-hidden="true" id="btnBusqueda" onclick="busqueda()"></i> -->
<!--                                             </div> -->
<!--                                             <input id="txtFilterBase" class="simple-input style-1" type="text" value="" placeholder="Buscar..." />   -->
<!--                                         </form> -->
<!--                                     </div> -->
<!--                                 </div> -->
<!--                             </div> -->
<!--                             <div class="button-close"></div>   -->
<!--                         </div> -->
<!--                     </div> -->
                </div>
            </div>
            
            <div class="popup-wrapper">
        <div class="bg-layer"></div>

        <div class="popup-content" data-rel="1">
            <div class="layer-close"></div>
            <div class="popup-container size-1">
                <div class="popup-align">
                    <h3 class="h3 text-center">Log in</h3>
                    <div class="empty-space col-xs-b30"></div>
                    <input id="idEmailLogin" class="simple-input" type="text" value="" placeholder="Your email" />
                    <div class="empty-space col-xs-b10 col-sm-b20"></div>
                    <input id="idPwdLogin" class="simple-input" type="password" value="" placeholder="Enter password" />
                    <div class="empty-space col-xs-b10 col-sm-b20"></div>
                    <div class="row">
                        <div class="col-sm-6 col-xs-b10 col-sm-b0">
                            <div class="empty-space col-sm-b5"></div>
                            <a class="simple-link" onclick="$('.popup-wrapper, .popup-content[data-rel=3]').addClass('active');">He olvidado mi contraseña</a>
                            <div class="empty-space col-xs-b5"></div> 
<!--                             <a class="open-popup" data-rel="2">register now</a> -->
                            <a class="simple-link" onclick="$('.popup-wrapper, .popup-content[data-rel=2]').addClass('active');">Registrarme</a>
                        </div>
                        <div class="col-sm-6 text-right">
                            <a class="button size-2 style-3" href="#" onclick="fn_login(false);"> 
                                <span class="button-wrapper">
                                    <span class="icon"><img src="resources/jimTienda/designUX/img/icon-4.png" alt="" /></span>
                                    <span class="text">LOGIN</span>
                                </span>
                            </a>  
                        </div>
                    </div>

                </div>
                <div class="button-close"></div>
            </div>
        </div>

        <div class="popup-content" data-rel="2">
            <div class="layer-close"></div>
            <div class="popup-container size-1">
                <div class="popup-align">
                    <h3 class="h3 text-center">REGISTRO</h3>
                    <div class="empty-space col-xs-b30"></div>
                    <h5 class="h5 text-center">Datos personales</h5>
                    <input id="nombreCliente" required class="simple-input" type="text" value="" placeholder="Nombre" />
                    <div class="empty-space col-xs-b30"></div>
                    <input id="apellidos" required class="simple-input" type="text" value="" placeholder="Apellidos" />
                    <div class="empty-space col-xs-b30"></div>
                    <input id="movil" required class="simple-input" type="text" value="" placeholder="Móvil" />
                    <div class="empty-space col-xs-b10 col-sm-b20"></div>
                    <input id="email" required class="simple-input" type="text" value="" placeholder="Email" />
                    <div class="empty-space col-xs-b10 col-sm-b20"></div>
                    <input id="idPwd" required  class="simple-input" type="password" value="" placeholder="Password" />
                    <div class="empty-space col-xs-b10 col-sm-b20"></div>
                    <input id="idRepeatPwd" required class="simple-input" type="password" value="" placeholder="Repeat password" />
                    <div class="empty-space col-xs-b10 col-sm-b20"></div>
                    
                    
                    <h5 class="h5 text-center">Datos envío</h5>
                     <select class="SlectBox" id="tipo">
                          <option disabled="disabled" selected="selected">Tipo</option>
                          <option value="calle">Calle</option>
                          <option value="avenida">Avenida</option>
                          <option value="travesia">Travesía</option>
                          <option value="otro">Otro</option>
                      </select>
                    <div class="empty-space col-xs-b30"></div>
                    <input id="direccion" required  class="simple-input" type="text" value="" placeholder="Dirección" />
                    <div class="empty-space col-xs-b30"></div>
                    <input id="numero" required  class="simple-input" type="text" value="" placeholder="Número" />
                    <div class="empty-space col-xs-b10 col-sm-b20"></div>
                    <input id="codPost" required  class="simple-input" type="text" value="" placeholder="CP" />
                    <div class="empty-space col-xs-b10 col-sm-b20"></div>
                    <input id="localidad" required  class="simple-input" type="text" value="" placeholder="Localidad" />
                    <div class="empty-space col-xs-b10 col-sm-b20"></div>
                    <input id="provincia" required  class="simple-input" type="text" value="" placeholder="Provincia" />
                    <div class="empty-space col-xs-b10 col-sm-b20"></div>
                    
                    <div class="row">
                        <div class="col-sm-12 col-xs-b10 col-sm-b0"> 
                            <div class="empty-space col-sm-b15"></div>
                            <label class="checkbox-entry" style="font-size: smaller;">
                                <input type="checkbox" id="idAceptaCond"/>
	                                <span>
										Acepto la totalidad de condiciones del  
										<a href="http://82.223.22.233:8080/GestPlus/resources/AvisoLegalTienda.pdf" target="_blank">Aviso Legal y </a>
										 <a href="http://82.223.22.233:8080/GestPlus/resources/PoliticaPrivacidadTienda.pdf" target="_blank">Política de privacidad</a>
				  					</span>
                            </label>
                         
							  
                            <div class="empty-space col-sm-b15"></div>
                            <label class="checkbox-entry"  style="font-size: smaller;">
                                <input type="checkbox"  checked="checked" id="idAceptaPromos"/>
	                                <span>Acepto recibir promociones, ofertas y comunicaciones comerciales</span>
                            </label>
                            <div class="empty-space col-sm-b15"></div>
                            <label class="checkbox-entry"  style="font-size: smaller;">
                                <input type="checkbox"  checked="checked" id="idAceptaComun"/>
	                                <span>Acepto que estas comunicaciones sean personalizadas en función de mi perfil, comportamiento y mis preferencias personales</span>
                            </label>
                        </div>
                    </div>
                    <div class="col-sm-5 text-right">
                            <a class="button size-2 style-3" href="#" onclick="fn_registrar();">
                                <span class="button-wrapper">
                                    <span class="icon"><img src="resources/jimTienda/designUX/img/icon-4.png" alt="" /></span>
                                    <span class="text">Aceptar</span>
                                </span>
                            </a>  
                        </div>
                </div>
                <div class="button-close"></div>
            </div>
        </div>
        
        <div class="popup-content" data-rel="3">
            <div class="layer-close"></div>
            <div class="popup-container size-1">
                <div class="popup-align">
                    <h3 class="h3 text-center">RECOVERY PASSWORD</h3>
                    <div class="empty-space col-xs-b30"></div>
                    <input id="idForgotEmail" class="simple-input" type="text" value="" placeholder="Your email" />
                    <div class="empty-space col-xs-b10 col-sm-b20"></div>
                    <input id="idForgotPwd" class="simple-input" type="password" value="" placeholder="Enter new password" />
                    <div class="empty-space col-xs-b10 col-sm-b20"></div>
                    <div class="row">
                       
                        <div class="col-sm-6 text-right">
                            <a class="button size-2 style-3" href="#" onclick="fn_olvidoPwd();"> 
                                <span class="button-wrapper">
                                    <span class="icon"><img src="resources/jimTienda/designUX/img/icon-4.png" alt="" /></span>
                                    <span class="text">submit</span>
                                </span>
                            </a>  
                        </div>
                    </div>

                </div>
                <div class="button-close"></div>
            </div>
        </div>
        
    </div>
     <!-- Contenedor del icono loader -->
	    <div id="loader">
	        <img src="resources/jimTienda/designUX/img/cargando1.svg" alt="Cargando...">
	    </div>
</header>


<script>
var isLoggedIn = '';

$('#email').blur(function() { 
	compruebaEmail($('#email').val());
});


$(document).ready(function() {
	if(isLoggedIn.equals('true')){ 
		document.getElementById('divIniciarSesion').style.display='none';
		document.getElementById('idMiCuenta').style.display='inline-block';
	}else{
		document.getElementById('divIniciarSesion').style.display='inline-block';
		document.getElementById('idMiCuenta').style.display='none';
	}
	fn_actualizarVblesGlobales(); 
	
	
	//Seleccionamos el contenedor y el botón
	// const container = document.getElementById("idBusqueda");
	// const searchButton = document.getElementById("btnBusqueda");

	// Escuchamos el evento keydown en el contenedor
	/*container.addEventListener("keydown", function(event) {
	    if (event.key === "Enter") { // Detecta si se presionó Enter
	        event.preventDefault(); // Previene el comportamiento por defecto (si aplica)
	        searchButton.click(); // Dispara el evento click en el botón "Buscar"
	    }
	});*/
	
	/*const searchButton = document.getElementById("btnBusqueda");
	document.addEventListener("keydown", function (event) {
		  //if (event.keyCode === 27) {
		if (event.key === "Enter") { // Detecta si se presionó Enter
		  searchButton.click(); // Dispara el evento click en el botón "Buscar"
	  }
	});*/
});

</script>
        
</body>
</html>
</div>
<div id="content-block">
	




 
 
<!DOCTYPE html>
<html lang="en">

<body class="fonts-1">





 
 

<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no, minimal-ui"/>
    
    <!-- fonts -->
    <link href="https://fonts.googleapis.com/css?family=Questrial|Raleway:700,900" rel="stylesheet">

<link href="resources/jimTienda/designUX/css/bootstrap.min-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/bootstrap.extension-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/style-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/swiper-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/sumoselect-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/font-awesome.min-2.css"  rel="stylesheet"></link>
    
<!-- scripts -->
<script  src="resources/jimTienda/designUX/js/jquery-2.2.4.min.js"></script>
<script  src="resources/jimTienda/designUX/js/swiper.jquery.min.js"></script>
<script  src="resources/jimTienda/designUX/js/global.js"></script>

<!-- range slider -->
<script  src="resources/jimTienda/designUX/js/jquery-ui.min.js"></script>
<script  src="resources/jimTienda/designUX/js/jquery.ui.touch-punch.min.js"></script>


<script  src="resources/jimTienda/designUX/js/jquery.sumoselect.min.js"></script>


<script  src="resources/jimTienda/designUX/js/jquery.classycountdown.js"></script>
<script  src="resources/jimTienda/designUX/js/jquery.knob.js"></script>
<script  src="resources/jimTienda/designUX/js/jquery.throttle.js"></script>

<!-- masonry -->
<script src="resources/jimTienda/designUX/js/isotope.pkgd.min.js"></script>

<!--  estos scripts son necesarios para la parte de añadir productos a la cesta -->
<script src="../../cdn-na.infragistics.com/igniteui/latest/js/infragistics.core.js"></script>
<script src="../../cdn-na.infragistics.com/igniteui/latest/js/infragistics.dv.js"></script> 


<!-- MAP -->



<!-- CONTACT --> 
<script  src="resources/jimTienda/designUX/js/contact.form.js"></script>
    
<!-- OTROS -->  
<script src="resources/script/sweetalert.min.js"></script>
<script src="../../unpkg.com/bootstrap-table%401.15.5/dist/bootstrap-table.min.js"></script>


<link rel="shortcut icon" href="resources/jimTienda/designUX/img/favicon.ico" />

 <script src="../../cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
 
 <style>
        /* Loader toda la pantalla*/
        #loader {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* Fondo semitransparente */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* Animación de rotación */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Aplica la animación al SVG */
        #loader img {
            width: 50px; /* Ajusta el tamaño del SVG */
            height: 50px;
            animation: spin 1.5s linear infinite;
        }

        /* Ocultar el loader cuando esté listo */
        #loader.hidden {
            display: none;
        }
        
         /* Mostrar el loader cuando esté listo */
        #loader.show {
            display: block;
        }
        
    </style>
<title> </title>
</head>

<body>

<script type="text/javascript">
/***************************VARIABLES****************************/
var productosCarrito = [];
var numProdCarrito = 0;
var totales = 0; 
var pag = 1; 
var xPag = 30;//total de imágenes por página 
var nPag = 0;
var offset = 0;
var hasta = 0;

var cantidad=0;
var costeEnvio = 5;
var precioTotal = 0;
var listCarrito = [];
var jimSelect = 0;
var jimVarianteSelect = 0;
var listFilter = new Array(); 
var totalProd = 0;
var arrayProductos  = new Array();
var allProducts;
var allProductsJim; 
var allProductsHyper;
var allProductsNatur;

var elCliente;
var laDireccionEnvio;

var txtIva = " EUR (IVA INCLUIDO)"; 

var j=1;

var idProductoDevolver = 0;

var precio = '';
var nombre = '';
var ref =''; 
var stock = '';
var prov = '';
var nomProv = '';
var idProducto= '';
var idProdVariant = '';
var desc = '';

var isLoggedIn = '';
var direccionEnvio = '';
var emailLogged = '';
var pwdLogged = '';
var elProv ='1';
var idCli = '';


// var prodSesion = [];
/*
//Inicialmente agrega un estado ficticio al historial
history.pushState({ page: 1 }, "title 1", window.location.href);


// Escucha el evento "popstate"
window.addEventListener("popstate", function (event) {
  if (event.state && event.state.page === 1) {
    // Aquí se detecta cuando el usuario presiona "atrás"
    console.log("Botón 'Atrás' presionado");
    window.location.href = "https://gestplus.okmas.net/GestPlus/okeymasTiendaUX";
  }
});
*/ 

//------------------------------- Formulario de contacto -----------------------------------

/**
 * @author Juan Garcia
 *
 * Envia la respuesta recibida del formulario disponible en la pagina "okeymasTiendaContacto"
 */
function fn_sendContactForm() {
	
	var popup = ''; 
	
	// Rescatamos los datos del formulario con id = contactForm {contacto.jsp}
	var name 		= contactFormNombre.value;
	var lastname 	= contactFormApellidos.value;
	var phoneNumber = contactFormTelefono.value;
	var email		= contactFormEmail.value;
	var message		= contactFormMensaje.value;
	
	if(name && name !== ''
			&& lastname 	&& lastname !== ''
			&& phoneNumber 	&& phoneNumber !== ''
			&& email 		&& email !== ''
			&& message 		&& message !== ''){
		
		var params = {};
			params["nombre"] 	= name;
			params["apellidos"]	= lastname;
			params["movil"]		= phoneNumber;
			params["email"]		= email;
			params["mensaje"]	= message;
			
		 $.ajax({
	            url: "/GestPlus/sendContactForm",
	            type: "POST",
	            data: params,
	            success: function(data, textStatus) {
	                var errorMessage = data.error;
	                if (typeof (errorMessage) !== "undefined" && errorMessage !== null && errorMessage !== '') {
	                    swal("Se ha producido un error: " + errorMessage);
	                } else {
	                	
	                	popup = `
	    					<div class="popup-wrapper active">
	    					    <div class="bg-layer"></div>
	    					    <div class="popup-content active" data-rel="1">
	    					        <div class="layer-close"></div>
	    					        <div class="popup-container size-1">
	    					            <div class="popup-align">
	    					                <h3 class="h3 text-center">Gracias por confiar en nosotros</h3>
	    					                <div class="empty-space col-xs-b30"></div>
	    					                <h5 class="h5 text-center">Su solicitud será procesada por uno de nuestros agentes</h5>
	    					            </div>
	    					            <div class="button-close"></div>
	    					        </div>
	    					    </div>
	    					</div>`;
	    					
	                	// Inyectamos el popup en el cuerpo del documento
	                	document.body.innerHTML += popup;
	    					
	                }
	            },
	            dataType: "json"
	        });
	}else{
		popup = `
					<div class="popup-wrapper active">
					    <div class="bg-layer"></div>
					    <div class="popup-content active" data-rel="1">
					        <div class="layer-close"></div>
					        <div class="popup-container size-1">
					            <div class="popup-align">
					                <h3 class="h3 text-center">No podemos procesar la solicitud</h3>
					                <div class="empty-space col-xs-b30"></div>
					                <h5 class="h5 text-center">Debe rellenar todos los campos</h5>
					            </div>
					            <div class="button-close"></div>
					        </div>
					    </div>
					</div>`;
			// Inyectamos el popup en el cuerpo del documento
			document.body.innerHTML += popup;
					
	}
}

/*************************** INICIAR/CERRAR SESIÓN Y REGISTRO ****************************/

var compruebaEmail = function(email){ 
	if (email!==""){
		var params = {};
		params["email"]=email;
		$.ajax({
			url : "/GestPlus/compruebaEmailTienda",
			type : "POST",
			data : params,
			// myDataTable migth not exist
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"	&& errorMessage !== null 	&& errorMessage !== '') {
					swal("Se ha producido un error: "	+ errorMessage); 
				} else {
					var existeEmail = data.emailRegistrado; 
					if (existeEmail === true){
						swal("Este email ya pertenece a un usuario registrado.");
						$('#email').val(""); 
						$('#idEmailEnvio').val(""); 
					}
				}
			},
			dataType : "json"
		});	
	}
}
						
function fn_olvidoPwd(){
	
	if(idForgotEmail.value == ''){
		swal("Por favor, introduzca un email válido.");
		return false;
	}else if(idForgotPwd.value == ''){
		swal("Por favor, introduzca una nueva contraseña.");
		return false;
	}
	
	var params = {};
	params["email"] = idForgotEmail.value;
	params["newPwd"] = idForgotPwd.value;
	$.ajax({
		url : "/GestPlus/olvidoPwd",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal(errorMessage);
			} else {
				window.location.href= "okeymasTiendaMiCuenta.html";
			}
		},
		dataType : "json"
	});
}

function fn_login(isLogged){
	 
	if(idEmailLogin.value == ''){
		swal("Por favor, introduzca un email válido.");
		return false;
	}else if(idPwdLogin.value == ''){
		swal("Por favor, introduzca su contraseña.");
		return false;
	}
	
	var params = {};
	
	if(isLogged){
		params["email"] = emailLogged;
		params["pwd"] = pwdLogged;
	}else{
		params["email"] = idEmailLogin.value;
		params["pwd"] = idPwdLogin.value;
	}

	$.ajax({
		url : "/GestPlus/loginTienda",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal(errorMessage); 
			} else {
				// Si la cuenta existe, mostrar modal con el resumen de la compra
				// y un botón que lleve a la pasarela de pago 

			
				window.location.href= "okeymasTiendaMiCuenta.html";
				
				elCliente = data.cliente;
			}
		},
		/*error : function(data, textStatus) {
			var errorMessage = data.error;
			swal(errorMessage);  
		},*/
		dataType : "json"
	}); 
}

function fn_loginCh(isLogged){
	 
	if(idEmailLoginCh.value == ''){
		swal("Por favor, introduzca un email válido.");
		return false;
	}else if(idPwdLoginCh.value == ''){
		swal("Por favor, introduzca su contraseña.");
		return false;
	}
	
	var params = {};
	
	if(isLogged){
		params["email"] = emailLogged;
		params["pwd"] = pwdLogged;
	}else{
		params["email"] = idEmailLoginCh.value;
		params["pwd"] = idPwdLoginCh.value;
	}

	$.ajax({
		url : "/GestPlus/loginTienda",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal(errorMessage); 
			} else {
				// Si la cuenta existe, mostrar modal con el resumen de la compra
				// y un botón que lleve a la pasarela de pago 
				elCliente = data.cliente;
				window.location.href= "okeymasTiendaMiCuenta.html";
			}
		},
	
		dataType : "json"
	}); 
}

function fn_cerrarSesion(){
	if(confirm("¿Está seguro de cerrar sesión?")){
		var params = {};
		$.ajax({
			url : "/GestPlus/logoutTienda",
			type : "POST",
			data : params,
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal(errorMessage); 
				} else {
					window.location.href= "okeymasTiendaUX.html";

					
					//localStorage.clear(); // para limpiar el carrito almacenado en el navegador 
					//location.reload();
				}
			},
			dataType : "json"
		}); 
	}	
}

function fn_registrar(){
	if(validarCliente()){
		var params = {};
		params["nombre"] = nombreCliente.value;
		params["apellidos"] = apellidos.value;
		params["email"] = email.value;
		params["movil"] = movil.value;
		params["pwd"] = idPwd.value;
		
		params["direccion.provincia"] =  provincia.value; 
		params["direccion.street"] =  direccion.value; 
		params["direccion.street2"] = numero.value; 
		params["direccion.zip"] = codPost.value; 
		params["direccion.city"] = localidad.value;
		var tipoDirec = document.getElementById("tipo");
		params["direccion.tipo"] = tipoDirec.value;
		params["direccion.country_code"] = "ES";
		
		//params["direccion.partner_ref"] ="0001";//esto sería el purchase para identificar el pedido, por ejemplo j29231003125 
		//params["direccion.observations"] = "PEDIDO DE PRUEBA, NO TRAMITAR (SABE PABLO)";//observ.value
		//params["direccion.note"] ="Pedido Web DEPOROCIO\nReferencia Web, 0001";
		
		if(idAceptaCond.checked)
			params["aceptaCondiciones"]=1;
		else
			params["aceptaCondiciones"]=0;
		
		if(idAceptaPromos.checked)
			params["aceptaPromos"]=1;
		else
			params["aceptaPromos"]=0;
		
		if(idAceptaComun.checked)
			params["aceptaComunicaciones"]=1;
		else
			params["aceptaComunicaciones"]=0;
		
		$.ajax({
			url : "/GestPlus/registroTiendaOkmas",
			type : "POST",
			data : params,
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal(errorMessage);
				} else {
					elCliente = data.cliente;
					swal("Registro realizado con éxito");
					document.querySelector(".swal-button--confirm")?.addEventListener("click", () => window.location.href= "okeymasTiendaMiCuenta.html");
					// window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaMiCuenta"; 
				}
			},
			dataType : "json"
		});
	}
}

function validarCliente(){
	if ($('#nombreCliente').val()==''){
		swal("Nombre vacío.");
		return false;
	} else if ($('#apellidos').val()==''){
		swal("Apellidos  vacío.");
		return false;
	} else if ($('#email').val()==''){
		swal("Email  vacío.");
		return false;
	} else if ($('#movil').val()==''){
		swal("Móvil  vacío.");
		return false;
	} else if ($('#idPwd').val()==''){
		swal("Password  vacío.");
		return false;
	}  else if ($('#idRepeatPwd').val()==''){
		swal("Repite password  vacío.");
		return false;
	} else if ($('#idPwd').val() != $('#idRepeatPwd').val()){
		swal("Los passwords no coinciden.");
		return false;
	} else if ($('#direccion').val()==''){
		swal("Dirección  vacía."); 
		return false;
	} else if(!idAceptaCond.checked){
		swal("Debes aceptar las condiciones."); 
		return false;
	}
	return true;  
}

function fn_updateCuenta(){
	if(confirm("¿Está seguro de que desea modificar sus datos?")){
		var params = {};
		params["idCliente"] = idCuentaCliente;
		params["nombre"] = idMiNombre.value;
		params["apellidos"] = idMisApellidos.value;
		params["movil"] = idMiMovil.value;
		
		params["direccion.tipo"] = idCuentaTipo.value;
		params["direccion.provincia"] =  idCuentaProv.value; 
		params["direccion.street"] =  idCuentaDireccion.value; 
		params["direccion.street2"] = idCuentaNum.value; 
		params["direccion.zip"] = idCuentaCodPost.value; 
		params["direccion.city"] = idCuentaLocalidad.value;
		
		params["direccion.country_code"] = "ES";

		$.ajax({
			url : "/GestPlus/updateCuenta",
			type : "POST",
			data : params,
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal(errorMessage); 
				} else {
					elCliente = data.cliente;
					window.location.href= "okeymasTiendaMiCuenta.html"; 
					
				}
			},
			dataType : "json"
		}); 
	}	
}
/*************************** CARRITO ****************************/

/**
 * @author Deporocio
 *
 *
 * Almacena los productos del carrito en una variable de sesión.
 */
function fn_saveCarrito(){
	var params = {};
	var i = 0; 
	
	listCarrito.forEach((element) => {
		params["productos["+i+"].quantity"] = element.quantity,
	    params["productos["+i+"].product_id"] = element.idProduct;
	    params["productos["+i+"].variant_id"] = element.prodVariant; 
	    params["productos["+i+"].idProveedor"] = element.idProveedor;
	    params["productos["+i+"].price"] = element.price;
	    params["productos["+i+"].imageData"] = element.imageData;
	    params["productos["+i+"].reference"] = element.reference;
	    params["productos["+i+"].nameEs"] = element.nameEs;
	    i++;
	});  
	$.ajax({
		url : "/GestPlus/saveCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist 
		success : function(data, textStatus) {
			var s = data.productos;
			productosCarrito = data.productos;
		}
	}); 
}

/*function fn_verCarrito(){ // click en la cesta
	var params = {};
	var i=0;  
	
	if( prodSesion )
		prodSesion.forEach((element) => {  
	        params["productos[" + i + "].quantity"] 	= element.quantity;
	        params["productos[" + i + "].product_id"] 	= element.idProduct;
	        params["productos[" + i + "].variant_id"]	= element.prodVariant; 
	        params["productos[" + i + "].idProveedor"] 	= element.idProveedor;
	        params["productos[" + i + "].price"] 		= element.price;
	        params["productos[" + i + "].imageData"] 	= element.imageData;
	        params["productos[" + i + "].reference"] 	= element.reference;
	        params["productos[" + i + "].nameEs"] 		= element.nameEs;
	        
	        console.log("producto del carrito: " + element.nameEs + ", cantidad: " + element.quantity);
	        i++;
	    });  
	
	$.ajax({
		url : "/GestPlus/verCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist 
		success : function(data, textStatus) {
			var s = data.productos;
			productosCarrito = data.productos;
				
			//var url = "https://gestplus.okmas.net/GestPlus/okeymasTiendaCarrito?productosCarrito";
			//window.open(url,'_self'); //en la misma página
			//window.open(url);//en otra página
			//fn_abrirCarrito();
			window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaCarrito";

		}
	}); 
}*/

async function fn_verCarrito(){ 
	if(numProdCarrito < 1){
		swal("No hay productos en el carrito.");
		return;
	}
	
	const prodSesion = await traerProdSesion();
	var params = {};
	var i=0;  
	
	if( prodSesion )
		prodSesion.forEach((element) => {  
	        params["productos[" + i + "].quantity"] 	= element.quantity;
	        params["productos[" + i + "].product_id"] 	= element.idProduct;
	        params["productos[" + i + "].variant_id"]	= element.prodVariant; 
	        params["productos[" + i + "].idProveedor"] 	= element.idProveedor;
	        params["productos[" + i + "].price"] 		= element.price;
	        params["productos[" + i + "].imageData"] 	= element.imageData;
	        params["productos[" + i + "].reference"] 	= element.reference;
	        params["productos[" + i + "].nameEs"] 		= element.nameEs;
	        
	        console.log("producto del carrito: " + element.nameEs + ", cantidad: " + element.quantity);
	        i++;
	    });  
	
	$.ajax({
		url : "/GestPlus/verCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist 
		success : function(data, textStatus) {
			var s = data.productos;
			productosCarrito = data.productos;
				
			//window.open(url,'_self'); //en la misma página
			//window.open("https://gestplus.okmas.net/GestPlus/okeymasTiendaCarrito");//en otra página
			//fn_abrirCarrito();
			
			window.location.href= "okeymasTiendaCarrito.html";
			
		}
	}); 
}

/**
 * @author Deporocio
 * Trae los productos asociados a la variable de sesion del cliente.
 *
 *
 * @return {void}
 */
 function traerProdSesion() {
	  return new Promise((resolve, reject) => {
	    var params = {};

	    $.ajax({
	      url: "/GestPlus/verProdSesion",
	      type: "POST",
	      data: params,
	      success: function(data, textStatus) {
	        var errorMessage = data.error;
	        if (typeof errorMessage !== "undefined" && errorMessage !== null && errorMessage !== '') {
	          swal(errorMessage);
	          reject(new Error(errorMessage));
	        } else {
	          var prodSesion = data.productos;
	          console.log("Recibida respuesta del servidor, prodSesion: " + prodSesion);
	          resolve(prodSesion);
	        }
	      },
	      dataType: "json"
	    });
	  });
}
 
 /*
 function fn_comprobarCarrito(){
	 if(numProdCarrito < 1){
		 swal("No hay productos en el carrito");
	 }else{
		 window.location.href="https://gestplus.okmas.net/GestPlus/okeymasTiendaCheckout";
	 }
 }
 
 
/*function fn_checkout(){
	if(numProdCarrito == 0){
		swal("No hay productos en el carrito.");
		return;
	}
	
	var params = {};
	
	var i=0;   
	listCarrito.forEach((element) => {
		params["productos["+i+"].quantity"] = element.quantity,
	    params["productos["+i+"].product_id"] = element.idProduct;
	    params["productos["+i+"].variant_id"] = element.prodVariant; 
	    params["productos["+i+"].idProveedor"] = element.idProveedor;
	    params["productos["+i+"].price"] = element.price;
	    params["productos["+i+"].imageData"] = element.imageData;
	    params["productos["+i+"].reference"] = element.reference;
	    params["productos["+i+"].nameEs"] = element.nameEs;
	    i++;
	});  
	$.ajax({
		url : "/GestPlus/saveCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist 
		success : function(data, textStatus) {
			var s = data.productos;
			productosCarrito = data.productos;
				
			window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaCheckout";
		}
	}); 
}*/



async function fn_checkout() {
	console.log("----------------- fn_checkout() -----------------");
   
	if(numProdCarrito == 0){
		swal("No hay productos en el carrito.");
		return;
	}
	
	var params = {};
    var outOfStockProducts = []; // Lista para productos sin stock
    var i = 0;

    for (const element of listCarrito) {
    	try {
            var response = await fn_checkStock(element.idProduct, element.prodVariant, element.idProveedor, element.quantity);
            
            if (response === true) {
            	params["productos[" + i + "].quantity"] 	= element.quantity,
    		    params["productos[" + i + "].product_id"] 	= element.idProduct;
    		    params["productos[" + i + "].variant_id"] 	= element.prodVariant; 
    		    params["productos[" + i + "].idProveedor"]	= element.idProveedor;
    		    params["productos[" + i + "].price"] 		= element.price;
    		    params["productos[" + i + "].imageData"] 	= element.imageData;
    		    params["productos[" + i + "].reference"] 	= element.reference;
    		    params["productos[" + i + "].nameEs"] 		= element.nameEs;
               
            } else {
            	outOfStockProducts.push(element.nameEs);
            }
            i++;
            
        } catch (error) {
            console.error("Error verificando stock para :" + error);
        }
    }

    // Si hay productos sin stock, mostrarlos y detener el proceso
    if (outOfStockProducts.length > 0) {
        swal("Los siguientes productos no tienen stock suficiente: \n" + outOfStockProducts.join(", "));
        return;
    }

    // Si todos los productos tienen stock, hacer la petición AJAX
    $.ajax({
        url: "/GestPlus/saveCarrito",
        type: "POST",
        data: params,
        success: function (data, textStatus) {
            productosCarrito = data.productos;
            window.location.href = "okeymasTiendaCheckout.html";
        },
        error: function (xhr, status, error) {
            console.error("Error en la petición AJAX:", error);
        }
    });
}

function removeProducto(idItem){
	var params = {};
	params["idItemCesta"] = idItem;
	$.ajax({
		url : "/GestPlus/removeProdCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal("", "Error: " + errorMessage, "warning");
			}else{
				var s = data.productos;
				productosCarrito = data.productos;
					
				window.location.href= "okeymasTiendaCarrito.html";
			}
		},
		dataType : "json"
	});
}

function fn_recalcularMas(idItem, precio,pos,item){
	let numero = Number.parseInt(item.parent().parent().find("input[name='contador']").val());  
    item.parent().parent().find("input[name='contador']").val(numero + 1);
	
	 cantidad += 1; 
	 $("#cantidadCarrito").val("Carrito (" + cantidad + ")");   
	 precioTotal += precio;
	 $("#idTotal").val(precioTotal.toFixed(2) + txtIva); 
	 
	 // hay que actualizar el campo prodSelect[idItem].cantidad = numero+1;
	 listCarrito[pos].cantidad = numero+1;
	 //fn_clonar(); 
}

function fn_recalcularMenos(idItem, precio, pos,item){
	 let numero = Number.parseInt(item.parent().parent().find("input[name='contador']").val());
     if(numero>1){ // así evitamos los negativos y el 0
     	item.parent().parent().find("input[name='contador']").val(numero - 1);	
     	cantidad -= 1; 
		$("#cantidadCarrito").val("Carrito (" + cantidad + ")");   
		 precioTotal -= precio;
		 $("#idTotal").val(precioTotal.toFixed(2) + txtIva); 
		 listCarrito[pos].cantidad = numero-1;
		 //fn_clonar();  
     }
}

async function fn_checkStock(idProduct, idVariant, idProveedor, quantity) {
	try{
		console.log("--------------- fn_checkStock()-----------------");
		 var product = await fn_getProductById(idProduct, idVariant, idProveedor);
		 
		 if(!product || typeof product.stock === "undefined"){
			 console.log("El producto no se encuentra disponible");
			 return false;
		 }
		 
		 if(product.stock < quantity){
			 console.log("No hay suficiente stock del producto seleccionado");
			 return false;
		 }
		 
	}catch(error) {
		console.log("Ha ocurrido un error durante la solicitud: " + error);
		swal("No se ha podido procesar la solicitud, intentelo más tarde");
		return false;
	}
	console.log("Hay stock del producto " + idProduct);
	 return true;
}

/*function fn_addProd(){
	var cantSelec = document.getElementById('idSpanCantidad').innerText;
	console.log("Cantidad seleccionada: " + cantSelec);
	var stockDisp = document.getElementById('idStockProd').innerText;
	
	if(stockDisp.equals('0')){
		swal("No hay stock.");
	}else if(parseInt(stockDisp) < parseInt(cantSelec)){
		swal("No hay stock suficiente para la cantidad elegida.");
	}else{
		fn_addCarrito(idProducto, idProdVariant, elProv, cantSelec);
	}
}*/

function fn_addProd(){
	console.log("--------------- fn_addProd()-----------------");
	var cantSelec = document.getElementById('idSpanCantidad').innerText;
	var stockDisp = document.getElementById('idStockProd').innerText;
	
	if(stockDisp.equals('0')){
		swal("No hay stock.");
	}else if(parseInt(stockDisp) < parseInt(cantSelec)){
		swal("No hay stock suficiente para la cantidad elegida.");
	}else{
		/**
		*
		* idProducto, idProdVariant, elProv, cantSelec son variables globales, cuyos valores
		* han sido extraidos del codigo HTML
		*
		*/
		fn_addCarrito(idProducto, idProdVariant, elProv, cantSelec);
	}
}

function fn_learnMore(idProduct,prodVariant,idProveedor){
// 	Jim - https://gestplus.okmas.net/GestPlus/findVariantByProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=1
// 	Hyper - https://gestplus.okmas.net/GestPlus/findVariantByHyperProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=2
// 	Natur - https://gestplus.okmas.net/GestPlus/findVariantByNaturProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=3
		
	console.log("Encontrado producto: " + idProduct + ", " + prodVariant + ", " + idProveedor);
		
	var params = {};
	params["jim_id"] = idProduct;
	params["idProveedor"]=idProveedor;
	switch (idProveedor) {
	case 1: // jim sport
		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+idProduct+"&idProveedor=1";
		break;
	case 2: // hypertrophy
		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+idProduct+"&idProveedor=2";
		break;
	case 3: // naturatal
		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+idProduct+"&idProveedor=3";
		break;
	default:
		break;
	}
}

function fn_findVariant(idProduct,prodVariant,idProveedor){

	var params = {};
	switch (idProveedor) {
	case 1: // jim sport
		params["jim_id"] = idProduct;
		$.ajax({
			url : "/GestPlus/findVariantByProductOld",
			type : "POST",
			data : params,
			// myDataTable migth not exist
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal("", "Error: " + errorMessage, "warning");
				}else{
					fn_learnMore(idProduct,prodVariant,idProveedor);
					/*if(data.totalRecords <= 1){ 
						fn_addCarrito(idProduct, prodVariant, idProveedor, 1);
					}else{
						fn_learnMore(idProduct,prodVariant,idProveedor);
					}*/
				}
			},
			dataType : "json"
		});
		break;
	case 2: // hypertrophy
		params["idProduct"] = idProduct;	
		$.ajax({
			url : "/GestPlus/findVariantByHyperProductOld",
			type : "POST",
			data : params,
			// myDataTable migth not exist
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal("", "Error: " + errorMessage, "warning");
				}else{
					fn_learnMore(idProduct,prodVariant,idProveedor);
					/*if(data.totalRecords <= 1){ 
						fn_addCarrito(idProduct,prodVariant,idProveedor,1);
					}else{
						fn_learnMore(idProduct,prodVariant,idProveedor);
					}*/
				}
			},
			dataType : "json"
		});
		break;
	case 3: // naturatal
		params["idProduct"] = idProduct;		
		$.ajax({
			url : "/GestPlus/findVariantByNaturProductOld",
			type : "POST",
			data : params,
			// myDataTable migth not exist
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal("", "Error: " + errorMessage, "warning");
				}else{
					
					fn_learnMore(idProduct, prodVariant, idProveedor);
					/*if(data.totalRecords <= 1){ 
						fn_addCarrito(idProduct, prodVariant, idProveedor, 1);
					}else{
						fn_learnMore(idProduct,prodVariant,idProveedor);
					}*/
				}
			},
			dataType : "json"
		});
		break;
	default:
		break;
	}
}

/*
function fn_updateCarrito(prod,cant){
	console.log("updateee");
	var params = {};
	params["idItemCesta"] = prod;
	params["cantidad"] = cant;
	$.ajax({
		url : "/GestPlus/updateCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal("", "Error: " + errorMessage, "warning");
			}else{
				var s = data.productos;
				productosCarrito = data.productos;
				window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaCarrito";
			}
		},
		dataType : "json"
	});
}*/


function fn_actualizarVblesGlobales(){
	precioTotal = '0'; // sin el IVA
	precioTotal = parseFloat(precioTotal);
	numProdCarrito = '0';
	if(numProdCarrito != null){
		if(!numProdCarrito.equals(""))
			numProdCarrito = parseInt(numProdCarrito); 
		else{
			numProdCarrito = 0; 
		}
	}
	console.log("precioTotal: " + precioTotal);
	console.log("numProdCarrito:  " + numProdCarrito);   
}

/*function fn_actualizarCarrito(){
 	var subT = 0;
	// Obtener todas las filas del tbody
	const filas = document.querySelectorAll('#idTablaCarrito tbody tr');
	
	filas.forEach((fila, i) => {
		  // Obtener todas las celdas de la fila
		  var p = fila.querySelector("#idProductoCarrito").innerText;
		  var c = fila.querySelector("#idCantidadCarrito").innerText;
		  //actualizo el total de esa fila:
		  fila.querySelector("#idTotalProductoCarrito").innerText = c * fila.querySelector("#idPriceCarrito").innerText;
		  //actualizo el subtotal:
		  subT += parseFloat(fila.querySelector("#idTotalProductoCarrito").innerText);
		  //falta actualizar la variable de sesión "productos" en el action
		  fn_updateCarrito(p,c);
	});
	//document.getElementById('idSubTotal').innerHTML = subT.toFixed(2);
	//document.getElementById('idTotalPagar').innerHTML = subT+5;
}*/

async function fn_actualizarCarrito(){
	console.log("--------------- fn_actualizarCarrito()-----------------");
	
	if( window.location.href.includes("okeymasTiendaCarrito") ) {
		console.log("Actualizando vista okeymasTiendaCarrito...");
		var subT = 0;
		// Obtener todas las filas del tbody
		const filas = document.querySelectorAll('#idTablaCarrito tbody tr');
		
		   for (const fila of filas) {
		        // Obtener todas las celdas de la fila
		        var idProduct = fila.querySelector("#idProductoCarrito").innerText;
		        var idVariant = fila.querySelector("#idVariantCarrito").innerText;
		        var idProveedor = fila.querySelector("#idProvCarrito").innerText;
		        var productQuantity = fila.querySelector("#idCantidadCarrito").innerText;
		        
		        try {
		            // Esperar la respuesta de fn_checkStock
		            var response = await fn_checkStock(idProduct, idVariant, idProveedor, productQuantity);
		            if (response) {
		                // Actualizo el total de esa fila:
		                fila.querySelector("#idTotalProductoCarrito").innerText = productQuantity * parseFloat(fila.querySelector("#idPriceCarrito").innerText);
		                
		                // Actualizo el subtotal:
		                subT += parseFloat(fila.querySelector("#idTotalProductoCarrito").innerText);
		                
		                // Faltaría actualizar la variable de sesión "productos" en el action
		                fn_updateCarrito(idProduct, productQuantity);
		            } else {
		                console.log("Stock insuficiente");
		            }
		        } catch (error) {
		            console.log("Ha ocurrido un error procesando la solicitud, por favor intentalo más tarde");
		        }
		    }
		   	
			document.getElementById('idSubTotal').innerHTML = subT.toFixed(2);
			document.getElementById('idTotalPagar').innerHTML = subT+5;
			location.reload();
	}else{
		console.log(" El cliente no esta situado en la ventana okeymastiendacarrito. ");
	}
}



/*function fn_addCarrito(idP,idV,idProveedor,quantity){
	//aquí ya hay q guardar en la sesión los productos de la cesta
	
	cantidad = 0; 
	//$(window).scrollTop(0);  // para volver al inicio de la página  
	if(idP == null && idV == null) {  
		cantidad += quantity; 
		var prodSelect = null; 
		prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 
		if(prodSelect != null){
			listCarrito.add(prodSelect[0]);   
			//session.setAttribute("listaCarrito",listCarrito);
			$('#idCesta').append("<div class='cart-entry clearfix' id="+ prodSelect[0].id +">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+prodSelect[0].nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+prodSelect[0].price+"</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
			//$('#idCestaProd').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+prodSelect[0].nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+prodSelect[0].price+"</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>     <td>      <div class='button-close'></div>     </td>    </tr>   </table>  </div> </div>");
			numProdCarrito += quantity;
			document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
			document.getElementById('idCircleCarrito').innerHTML = numProdCarrito;
			precioTotal += prodSelect[0].price;
			document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
			document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
			fn_saveCarrito();
		} 
	}else{ 
		var params = {};
		switch (idProveedor) {
		case '1': // JIMSPORT
		case 1: // JIMSPORT
			params["jim_id"] = idP;
			params["idVariant"] = idV;
			$.ajax({
				url : "/GestPlus/findVariantProduct",
				type : "POST",
				data : params,
				// myDataTable migth not exist
				success : function(data, textStatus) {
					var errorMessage = data.error;
					if (typeof (errorMessage) !== "undefined"
							&& errorMessage !== null && errorMessage !== '') {
						swal("", "Error: " + errorMessage, "warning");
					}else{
						listCarrito.add(data.variantProduct); 
						cantidad += quantity; 
						var t = cantidad * data.variantProduct.price;
						precioTotal += t;
						$('#idCesta').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src="+data.variantProduct.image+" alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+data.variantProduct.nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+data.variantProduct.price+"</div>      <div class='simple-article size-1'>TOTAL: "+t.toFixed(2)+"</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>   </tr>   </table>  </div> </div>");
						
						numProdCarrito += cantidad;
						document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
						document.getElementById('idCircleCarrito').innerHTML = numProdCarrito;
						document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
						document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
						fn_saveCarrito();
					}
				},
				dataType : "json"
			});
			break;
		case '2': // HYPERTROPHY
		case 2: // HYPERTROPHY
			params["idProduct"] = idP;
			params["idVariant"] = idV;
			$.ajax({
				url : "/GestPlus/findHyperVariantProduct",
				type : "POST",
				data : params,
				// myDataTable migth not exist
				success : function(data, textStatus) {
					var errorMessage = data.error;
					if (typeof (errorMessage) !== "undefined"
							&& errorMessage !== null && errorMessage !== '') {
						swal("", "Error: " + errorMessage, "warning");
					}else{
						cantidad += quantity; 
						listCarrito.add(data.variantProduct); 
						var t = cantidad * data.variantProduct.price;
						precioTotal += t;
						$('#idCesta').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src="+data.variantProduct.imageData+" alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+data.variantProduct.nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+data.variantProduct.price+"</div>      <div class='simple-article size-1'>TOTAL: "+t.toFixed(2)+"</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>   </tr>   </table>  </div> </div>");
						//$('#idCestaProd').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src="+data.variantProduct.imageData+" alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+data.variantProduct.nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+data.variantProduct.price+"</div>      <div class='simple-article size-1'>TOTAL: "+t+"</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>     <td>      <div class='button-close'></div>     </td>    </tr>   </table>  </div> </div>");
						numProdCarrito += cantidad;
						document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
						document.getElementById('idCircleCarrito').innerHTML = numProdCarrito;
						document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
						document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
						fn_saveCarrito();
					}
				},
				dataType : "json"
			});
			break;
			case '3': // NATURATAL
			case 3: // NATURATAL
				params["idProduct"] = idP;
				$.ajax({
					url : "/GestPlus/findNaturProductById",
					type : "POST",
					data : params,
					// myDataTable migth not exist
					success : function(data, textStatus) {
						var errorMessage = data.error;
						if (typeof (errorMessage) !== "undefined"
								&& errorMessage !== null && errorMessage !== '') {
							swal("", "Error: " + errorMessage, "warning");
						}else{
							cantidad += quantity; 
							listCarrito.add(data.infoProduct); 							
							var t = cantidad * data.infoProduct.price;
							precioTotal += t;
							$('#idCesta').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src="+data.infoProduct.image+" alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+data.infoProduct.nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+data.infoProduct.price+"</div>      <div class='simple-article size-1'>TOTAL: "+t.toFixed(2)+"</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>   </tr>   </table>  </div> </div>");
							numProdCarrito += cantidad;
							document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
							document.getElementById('idCircleCarrito').innerHTML = numProdCarrito;
							document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
							document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
							fn_saveCarrito();
						}
					},
					dataType : "json"
				});
				break;
		default:
			break;
		}
	}
}*/

function fn_getTotalProductsInCart(cartProducts){
	console.log("--------------- fn_getTotalProductsInCart()-----------------");
	 var totalProducts = 0;
	 console.log(cartProducts);
	 if( cartProducts ){
		 cartProducts.forEach((cartProduct) => {
			 totalProducts += parseInt(cartProduct.quantity);
		 });
	 }

	 return totalProducts;
}

function fn_getProductById(idP, idV, idProveedor){
	console.log("--------------- fn_getProductById()-----------------");
	 return new Promise((resolve, reject) => {
	        var params = {};
	        var actionURL = null;

	        switch(idProveedor) {
	            case '1': case 1:  /* JimSport */
	                params["jim_id"] = idP;
	                params["idVariant"] = idV;
	                actionURL = "findVariantProduct.json";
	                break;

	            case '2': case 2: /* HyperTrophy */
	                params["idProduct"] = idP;
	                params["idVariant"] = idV;
	                actionURL = "findHyperVariantProduct.json";
	                break;

	            case '3': case 3: /* Naturatal */
	                params["idProduct"] = idP;
	                actionURL = "findNaturProductById.json";
	                break;

	            default:
	                console.log("El producto seleccionado no pertenece a ningun proveedor - Pongase en contacto con el administrador de la web.");
	                break;
	        }

	        $.ajax({
	            url: "/GestPlus/" + actionURL + "",
	            type: "POST",
	            data: params,
	            success: function(data, textStatus) {
	                var errorMessage = data.error;
	                if (typeof (errorMessage) !== "undefined" && errorMessage !== null && errorMessage !== '') {
	                    swal("Error: " + errorMessage, "warning");
	                    reject(new Error(errorMessage));
	                } else {
	                	product = data.variantProduct;
	                    console.log(product);
	                    if (idProveedor == 3) { 
	                        product = data.infoProduct; 
	                        console.log("El producto es de naturatal" + data.infoProduct);
	                    }
	                    resolve(product);
	                }
	            },
	            dataType: "json"
	        });
		 
	 });
}

/*async function fn_addCarrito(idP, idV, idProveedor, quantity) {
    //TASK: aquí ya hay que guardar en la sesión los productos de la cesta
    listCarrito = [];
    cantidad = 0;
    quantity = parseInt(quantity);

    const cartProducts = await traerProdSesion();

    if (idP == null && idV == null) {  
        cantidad += quantity; 
        var prodSelect = null; 
        prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 

        if (prodSelect != null) {
            listCarrito.add(prodSelect[0]);
            $('#idCesta').append("<div class='cart-entry clearfix' id=" + prodSelect[0].id + ">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>" + prodSelect[0].nameEs + "</a></div>      <div class='simple-article size-1'>CANTIDAD: " + cantidad + "</div>     </td>     <td>      <div class='simple-article size-3 grey'>" + prodSelect[0].price + "</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
            numProdCarrito += quantity;
            document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
            precioTotal += prodSelect[0].price;
            document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
            document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
            fn_saveCarrito();
        }
    } else { 
        try{
      	  var product = await fn_getProductById(idP, idV, idProveedor);
            
            if( product ) {
                var productSession = null;
                cantidad += quantity;
     

                if (cartProducts) {
                    cartProducts.forEach(function(e) { 
                        console.log("Elemento de cartProducts: " + e.nameEs + ", idProveedor = " + e.idProveedor + ", idProducto = " + e.product_id + ", variante = " + e.variant_id);
                    });
                    productSession = cartProducts.find((p) => (p.idProveedor == idProveedor && p.product_id == idP && p.variant_id == idV));
                }

                if (productSession == null) {
                    console.log("El producto no existe, añadimos con cantidad 1, y el valor de isNewProduct = " + productSession);
                    product.quantity = quantity;
                } else {
                    product.quantity = (parseInt(productSession.quantity) + cantidad);
                    console.log("Producto " + product.nameEs + ", cantidad: " + product.quantity + "stock: " + product.stock);
                }
                
                if (document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito')) document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito').innerHTML = totalPorProducto;
                if (document.getElementById('idStockProd')) document.getElementById('idStockProd').innerHTML = product.stock;
                if (document.getElementById('cantidadCarrito')) document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
                if (document.getElementById('idTotal')) document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
                if (document.getElementById('totalConIva')) document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;

                fn_saveCarrito();
            } else {
                swal("No hay Stock del producto. ");
            }
            
      }catch(error) {
    	  	console.log("Ha ocurrido un error durante la solicitud: " + error);
  			alert("No se ha podido procesar la solicitud, intentelo más tarde");
      }
    }
}*/

async function fn_addCarrito(idP, idV, idProveedor, quantity) {
	console.log("--------------- fn_addCarrito()-----------------");
    //TASK: aquí ya hay que guardar en la sesión los productos de la cesta
    listCarrito = [];
    cantidad = 0;
    quantity = parseInt(quantity);

    const cartProducts = await traerProdSesion();

    if (idP == null && idV == null) {  
        cantidad += quantity; 
        var prodSelect = null; 
        prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 

        if (prodSelect != null) {
            listCarrito.add(prodSelect[0]);
            $('#idCesta').append("<div class='cart-entry clearfix' id=" + prodSelect[0].id + ">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>" + prodSelect[0].nameEs + "</a></div>      <div class='simple-article size-1'>CANTIDAD: " + cantidad + "</div>     </td>     <td>      <div class='simple-article size-3 grey'>" + prodSelect[0].price + "</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
            numProdCarrito += quantity;
            document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
            precioTotal += prodSelect[0].price;
            document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
            document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
            fn_saveCarrito();
        }
    } else { 
        try{
      	  var product = await fn_getProductById(idP, idV, idProveedor);
            
            if( product ) {
                var productSession = null;
                cantidad += quantity;
     

                if (cartProducts) {
                    cartProducts.forEach(function(e) { 
                        console.log("Elemento de cartProducts: " + e.nameEs + ", idProveedor = " + e.idProveedor + ", idProducto = " + e.product_id + ", variante = " + e.variant_id);
                    });
                    productSession = cartProducts.find((p) => (p.idProveedor == idProveedor && p.product_id == idP && p.variant_id == idV));
                }

                if (productSession == null) {
                    console.log("El producto no existe, añadimos con cantidad 1, y el valor de isNewProduct = " + productSession);
                    product.quantity = quantity;
                } else {
                    product.quantity = (parseInt(productSession.quantity) + cantidad);
                    console.log("Producto " + product.nameEs + ", cantidad: " + product.quantity + "stock: " + product.stock);
                }
                
                var  response = await fn_checkStock(idP, idV, idProveedor, parseInt(product.quantity));
                if( response === true ) {
                	product.stock = parseInt(product.stock) - parseInt(product.quantity);
                    listCarrito.add(product);

                    precioTotal += product.price;
                    var totalPorProducto = product.quantity * product.price;

                    if ($('#idCesta').find('#' + idP + idV + idProveedor).length) {
                        $('#idCesta').find('#' + idP + idV + idProveedor).remove();
                    }

                    $('#idCesta').append(
                        "<div id=\"" + idP + idV + idProveedor + "\" class='cart-entry clearfix'>"
                        + " <a style='width: 15%;' class='cart-entry-thumbnail' href='#'>"
                        + "<img src='" + product.imageData + "' alt='' />"
                        + "</a>"
                        + " <div class='cart-entry-description'>"
                        + "   <table>"
                        + "     <tr>"
                        + "       <td>"
                        + "         <div class='h6'>"
                        + "           <a href='#'>" + product.nameEs + "</a>"
                        + "         </div>"
                        + "         <div class='simple-article size-1'>CANTIDAD: <div id='" + idP + idV + idProveedor + "'>" + product.quantity + "</div></div>"
                        + "       </td>"
                        + "       <td>"
                        + "         <div class='simple-article size-3 grey'>" + product.price + "</div>"
                        + "         <div class='simple-article size-1'>TOTAL: " + totalPorProducto + "</div>"
                        + "       </td>"
                        + "       <td>"
                        + "         <div class='cart-color' style='background: #facc22;'></div>"
                        + "       </td>"
                        + "       <td>"
                        + "        </div>"
                        + "       </td>"
                        + "     </tr>"
                        + "   </table>"
                        + " </div>"
                        + "</div>"
                    );

                    if( productSession ) { 
                    	numProdCarrito = fn_getTotalProductsInCart( cartProducts ) + quantity;
                    }else{
                    	numProdCarrito += cantidad;
                    }
                    
                    if (document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito')) document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito').innerHTML = totalPorProducto;
                    if (document.getElementById('idStockProd')) document.getElementById('idStockProd').innerHTML = product.stock;
                    if (document.getElementById('cantidadCarrito')) document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
                    if (document.getElementById('idTotal')) document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
                    if (document.getElementById('totalConIva')) document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
					
                    fn_saveCarrito();
                } else {
                    swal("No hay Stock del producto. ");
                }
                fn_actualizarCarrito();
            }
            
      }catch(error) {
    	  	console.log("Ha ocurrido un error durante la solicitud: " + error);
  			swal("No se ha podido procesar la solicitud, intentelo más tarde");
      }
    }
}

/*async function fn_removeCarrito(idP, idV, idProveedor, quantity) {
	    //TASK: aquí ya hay que guardar en la sesión los productos de la cesta
	    listCarrito = [];
	    cantidad = 0;
	    quantity = parseInt(quantity);
	    const cartProducts = await traerProdSesion();

	    if (idP == null && idV == null) {  
	        cantidad += quantity; 
	        var prodSelect = null; 
	        prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 

	        if (prodSelect != null) {
	            listCarrito.add(prodSelect[0]);
	            $('#idCesta').append("<div class='cart-entry clearfix' id=" + prodSelect[0].id + ">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>" + prodSelect[0].nameEs + "</a></div>      <div class='simple-article size-1'>CANTIDAD: " + cantidad + "</div>     </td>     <td>      <div class='simple-article size-3 grey'>" + prodSelect[0].price + "</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
	            numProdCarrito += quantity;
	            document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
	            precioTotal += prodSelect[0].price;
	            document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
	            document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
	            fn_saveCarrito();
	        }
	    } else { 
	        var product = await fn_getProductById(idP, idV, idProveedor);
	        
	        if( product ) {
	            var productSession = null;
	            cantidad += quantity;
	            console.log(product);

	            if (cartProducts) {
	                cartProducts.forEach(function(e) { 
	                    console.log("Elemento de cartProducts: " + e.nameEs + ", idProveedor = " + e.idProveedor + ", idProducto = " + e.product_id + ", variante = " + e.variant_id);
	                });
	                productSession = cartProducts.find((p) => (p.idProveedor == idProveedor && p.product_id == idP && p.variant_id == idV));
	            }

	            if (productSession) {
	                product.quantity = (parseInt(productSession.quantity) - cantidad);
	                console.log("Producto " + product.nameEs + ", cantidad: " + product.quantity + "stock: " + product.stock);
	            }
	            product.stock = parseInt(product.stock) + cantidad;
	            
	            if( product.stock > 0 ) {
	                listCarrito.add(product);

	                precioTotal -= product.price;
	                var totalPorProducto = product.quantity * product.price;

	                if ($('#idCesta').find('#' + idP + idV + idProveedor).length) {
	                    $('#idCesta').find('#' + idP + idV + idProveedor).remove();
	                }

	                $('#idCesta').append(
	                    "<div id=\"" + idP + idV + + idProveedor + "\" class='cart-entry clearfix'>"
	                    + " <a style='width: 15%;' class='cart-entry-thumbnail' href='#'>"
	                    + "<img src='" + product.imageData + "' alt='' />"
	                    + "</a>"
	                    + " <div class='cart-entry-description'>"
	                    + "   <table>"
	                    + "     <tr>"
	                    + "       <td>"
	                    + "         <div class='h6'>"
	                    + "           <a href='#'>" + product.nameEs + "</a>"
	                    + "         </div>"
	                    + "         <div class='simple-article size-1'>CANTIDAD: <div id='" + idP + idV + idProveedor + "'>" + product.quantity + "</div></div>"
	                    + "       </td>"
	                    + "       <td>"
	                    + "         <div class='simple-article size-3 grey'>" + product.price + "</div>"
	                    + "         <div class='simple-article size-1'>TOTAL: " + totalPorProducto + "</div>"
	                    + "       </td>"
	                    + "       <td>"
	                    + "         <div class='cart-color' style='background: #facc22;'></div>"
	                    + "       </td>"
	                    + "       <td>"
	                    + "         <div class='button-close'></div>"
	                    + "       </td>"
	                    + "     </tr>"
	                    + "   </table>"
	                    + " </div>"
	                    + "</div>"
	                );

	               if( productSession ) { 
                	numProdCarrito = fn_getTotalProductsInCart( cartProducts ) - quantity;
                }else{
                	numProdCarrito += cantidad;
                }
	              
	             	if (document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito')) document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito').innerHTML = totalPorProducto;
	                if (document.getElementById('idStockProd')) document.getElementById('idStockProd').innerHTML = product.stock;
	                if (document.getElementById('cantidadCarrito')) document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
	                if (document.getElementById('idTotal')) document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
	                if (document.getElementById('totalConIva')) document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;

	                fn_saveCarrito();
	            } else {
	                swal("No hay Stock del producto. ");
	            }
	        }
	    }
}*/

async function fn_removeCarrito(idP, idV, idProveedor, quantity) {
	console.log("--------------- fn_removeCarrito()-----------------");
	    //TASK: aquí ya hay que guardar en la sesión los productos de la cesta
	    listCarrito = [];
	    cantidad = 0;
	    quantity = parseInt(quantity);
	    const cartProducts = await traerProdSesion();

	    if (idP == null && idV == null) {  
	        cantidad += quantity; 
	        var prodSelect = null; 
	        prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 

	        if (prodSelect != null) {
	            listCarrito.add(prodSelect[0]);
	            $('#idCesta').append("<div class='cart-entry clearfix' id=" + prodSelect[0].id + ">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>" + prodSelect[0].nameEs + "</a></div>      <div class='simple-article size-1'>CANTIDAD: " + cantidad + "</div>     </td>     <td>      <div class='simple-article size-3 grey'>" + prodSelect[0].price + "</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
	            numProdCarrito += quantity;
	            document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
	            precioTotal += prodSelect[0].price;
	            document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
	            document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
	            fn_saveCarrito();
	        }
	    } else {
	    	try{
	    		 var product = await fn_getProductById(idP, idV, idProveedor);
	 	        
	 	        if( product ) {
	 	            var productSession = null;
	 	            cantidad += quantity;
	 	            console.log(product);

	 	            if (cartProducts) {
	 	                cartProducts.forEach(function(e) { 
	 	                    console.log("Elemento de cartProducts: " + e.nameEs + ", idProveedor = " + e.idProveedor + ", idProducto = " + e.product_id + ", variante = " + e.variant_id);
	 	                });
	 	                productSession = cartProducts.find((p) => (p.idProveedor == idProveedor && p.product_id == idP && p.variant_id == idV));
	 	            }
					
	 	            if (productSession) {
	 	            	if(productSession.quantity > 1) {
	 	            		product.quantity = (parseInt(productSession.quantity) - cantidad);
		 	               	product.stock = parseInt(product.stock) + cantidad;

		 	                listCarrito.add(product);

		 	                precioTotal -= product.price;
		 	                var totalPorProducto = product.quantity * product.price;

		 	                if ($('#idCesta').find('#' + idP + idV + idProveedor).length) {
		 	                    $('#idCesta').find('#' + idP + idV + idProveedor).remove();
		 	                }

		 	                $('#idCesta').append(
		 	                    "<div id=\"" + idP + idV + + idProveedor + "\" class='cart-entry clearfix'>"
		 	                    + " <a style='width: 15%;' class='cart-entry-thumbnail' href='#'>"
		 	                    + "<img src='" + product.imageData + "' alt='' />"
		 	                    + "</a>"
		 	                    + " <div class='cart-entry-description'>"
		 	                    + "   <table>"
		 	                    + "     <tr>"
		 	                    + "       <td>"
		 	                    + "         <div class='h6'>"
		 	                    + "           <a href='#'>" + product.nameEs + "</a>"
		 	                    + "         </div>"
		 	                    + "         <div class='simple-article size-1'>CANTIDAD: <div id='" + idP + idV + idProveedor + "'>" + product.quantity + "</div></div>"
		 	                    + "       </td>"
		 	                    + "       <td>"
		 	                    + "         <div class='simple-article size-3 grey'>" + product.price + "</div>"
		 	                    + "         <div class='simple-article size-1'>TOTAL: " + totalPorProducto + "</div>"
		 	                    + "       </td>"
		 	                    + "       <td>"
		 	                    + "         <div class='cart-color' style='background: #facc22;'></div>"
		 	                    + "       </td>"
		 	                    + "       <td>"
		 	                    + "         </div>"
		 	                    + "       </td>"
		 	                    + "     </tr>"
		 	                    + "   </table>"
		 	                    + " </div>"
		 	                    + "</div>"
		 	                );

		 	               	if( productSession ) { 
		                 		numProdCarrito = fn_getTotalProductsInCart( cartProducts ) - quantity;
		                 	}else{
		                 		numProdCarrito += cantidad;
		                 	}
		 	              
		 	             	if (document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito')) document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito').innerHTML = totalPorProducto;
		 	                if (document.getElementById('idStockProd')) document.getElementById('idStockProd').innerHTML = product.stock;
		 	                if (document.getElementById('cantidadCarrito')) document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
		 	                if (document.getElementById('idTotal')) document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
		 	                if (document.getElementById('totalConIva')) document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;

		 	                fn_saveCarrito();
	 	            	}else{
	 	            		removeProducto(idP);
	 	            	}
	 	            	fn_actualizarCarrito();
	 	            }
	 	        }
	    	}catch{
	    		console.log("Ha ocurrido un error durante la solicitud: " + error);
	  			swal("No se ha podido procesar la solicitud, intentelo más tarde");
	    	} 
	    }
}

/****************************MIS PEDIDOS ****************************************/

function fn_misPedidos(){
	var params = {};
	params["idCliente"] = idCli;
	$.ajax({
		url : "/GestPlus/misPedidos",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal("Se ha producido un error: " + errorMessage);
			} else {
				data.misPedidos.forEach(item => {
					var fila = document.createElement("tr");
					
					var celdaId = document.createElement("td");
					celdaId.textContent = item.id;
					fila.appendChild(celdaId);

					var celdaProd = document.createElement("td");
					celdaProd.textContent = item.producto;
					fila.appendChild(celdaProd);

					var celdaRef = document.createElement("td");
					celdaRef.textContent = item.reference;
					fila.appendChild(celdaRef);

					var celdaFecha = document.createElement("td");
					celdaFecha.textContent = item.fechaCompra;
					fila.appendChild(celdaFecha);
					
					var celdaDev = document.createElement("td");
					if(item.devuelto){
						var celdaLabel = document.createElement("label");
						celdaLabel.textContent = 'Devuelto';
						celdaDev.appendChild(celdaLabel);
					}else{
						var celdaButton = document.createElement("button");
						celdaButton.textContent = 'Devolver';
						//celdaButton.classList.add(fn_devolver(item.id,item.producto));
						celdaButton.addEventListener("click", function() {
				            fn_devolver(item.id,item.producto); 
        				});
						celdaDev.appendChild(celdaButton); 
					}
					
					fila.appendChild(celdaDev);
					
					tablePedidos.appendChild(fila); 
				});
			}
		},
		dataType : "json" 
	});
}

function fn_devolver(idProdDev, nombreProducto){
	idProductoDevolver = idProdDev;
	idNombreProdDev.value = nombreProducto;
	document.getElementById('idDivMotivoDevol').style.display='block';
}

function fn_sendDevolucion(){ // le llega un correo a Pedro y él gestiona la devolución con el proveedor que corresponda
	var params = {};
	params["idProductoPedido"] = idProductoDevolver;
	params["idCliente"] = idCli;
	params["idMotivo"] = idM.value;
	params["observaciones"] = idObservaciones.value;
	
	$.ajax({
		url : "/GestPlus/sendDevolucion",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal("Se ha producido un error: " + errorMessage);
			} else {
				 swal("Producto devuelto con éxito.");
				 window.location.href= "okeymasTiendaMisPedidos.html";
			}
		},
		dataType : "json"
	});
}

function fn_showhidePolitica(){
	if(document.getElementById('politicaDevol').style.display == 'block'){
		document.getElementById('politicaDevol').style.display='none';
	}else{
		document.getElementById('politicaDevol').style.display='block';
	}
}

/***************************TODOS LOS PRODUCTOS****************************/

function traerProductosByProv(idProveedor){ 
	console.log("traerProductosByProv");
	document.getElementById("loader").classList.remove("hidden"); //mostrar el cargando
	switch (idProveedor) { 
	case 1: // JIM
	case '1': // JIM
		document.getElementById('idProvSelecAllProd').innerHTML = "MATERIAL DEPORTIVO";
		document.getElementById('idMenuProvSelec').innerHTML = "MATERIAL DEPORTIVO";
		if(allProductsJim == undefined){
			var allProductsJimPromise = $.getJSON("/GestPlus/findAllProducts", function(json) {
		        allProductsJim = json.listProductos;
		        
		        mostrar(0,xPag,idProveedor);
			    nPag = Math.ceil(allProductsJim.length / xPag);
			    $("#botones").empty();
			    mostrarPaginacion(nPag,allProductsJim,idProveedor); 
		    });
		}else{
	        mostrar(0,xPag,idProveedor);
		    nPag = Math.ceil(allProductsJim.length / xPag);
		    $("#botones").empty();
		    mostrarPaginacion(nPag,allProductsJim,idProveedor); 
		}
		break;
	case 2: // HYPER
	case '2':
		document.getElementById('idProvSelecAllProd').innerHTML = "SUPLEMENTACIÓN DEPORTIVA"; 
		document.getElementById('idMenuProvSelec').innerHTML = "SUPLEMENTACIÓN DEPORTIVA";
		if(allProductsHyper == undefined){
			var allProductsHyperPromise = $.getJSON("/GestPlus/findAllHyperProducts", function(json) {
				allProductsHyper = json.listProductos;
		        mostrar(0,xPag,idProveedor);
			    nPag = Math.ceil(allProductsHyper.length / xPag);
			    $("#botones").empty();
			    mostrarPaginacion(nPag,allProductsHyper,idProveedor); 
		    });
		}else{
			 mostrar(0, xPag, idProveedor);
             nPag = Math.ceil(allProductsHyper.length / xPag);
             $("#botones").empty();
             mostrarPaginacion(nPag, allProductsHyper, idProveedor);
		}
        break;
	     
	case 3: // NATUR 
	case '3':
		document.getElementById('idProvSelecAllProd').innerHTML = "PRODUCTOS NATURALES";
		document.getElementById('idMenuProvSelec').innerHTML = "PRODUCTOS NATURALES";
		
		if(allProductsNatur == undefined){
			var allProductsNaturPromise = $.getJSON("/GestPlus/findAllNaturProducts", function(json) {
		        allProductsNatur = json.listProductos;
		        mostrar(0,xPag,idProveedor);
			    nPag = Math.ceil(allProductsNatur.length / xPag);
			    $("#botones").empty();
			    mostrarPaginacion(nPag,allProductsNatur,idProveedor); 
		    });
		}else{ // para no volver a llamar al action
			mostrar(0,xPag,idProveedor);
		    nPag = Math.ceil(allProductsNatur.length / xPag);
		    $("#botones").empty();
		    mostrarPaginacion(nPag,allProductsNatur,idProveedor); 
		}
		break;
	default:
		break;
	} 
	
	$.when(allProductsJimPromise, allProductsHyperPromise, allProductsNaturPromise).done(function() {
		document.getElementById("loader").classList.add("hidden"); //para quitar el cargando
    });
}


/*function mostrarPaginacion(t,prods,idProveedor){
    var botones = '';
    for(var i = 0; i < t; i++){
        var cada = '';
        cada = "<a class='pagination'>"+(i+1)+"</a>";
        botones += cada; 
    }
    $('#botones').append(botones);
 	  // Poner oyentes a cada botón
    var losBotones = document.querySelectorAll('#botones a');
    for(var i = 0; i < losBotones.length; i++){
        losBotones[i].addEventListener('click',function(){
       	 	quitarActivo(); 
            var indice = parseInt(this.textContent);
            var o = (indice -1) * xPag;
            var h = indice * xPag;
            mostrar(o,h,idProveedor);
            mostrarPaginacion(t,prods,idProveedor);
            $(this).addClass('active');  //para que el botón se vea resaltado
            //$(window).scrollTop(0);  // para volver al inicio de la página  
        });
    } 
}*/

function mostrarPaginacion(t,prods,idProveedor){
	console.log("Se esta llamando a mostrar Paginacion");
	mostrarBotones(t, prods, idProveedor);
	
	/*var botones = '';
    for(var i = 0; i < t; i++){
        var cada = '';
        cada = "<a class='pagination'>"+(i+1)+"</a>";
        botones += cada; 
    }
    $('#botones').append(botones);
 	  // Poner oyentes a cada botón
    var losBotones = document.querySelectorAll('#botones a');
    for(var i = 0; i < losBotones.length; i++){
        losBotones[i].addEventListener('click',function(){
       	 	quitarActivo(); 
            var indice = parseInt(this.textContent);
            var o = (indice -1) * xPag;
            var h = indice * xPag;
            mostrar(o,h,idProveedor);
            mostrarPaginacion(t,prods,idProveedor);
            $(this).addClass('active');  //para que el botón se vea resaltado
            //$(window).scrollTop(0);  // para volver al inicio de la página  
        });
    } */
}

function mostrar(desde,hasta,idProveedor){ // cuando filtramos por proveedor en la pantalla de allProducts
	listFilter = new Array();
	switch (idProveedor) {
	case 1:
	case '1':
		listFilter = allProductsJim;
		totales = listFilter.length;
		break;
	case 2:
	case '2':
		listFilter = allProductsHyper;
		totales = listFilter.length;
		break;
	case 3:
	case '3': 
		listFilter = allProductsNatur;
		totales = listFilter.length;
		break;
	default:
		break;
	}
		
	$("#idContentAllProducts").empty();
	
	var h = hasta;
	if(hasta>totales){
		h=totales;
	}   
	
    
    for(var i = desde; i < h; i++){    
		if(listFilter[i].idProveedor == 1){ // si es Jimsport la imagen no está en base64

			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=1'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",1)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span> <span class='glyphicon glyphicon-euro color'></span></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].descripcion+"</div>   </div> </div> </div>");			
		}else if(listFilter[i].idProveedor == 2){ // si es Hypertrophy la imagen SI está en base64
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+listFilter[i].idProduct+"&idProveedor=2'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",2)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span> <span class='glyphicon glyphicon-euro color'></span></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].nameEs+"</div>   </div> </div> </div>");
		}else if(listFilter[i].idProveedor == 3){ // si es Naturatal
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+listFilter[i].idProduct+"&idProveedor=3'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",3)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span> <span class='glyphicon glyphicon-euro color'></span></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].descripcion+"</div>   </div> </div> </div>");

		}
    }
}

/***************************CARGAR PRODUCTOS****************************/

//para los productos de Hypertrophy
/*var fetchCompressedJson = async function () {
    try {
        // Solicitar los datos
        const response = await fetch('findAllHyperProducts');

        // Leer directamente el JSON sin descomprimir
        const jsonData = await response.json();
        
        return jsonData; // Devolver los datos
    } catch (error) {
        console.error("Error al obtener el JSON:", error);
        return null; // Manejo del error
    }
};*/


function traerProductos(pagina, filtro){ 
	console.log("traerProductos");
	console.log("1: " + new Date());
	console.log("FILTRO:  " + filtro);
	document.getElementById("loader").classList.remove("hidden");//mostrar el cargando
	//window.addEventListener("load", function() {
		// Llamadas AJAX con promesas 
	    var allProductsJimPromise = $.getJSON("/GestPlus/findAllProducts", function(json) {
	        allProductsJim = json.listProductos;
	        //document.getElementById('idCargarJim').click(); // aquí no porque sino no funciona la página de allProducts
	    }); 
	
	    var allProductsNaturPromise = $.getJSON("/GestPlus/findAllNaturProducts", function(json) {
	        allProductsNatur = json.listProductos;
	    });
	    
	    var allProductsHyperPromise = $.getJSON("/GestPlus/findAllHyperProducts", function(json) {
	    	allProductsHyper = json.listProductos;
	    });  
	
	    
	    // Llamada a la función y asignación del resultado
	   //var allProductsHyperPromise = (async () => { allProductsHyper = await fetchCompressedJson();   })();
	    
	    /*var allProductsHyperPromise = $.Deferred(function(defer) {
            fetchCompressedJson().then(function(data) {
                allProductsHyper = data;
                defer.resolve(); // Resolver la promesa Deferred
            }).catch(function(error) {
                defer.reject();
            });
        }).promise();*/   
	
	    // Usar $.when para asegurarte de que todas las llamadas AJAX terminen antes de ejecutar mostrarListaTodos  
	    $.when(allProductsJimPromise, allProductsHyperPromise, allProductsNaturPromise).done(function() {
	        //mostrarListaTodos();  // Se ejecuta solo después de que todas las llamadas AJAX hayan finalizado  
	        console.log("2: " + new Date());  
		    mostrarListaTodos(0,xPag);
		    allProducts = allProductsJim.concat(allProductsHyper).concat(allProductsNatur);	//concateno las listas de todos los proveedores 
		    nPag = Math.ceil(allProducts.length / xPag);
		    mostrarBotones(nPag,allProducts); 
		    document.getElementById("loader").classList.add("hidden"); 
		    
		    if(pagina==0){
		    	document.getElementById('idCargarJim').click();
		    } 
		    if(filtro != null && filtro != '' ){
		    	busqueda(filtro);
		    }
	    });
	//});  
}

function cargarAllProductos(pagina, filtro){ 
	    var allProductsJimPromise = $.getJSON("/GestPlus/findAllProducts", function(json) {
	        allProductsJim = json.listProductos;
	    }); 
	
	    var allProductsNaturPromise = $.getJSON("/GestPlus/findAllNaturProducts", function(json) {
	        allProductsNatur = json.listProductos;
	    });
	    
	    var allProductsHyperPromise = $.getJSON("/GestPlus/findAllHyperProducts", function(json) {
	    	allProductsHyper = json.listProductos;
	    });  
		 return $.when(allProductsJimPromise, allProductsHyperPromise, allProductsNaturPromise).done(function() {
	      
		    allProducts = allProductsJim.concat(allProductsHyper).concat(allProductsNatur);	//concateno las listas de todos los proveedores 
		    
	    }); 
}


function cargarProductosByProv(idProveedor){ // no se puede usar este en allProducts porque no existen los elementos idCargarJim, idCargarHyper...
	switch (idProveedor) { 
	case 0: // todos los proveedores
		break;
	case 1: // JIM
		listFilter = allProductsJim;	
		document.getElementById('idCargarJim').click(); //para habilitar esa parte y sea visible
	break;
	case 2: // HYPER
		listFilter = allProductsHyper;	
		document.getElementById('idCargarHyper').click();
	break;
	case 3: // NATUR
		listFilter = allProductsNatur;	
		document.getElementById('idCargarNatur').click();
	break;
	default:
		break;
	}
	totales = listFilter.length;  
    nPag = Math.ceil(totales / xPag);
    offset = (pag - 1) * xPag;
    hasta = pag * xPag;
	mostrarLista(0,hasta, listFilter,totales);
	
}

/********************************************BÚSQUEDA********************************************/

function busqueda(filter){ //debe buscar en todos los proveedores 
	
	
	if(filter == null) filter = "Buscar...";
	if(txtFilterBase.value == ''){
		txtFilterBase.value = filter;
	}
	//console.log("buscar: " + txtFilterBase.value + ", filter value: " + filter);
	
	// Lee la frase del input
     var input = document.getElementById("txtFilterBase").value;
     
     // Separa la frase en palabras (elimina espacios adicionales)
     var words = input.split(/\s+/).filter(Boolean);
     console.log("Array de palabras:", words);
     
     
	
	//comprobar que las variables globales de los productos no sean null
	//porq hay pantallas donde esas variable están vacías
	
	if(allProductsJim == null || allProductsHyper == null || allProductsNatur == null){
		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProductos?filter="+txtFilterBase.value;
		return;
	}
	
	allProducts = allProductsJim.concat(allProductsHyper).concat(allProductsNatur);	//concateno las listas de todos los proveedores 
	
	//listFilter = allProducts; 
	listFilter = []; 
	try{
		//if(txtFilterBase.value != "Buscar...") 
			
		words.forEach(function(word) {
			//listFilter = allProducts.filter((p) => (p.nameEs.includes(word) ||  p.nameEs.includes(word.toUpperCase()) ||  p.reference.includes(word) ||  p.reference.includes(word.toUpperCase()) || p.descripcion.includes(word) || p.descripcion.includes(word.toUpperCase()) )  );
			
			listFilter = listFilter.concat(allProducts.filter((p) => (
			  p.nameEs.includes(word) ||
			  p.nameEs.includes(word.toUpperCase()) ||
			  p.reference.includes(word) ||
			  p.reference.includes(word.toUpperCase()) ||
			  p.descripcion.includes(word) ||
			  p.descripcion.includes(word.toUpperCase())
			)));
		});
	}catch (e) {
		console.log(e);  
	}
	
	
	$("#contentFilterSearch").empty();
	$("#idContentAllProducts").empty(); 
	
	console.log("Tamaño de la lista de productos: " + listFilter.length);
	if(listFilter.length > 0){
		mostrarResultadoBusqueda(0,pag * xPag, listFilter,listFilter.length);  
		nPag = Math.ceil(listFilter.length / xPag);
	    offset = (pag - 1) * xPag;
	    hasta = pag * xPag;
		
	    mostrarBotones(nPag,listFilter, null);
	}
	
	if(document.getElementById('resultSearch') != null){
		document.getElementById('resultSearch').click();
	}
	
}

function normalizeText(text) {
    return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}

/**
 * Realiza una búsqueda de productos basada en palabras clave ingresadas por el usuario.
 * Aplica un sistema de ponderación para priorizar los resultados más relevantes.
 * 
 * Funcionalidad:
 * - Extrae palabras clave de la consulta eliminando palabras vacías (stopwords).
 * - Normaliza los textos para hacer comparaciones más precisas.
 * - Asigna diferentes pesos a las coincidencias en distintos campos (nombre, categoría, referencia y descripción).
 * - Aplica bonificaciones si todas las palabras clave están en el nombre o si hay coincidencias en la categoría.
 * - Ordena los resultados según el puntaje de relevancia y los muestra en la interfaz.
 * - Si no hay productos cargados en memoria, redirige a otra página para ejecutar la búsqueda allí.
 * 
 * @function busqueda
 * @returns {void}
 */
 
 
/*function busqueda() { 
    document.getElementById("loader").classList.remove("hidden");

    if (txtFilterBase.value == '') return;

    if (allProductsJim == null || allProductsHyper == null || allProductsNatur == null) {
        window.location.href = "https://gestplus.okmas.net/GestPlus/okeymasTiendaProductos?filter=" + txtFilterBase.value;
        return;
    }
    
    function extractKeywords(text) {
        const stopwords = new Set(["de", "la", "los", "el", "las", "y", "a", "en", "con", "por", "para", "del", "un", "una", "unos", "unas", "al"]);
        
        return text
            .split(/\s+/) // Dividir por espacios
            .filter(word => !stopwords.has(word)) // Filtrar palabras vacías
            .join(" "); // Volver a unir en una string limpia
    }
    var cleanedQuery = extractKeywords(normalizeText(txtFilterBase.value));
    console.log("keywords: " + cleanedQuery);

    var words = normalizeText(cleanedQuery).split(" "); // Separar palabras clave
    console.log(words);

    listFilter = allProducts
      .map((p) => {
        // Normalizar los textos de cada campo
        var nameText = normalizeText(p.nameEs);
        var categText = normalizeText(p.categ);
        var referenceText = normalizeText(p.reference);
        var descriptionText = normalizeText(p.descripcion);
        
        if(categText == "balones") categText = "balon";

        // Ajustamos los pesos de los campos
        var weights = {
          name: 5,        
          category: 2,    
          reference: 1.5, 
          description: 0.5 
        };

        // Asignar pesos decrecientes a las palabras según su posición
        var wordWeights = words.map((_, index) => {
          if (index === 0) return 2.0; 
          if (index === 1) return 1.5; 
          return 1.0; 
        });

        // Función para contar coincidencias exactas y aplicar ponderación
        var countMatches = (text, fieldWeight, wordWeight = 1.0) => {
          return words.reduce((total, word, index) => {
            var regex = new RegExp("\\b" + word + "\\b", "gi"); // Búsqueda exacta con regex
            var matches = text.match(regex);
            return total + (matches ? matches.length * fieldWeight * wordWeights[index] : 0);
          }, 0);
        };

        // Calcular el puntaje total ponderado
        var matchCount =
          countMatches(nameText, weights.name) +
          countMatches(categText, weights.category) +
          countMatches(referenceText, weights.reference) +
          countMatches(descriptionText, weights.description);

        //  Si todas las palabras están en el nombre, el producto se prioriza FUERTE
        if (words.every(word => nameText.includes(word))) {
          matchCount *= 2.0; 
        }

        //  Si todas las palabras están en el nombre Y la categoría es relevante, subimos un poco más
        if (words.every(word => nameText.includes(word)) && words.some(word => categText.includes(word))) {
          matchCount *= 1.3; 
        }

        // Si al menos una palabra está en la categoría, le damos un mini-bono
        if (words.some(word => categText.includes(word))) {
          matchCount *= 1.1; 
        }

        if (matchCount > 0)
          console.log("Para el producto " + p.nameEs + ", existen " + matchCount + " coincidencias ponderadas");

        return { product: p, matchCount };
      })
      .filter((item) => item.matchCount > 0) // Filtrar productos con al menos 1 coincidencia
      .sort((a, b) => b.matchCount - a.matchCount) // Ordenar de mayor a menor coincidencia
      .map((item) => item.product); // Extraer los productos


    $("#contentFilterSearch").empty();
    $("#idContentAllProducts").empty(); 

    if (listFilter.length > 0) {
        mostrarResultadoBusqueda(0, pag * xPag, listFilter, listFilter.length);  
        nPag = Math.ceil(listFilter.length / xPag);
        mostrarBotones(nPag, listFilter, null);
    }

    if (document.getElementById('resultSearch') != null) {
        document.getElementById('resultSearch').click();
    }

    document.getElementById("loader").classList.add("hidden");
}*/



 /**
  * Realiza una búsqueda de productos filtrando por una categoría específica.
  * 
  * Funcionalidad:
  * - Asigna el nombre de la categoría al campo de búsqueda (`txtFilterBase`).
  * - Llama a la función `busqueda()` para ejecutar la búsqueda con el nuevo filtro.
  * 
  * @function fn_busquedaCategoria
  * @param {string} productName - Nombre de la categoría a buscar.
  * @returns {void}
  */
function fn_busquedaCategoria(productName) {
	if(normalizeText(productName).trim().toLowerCase() === 'catalogo general') window.location.href = "okeymasTiendaProductos.html";
	
	txtFilterBase.value = productName;
	busqueda();
}


/******************************* INFO DE UNA VARIANTE EN CONCRETO *********************************/

function fn_mostrarVariante(){
	console.log(idListAtrib1.value);
	console.log(idListAtrib2.value);
	//cambiar el precio, la referencia, el stock y la imagen
	
	var params = {};
	params["atributo1"]   = idListAtrib1.value;
	params["atributo2"]   = idListAtrib2.value;
	params["idProveedor"] = elProv;
	params["idProduct"]   = idProducto;
	
	$.ajax({
		url : "/GestPlus/filterByAtributos",
		type : "POST",
		data : params,
		// myDataTable migth not exist  
		success : function(data, textStatus) {
			// Selecciona el elemento por su id
			var imagenProdDiv = document.getElementById("idImagenProd");

			switch (elProv) {
			case '1':
				if(data.productoJim != null){
					// Asigna una nueva URL de imagen
					//const nuevaImagenURL = data.productoJim.imageData;
					//imagenProdDiv.setAttribute("data-background", nuevaImagenURL);
					imagenProdDiv.setAttribute("data-background", data.productoJim.imageData);
					//swiper.lazy.load();
					
					
					document.getElementById('idPrecioProd').innerText = data.productoJim.price;
				    document.getElementById('idNombreProd').innerText = data.productoJim.nameEs;
				    document.getElementById('idProdSelect').innerText = data.productoJim.nameEs;
				    document.getElementById('idRefProd').innerText = data.productoJim.reference;
				    document.getElementById('idStockProd').innerText = data.productoJim.stock;
				    document.getElementById('idProvProd').innerText = data.productoJim.nomProveedor;  // para la info de la derecha
					document.getElementById('idProvSelect').innerText = data.productoJim.nomProveedor;
					idProducto = data.productoJim.idProduct;
					idProdVariant= data.productoJim.prodVariant;
				}else{
					document.getElementById('idPrecioProd').innerText = 'No existe';
				    document.getElementById('idRefProd').innerText = 'No existe';
				    document.getElementById('idStockProd').innerText = 'No existe';
				    document.getElementById('btnAddCarrito').removeAttribute('href');//deshabilito el botón de Añadir
				}
				break;
			case '2':
				if(data.productoHyper != null){
					document.getElementById('idPrecioProd').innerText = data.productoHyper.price;
				    document.getElementById('idNombreProd').innerText = data.productoHyper.nameEs;
				    document.getElementById('idProdSelect').innerText = data.productoHyper.nameEs;
				    document.getElementById('idRefProd').innerText = data.productoHyper.reference;
				    document.getElementById('idStockProd').innerText = data.productoHyper.stock;
				    document.getElementById('idProvProd').innerText = data.productoHyper.nomProveedor;  // para la info de la derecha
					document.getElementById('idProvSelect').innerText = data.productoHyper.nomProveedor;
					idProducto = data.productoHyper.idProduct;
					idProdVariant= data.productoHyper.prodVariant;
				}else{
					document.getElementById('idPrecioProd').innerText = 'No existe';
				    document.getElementById('idRefProd').innerText = 'No existe';
				    document.getElementById('idStockProd').innerText = 'No existe';
				    document.getElementById('btnAddCarrito').removeAttribute('href');//deshabilito el botón de Añadir
				}
				break;
			case '3':
				if(data.productoNatur != null){
					document.getElementById('idPrecioProd').innerText = data.productoNatur.price;
				    document.getElementById('idNombreProd').innerText = data.productoNatur.nameEs;
				    document.getElementById('idProdSelect').innerText = data.productoNatur.nameEs;
				    document.getElementById('idRefProd').innerText = data.productoNatur.reference;
				    document.getElementById('idStockProd').innerText = data.productoNatur.stock;
				    document.getElementById('idProvProd').innerText = data.productoNatur.nomProveedor;  // para la info de la derecha
					document.getElementById('idProvSelect').innerText = data.productoNatur.nomProveedor;
					idProducto = data.productoNatur.idProduct;
					idProdVariant= data.productoNatur.prodVariant;
				}else{
					document.getElementById('idPrecioProd').innerText = 'No existe';
				    document.getElementById('idRefProd').innerText = 'No existe';
				    document.getElementById('idStockProd').innerText = 'No existe'; 
				    document.getElementById('btnAddCarrito').removeAttribute('href');//deshabilito el botón de Añadir
				}
				break;
			}
		}, 
		dataType : "json"   
	});
}

/******************************* VER PRODUCTOS *********************************/
function mostrarBotones(size, products, idProveedor) {
    console.log("Llamada a mostrarBotones");
    var btnItems = ''; // Contenedor de los botones
    var btn;

    var btnActive = document.querySelector('#botones .pagination.active');
    var pageIndex = 1;
    if (btnActive) pageIndex = parseInt(btnActive.textContent); // Si existe un botón activo, obtenemos el valor

    var btnBefore = "<a class='pagination' id='btnBefore'>&lt;</a>";
    var btnNext = "<a class='pagination' id='btnNext'>&gt;</a>";

    // Limpiar el contenedor de los botones
    $('#botones').empty();

    if (size >= 10) {
        var nButtons = 3; // Número de botones
        var firstInit = (pageIndex > 1 && pageIndex <= size - 10) ? pageIndex - 1 : 1;
        var secondInit = (pageIndex <= size - nButtons) ? size - nButtons : size - nButtons + 1;

        for (var i = 0; i < nButtons; i++) {
            if ((firstInit + i) < secondInit) {
                btn = "<a class='pagination'>" + (firstInit + i) + "</a>";
            } else {
                btn = "<a class='pagination'>" + (i + 1) + "</a>";
            }
            btnItems += btn;
        }

        if (secondInit > firstInit) {
            btnItems += "<a class='pagination'> ... </a>";
            for (var i = 0; i < nButtons; i++) {
            	if(secondInit + i < size)
                	btnItems += "<a class='pagination'>" + (secondInit + i) + "</a>";
            }
        }
    } else {
        for (var i = 0; i < size; i++) {
            btnItems += "<a class='pagination'>" + (i + 1) + "</a>";
        }
    }

    $('#botones').append(btnBefore + btnItems + btnNext);
    
    // Seleccionar todos los botones generados
    var btnElements = $('#botones .pagination');
	
    // Marcar como activo boton de la pagina actual
    btnElements.each(function (index, element) {
        if (parseInt($(element).text()) === pageIndex) {
            $(element).addClass('active');
        }
    });

    // Poner oyentes a cada botón
    $('#botones .pagination').click(function () {
        quitarActivo();
        console.log("He pulsado el boton " + this.textContent);

        var indice = parseInt(this.textContent);
        if (!isNaN(indice)) {
            var o = (indice - 1) * xPag;
            var h = indice * xPag;
            $(this).addClass("active");

            mostrarResultadoBusqueda(o, h, products, products.length);
            mostrarBotones(size, products, idProveedor);
        }
    });

    // Evento de clic para "Anterior"
    $('#btnBefore').click(function () {
        if (pageIndex > 1) {
            quitarActivo();
            pageIndex--;
            console.log("He pulsado el boton Anterior");

            var o = (pageIndex - 1) * xPag;
            var h = pageIndex * xPag;
            
            
            
            $('#botones a').each(function () {
                if (parseInt($(this).text()) === pageIndex) {
                    $(this).addClass('active');
                }
            });
            
            mostrarResultadoBusqueda(o, h, products, products.length);
            mostrarBotones(size, products, idProveedor);
        }
    });

    // Evento de clic para "Siguiente"
    $('#btnNext').click(function () {
        if (pageIndex < size) {
            quitarActivo();
            pageIndex++;
            console.log("He pulsado el boton Siguiente");

            var o = (pageIndex - 1) * xPag;
            var h = pageIndex * xPag;
            
            $('#botones a').each(function () {
                if (parseInt($(this).text()) === pageIndex) {
                    $(this).addClass('active');
                }
            });
            mostrarResultadoBusqueda(o, h, products, products.length);
            mostrarBotones(size, products, idProveedor);
        }
    });
}

 
function quitarActivo(){
    var losBotones = document.querySelectorAll('#botones a');
    for(var i = 0; i < losBotones.length; i++){
        $(losBotones[i]).removeClass('active');
    }
}

function mostrarLista(desde,hasta, prods,totales){
	$("#contentFilterJim").empty();
	$("#contentFilterHyper").empty();
	$("#contentFilterNatur").empty();
	var h = hasta;
	if(hasta>totales){
		h=totales;
	} 
	var lista = '';     
	
	for(var i = desde; i < h; i++){    
		if(prods[i].idProveedor == 1){ // si es Jimsport la imagen no está en base64

			$('#contentFilterJim').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>MATERIAL DEPORTIVO</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src=" + prods[i].imageData + " alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+prods[i].idProduct+"&idProveedor=1' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",1)'>	  <span class='button-wrapper'> 	<span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong>  <span class='glyphicon glyphicon-euro'></span>  </div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].descripcion+"</div>  		</div> 	</div> </div>"); 
		}else if(prods[i].idProveedor == 2){ // si es Hypertrophy la imagen SI está en base64
			if(prods[i].imageData != null){
				$('#contentFilterHyper').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>SUPLEMENTACIÓN DEPORTIVA</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'>  <img src=" + prods[i].imageData + " alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=2' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",2)'>		<span class='button-wrapper'> 	<span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span></div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].nameEs+"</div>  	</div> 	</div> </div>");
			}else{
				$('#contentFilterHyper').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>SUPLEMENTACIÓN DEPORTIVA</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src='https://gestplus.okmas.net/GestPlus/resources/image/noImage.png' alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=2' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",2)'>		<span class='button-wrapper'> 	<span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span></div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].nameEs+"</div>  	</div> 	</div> </div>");
			}
		}else if(prods[i].idProveedor == 3){ // si es Naturatal
			$('#contentFilterNatur').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>PRODUCTOS NATURALES</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src=" + prods[i].imageData + " alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=3' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",3)'>	<span class='button-wrapper'> 	<span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span> </div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].descripcion+"</div>  	</div> 	</div> </div>");

		}
    }
	
} 

/**
 * @author Deporocio
 *
 * Función muestra productos pertenecientes al array "listFilter", desde el producto que se encuentre en la posicion indicado por la variable "desde"
 * hasta el producto que se encuentra en la variable "hasta - 1".
 */
function mostrarListaTodos(desde,hasta){
	allProducts = allProductsJim.concat(allProductsHyper).concat(allProductsNatur);	//concateno las listas de todos los proveedores 
	
	listFilter = new Array();
	listFilter = allProducts;
	totales = listFilter.length;
	
	$("#idContentAllProducts").empty();
	
// 	nPag = Math.ceil(totales / xPag); 
//     offset = (pag - 1) * xPag;
//     hasta = pag * xPag;
    
    
	var h = hasta;
	if(hasta>totales){
		h=totales;
	}   
    
    for(var i = desde; i < h; i++){    
		if(listFilter[i].idProveedor == 1){ // si es Jimsport la imagen no está en base64

			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=1'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",1)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].descripcion+"</div>   </div> </div> </div>");			
		}else if(listFilter[i].idProveedor == 2){ // si es Hypertrophy la imagen SI está en base64
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+listFilter[i].idProduct+"&idProveedor=2'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",2)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].nameEs+"</div>   </div> </div> </div>");
		}else if(listFilter[i].idProveedor == 3){ // si es Naturatal
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+listFilter[i].idProduct+"&idProveedor=3'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",3)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].descripcion+"</div>   </div> </div> </div>");

		}
    }
}

//mostrarResultadoBusqueda(0,pag * xPag, listFilter,listFilter.length);  
function mostrarResultadoBusqueda(desde, hasta, prods, totales){
	$("#contentFilterSearch").empty();
	$("#idContentAllProducts").empty();
	
	
	var h = hasta;
	if(hasta>totales){
		h=totales;
	} 
	var lista = '';     
	
	for(var i = desde; i < h; i++){    
		if(prods[i].idProveedor == 1){ 

			//relleno el content de okeymasTiendaUX
			$('#contentFilterSearch').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>MATERIAL DEPORTIVO</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src=" + prods[i].imageData + " alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+prods[i].idProduct+"&idProveedor=1' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",1)'>		<span class='button-wrapper'> 	<span class='icon'><img src='img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span></div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].descripcion+"</div>  		</div> 	</div> </div>"); 
			//relleno el content de okeymasTiendaProductos
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+prods[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ prods[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+prods[i].idProduct+"&idProveedor=1'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",1)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+prods[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+prods[i].descripcion+"</div>   </div> </div> </div>");
		}else if(prods[i].idProveedor == 2){ // si es Hypertrophy la imagen SI está en base64
			$('#contentFilterSearch').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>SUPLEMENTACIÓN DEPORTIVA</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src='https://gestplus.okmas.net/GestPlus/resources/image/noImage.png 'alt=''  /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=2'>  <span class='button-wrapper'>  <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span></span></a> 	</span> 	</a> 	</span> 	</a> 	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",2)'>		<span class='button-wrapper'> 	<span class='icon'><img src='img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span></div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].nameEs+"</div>  		</div> 	</div> </div>");
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+prods[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ prods[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=2'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",2)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+prods[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+prods[i].nameEs+"</div>   </div> </div> </div>");
		}else if(prods[i].idProveedor == 3){ // si es Naturatal
			$('#contentFilterSearch').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>PRODUCTOS NATURALES</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src=" + prods[i].imageData + " alt=''  /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=3'>  <span class='button-wrapper'>  <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span></span></a> 	</span> 	</a>  	</span> 	</a> 	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",3)'>		<span class='button-wrapper'> 	<span class='icon'><img src='img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span> </div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].descripcion+"</div>  		</div> 	</div> </div>");
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+prods[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ prods[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=3'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",3)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+prods[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+prods[i].descripcion+"</div>   </div> </div> </div>");

		}
    }
	
	
	//comprobar si contentFilter está vacío 
	var elem = document.getElementById('contentFilterSearch');
	if(elem != null && elem.children.length == 0){
		$('#contentFilterSearch').append("<div><h3>No hay artículos disponibles</h3></div>"); // una imagen de no hay artículos 
	}
	
	//si estoy en la pantalla de allProducts comprobar si idContentAllProducts está vacío 
	var elem = document.getElementById('idContentAllProducts');
	if(elem != null && elem.children.length == 0){
		$('#idContentAllProducts').append("<div><h3>No hay artículos disponibles</h3></div>"); // una imagen de no hay artículos 
	}

	//$(this).scrollTop(0); 
} 

/******************************************************FILTRO POR CATEGORÍA************************************************/
function filterProducts(categoria,idProveedor){ 
	var params = {};
	params["idCategoria"] = categoria; 
	
	switch (idProveedor) {
	case 1:
		$.ajax({
			url : "/GestPlus/filterByCategory",
			type : "POST",
			data : params,
			// myDataTable migth not exist 
			success : function(data, textStatus) {
				listFilter = new Array();
				listFilter = data.listProductos;
				totales = data.totalRecords;     
				mostrarLista(0,pag * xPag, data.listProductos,totales);  
				nPag = Math.ceil(data.totalRecords / xPag); 
				mostrarBotones(nPag,listFilter);
				document.getElementById('idContentFilterJim').style.display='block';
				document.getElementById('idContentFilterHyper').style.display='none';
				document.getElementById('idContentFilterNatur').style.display='none';
			}, 
			dataType : "json"   
		});  
		break;
	case 2:
		$.ajax({
			url : "/GestPlus/filterByHyperCategory",
			type : "POST",
			data : params,
			// myDataTable migth not exist 
			success : function(data, textStatus) {  
				listFilter = new Array();
				listFilter = data.listProductos;
				totales = data.totalRecords;   
				mostrarLista(0,pag * xPag, data.listProductos,totales);  
				nPag = Math.ceil(data.totalRecords / xPag); 
				mostrarBotones(nPag,listFilter);
			}, 
			dataType : "json"
		});  
	break;
	default:
		break;
	}
}

/******************************************************PAGO************************************************/
function validar(){
	 if ($('#idNombreEnvio').val()==''){
		swal("El nombre es obligatorio.");
		return false;
	 } else if ($('#idApellidosEnvio').val()==''){
		swal("El apellido es obligatorio.");
		return false;
	 } else if ($('#idDireccion').val()==''){
		swal("La dirección es obligatoria");
		return false;
	 } else if ($('#idNumeroEnvio').val()==''){
		swal("El número es obligatorio.");
		return false;
	 }  else if ($('#idLocalidad').val()==''){
		swal("La localidad es obligatoria");
		return false;
	 }else if ($('#idProvinciaEnvio').val()==''){
		swal("La provincia es obligatoria");
		return false;
	 }else if ($('#idCodPost').val()==''){
		swal("El cod postal es obligatorio.");
		return false;
	 } 
	 return true;
}

/*function fn_pago(){ // este paso lo que hace es crear el purchase en bd y abrir la pasarela de pago Redsys 
	
	if(validar()){
		if(confirm("Sus datos serán registrado en nuestra base de datos Es necesario registrarse para proceder con el pago, ¿está de acuerdo en que usemos sus datos?")){
			
			var params = {};
					
			params["nombre"] = idNombreEnvio.value;
			params["apellidos"] = idApellidosEnvio.value;
			params["email"] = idEmailEnvio.value;
			params["movil"] = idMovilEnvio.value;
			params["pwd"] = idPwdEnvio.value;
			//params["pwd"] = idRepeatPwdEnvio.value;
			
			if(idAceptaCondCh.checked)
				params["aceptaCondiciones"]=1;
			else
				params["aceptaCondiciones"]=0;
			
			if(idAceptaPromosCh.checked)
				params["aceptaPromos"]=1;
			else
				params["aceptaPromos"]=0;
			
			if(idAceptaComunCh.checked)
				params["aceptaComunicaciones"]=1;
			else
				params["aceptaComunicaciones"]=0;
		
			params["direccion.tipo"] = idTipoEnvio.value;
			params["direccion.street"] =  idDireccionEnvio.value; 
			params["direccion.street2"] = idNumeroEnvio.value; 
			params["direccion.zip"] = idCodPostEnvio.value; 
			params["direccion.city"] = idLocalidadEnvio.value;
			params["direccion.provincia"] =  idProvinciaEnvio.value; 
			params["direccion.country_code"] = "ES";
			
			var i=0;
			listCarrito.forEach((element) => {
				params["productos["+i+"].quantity"] = 1,
			    params["productos["+i+"].product_id"] = element.idProduct;
			    params["productos["+i+"].variant_id"] = element.prodVariant; 
			    params["productos["+i+"].idProveedor"] = element.idProveedor;
			    params["productos["+i+"].price"] = element.price;
			    params["productos["+i+"].imageData"] = element.imageData;
			    params["productos["+i+"].reference"] = element.reference;
			    params["productos["+i+"].nameEs"] = element.nameEs;
			    i++;
			}); 
		
			params["total"]=document.getElementById('idTotalPagar').innerHTML;  
			//params["total"] = 2.55;   	
			
			$.ajax({
				url : "/GestPlus/pagoTienda",
				type : "POST",
				data : params,
				// myDataTable migth not exist
				success : function(data, textStatus) {
					var errorMessage = data.error;
					if (typeof (errorMessage) !== "undefined"
							&& errorMessage !== null && errorMessage !== '') {
						swal("Se ha producido un error: " + errorMessage);
					} else {
						paramPurchase = data.paramPurchase;
						$("#paramPurchase").val(paramPurchase);
						signaturePurchase = data.signaturePurchase;
						$("#signaturePurchase").val(signaturePurchase);
						$('#frmPurchase').submit();
					}
				},
				dataType : "json"
			});
		}
	}
	return true;
}*/


function fn_pago() { 
    if (validar()) {
    	if(isLoggedIn.equals('true')){ 
	    	pagar(); 
    	}else{
    		if(confirm("Gracias por completar el formulario. Vamos a proceder a crear una cuenta con los datos proporcionados. ¿Desea continuar?")){
	    		pagar();
		    }
    	}
    }
    return true;
}

async function pagar(){
	var params = {};
    
    params["nombre"] = idNombreEnvio.value;
	params["apellidos"] = idApellidosEnvio.value;
	params["email"] = idEmailEnvio.value;
	params["movil"] = idMovilEnvio.value;
	params["pwd"] = idPwdEnvio.value;
	
	if(idAceptaCondCh.checked)
		params["aceptaCondiciones"]=1;
	else
		params["aceptaCondiciones"]=0;
	
	if(idAceptaPromosCh.checked)
		params["aceptaPromos"]=1;
	else
		params["aceptaPromos"]=0;
	
	if(idAceptaComunCh.checked)
		params["aceptaComunicaciones"]=1;
	else
		params["aceptaComunicaciones"]=0;

	params["direccion.tipo"] = idTipoEnvio.value;
	params["direccion.street"] =  idDireccionEnvio.value; 
	params["direccion.street2"] = idNumeroEnvio.value; 
	params["direccion.zip"] = idCodPostEnvio.value; 
	params["direccion.city"] = idLocalidadEnvio.value;
	params["direccion.provincia"] =  idProvinciaEnvio.value; 
	params["direccion.country_code"] = "ES";
	
	
	
    var i = 0;
    var productsWithoutStock = "";

    for (let element of listCarrito) {
        const product = await fn_getProductById(element.idProduct, element.prodVariant, element.idProveedor);

        if (parseInt(product.stock) >= parseInt(element.quantity)) {
            params["productos[" + i + "].quantity"] = element.quantity;
            params["productos[" + i + "].product_id"] = element.idProduct;
            params["productos[" + i + "].variant_id"] = element.prodVariant; 
            params["productos[" + i + "].idProveedor"] = element.idProveedor;
            params["productos[" + i + "].price"] = element.price;
            params["productos[" + i + "].imageData"] = element.imageData;
            params["productos[" + i + "].reference"] = element.reference;
            params["productos[" + i + "].nameEs"] = element.nameEs;
        } else {
            productsWithoutStock = productsWithoutStock + ", " + element.nameEs;
        }

        i++;
    }

    if (productsWithoutStock) {
        swal("Los productos: " + productsWithoutStock + ". No tienen stock suficiente para realizar el pedido");
    }

    params["total"] = document.getElementById('idTotalPagar').innerHTML;

    $.ajax({
        url: "/GestPlus/pagoTienda",
        type: "POST",
        data: params,
        success: function(data, textStatus) {
            var errorMessage = data.error;
            if (typeof (errorMessage) !== "undefined" && errorMessage !== null && errorMessage !== '') {
                swal("Se ha producido un error: " + errorMessage);
            } else {
                paramPurchase = data.paramPurchase;
                $("#paramPurchase").val(paramPurchase);
                signaturePurchase = data.signaturePurchase;
                $("#signaturePurchase").val(signaturePurchase);
                $('#frmPurchase').submit();
            }
        },
        dataType: "json"
    });
}



/******************************************************CONSULTAR UN PRODUCTO************************************************/

function fn_infoProduct(){	
	console.log("fn_infoProducttt");
	switch (elProv) {
	case '1':
	case 1:
		precio = '';
		//nombre = '';
		nombre= '';
		ref = '';
		stock = '';
		prov = '';
		nomProv = '';
		idProducto = '';
		idProdVariant= '';  
		desc = '';
		break;
	case '2':
	case 2:
		precio = ''; 
		nombre = ''; // c:out respeta las ñ y tildes
		ref = '';
		stock = '';
		prov = '';
		nomProv = '';
		idProducto = '';
		idProdVariant= '';  
		desc = '';
		
		break;
	case '3':
	case 3:
		precio = ''; 
		//nombre = '';
		nombre= '';  
		ref = '';
		stock = '';
		prov = '';
		nomProv = '';
		idProducto = '';
		idProdVariant= '';
		
		desc = '';
		
		aptoD = '' === "true" ? "SI" : "NO";
		aptoV = '' === "true" ? "SI" : "NO";
		bio = '' === "true" ? "SI" : "NO";
		cantMedida = '';
		congelado = '' === "true" ? "SI" : "NO";
		frio = '' === "true" ? "SI" : "NO";
		gluten = '' === "true" ? "SI" : "NO";
		huevo = '' === "true" ? "SI" : "NO";
		lactosa = '' === "true" ? "SI" : "NO";
		break;
	default:
		break;
	}
	document.getElementById("loader").classList.add("hidden");
}

function decodeHTML(html) { //para decodificar el texto cuando está escapado
    var textarea = document.createElement('textarea');
    textarea.innerHTML = html;
    //return textarea.value; 
 // Decodificar el texto y eliminar saltos de línea o espacios innecesarios
    return textarea.value.replace(/^\s+|\s+$/g, '').replace(/\n+/g, '\n').trim();
}

function sanitizeHTML(html) {
    // Reemplazar etiquetas duplicadas o mal formadas
    html = html.replace(/&lt;&lt;/g, '&lt;');
    html = html.replace('h2', 'h6');//cambio h2 por h8 
    // Crear un elemento para decodificar el texto
    var textarea = document.createElement('textarea');
    textarea.innerHTML = html;

    return textarea.value;
}

</script>

</body>
</html>

    <!-- LOADER -->
    <div id="loader-wrapper"></div>

    <div id="content-block">
        <!-- HEADER -->
      
        <div class="header-empty-space"></div> 

        <div class="container">
            <div class="empty-space col-xs-b10 col-sm-b15"></div>
            <div class="breadcrumbs">
                <a href="okeymasTiendaUX.html">inicio</a>
                <a href="okeymasTiendaUX.html">tienda</a>
                <a id="idMenuProvSelec"></a>
            </div>
            
            <div class="empty-space col-xs-b5 col-sm-b10 col-md-b15"></div>
            
            <div class="row">
            
                <div class="col-md-9 col-md-push-3">
                    <div class="container-fluid">
	                   <div class="row" id="idBusqueda">
	                       <div class="col-sm-8 col-sm-offset-2 col-lg-6 col-lg-offset-3">
	                           <form>
	                               <div class="search-submit">
	                                   <i class="fa fa-search" aria-hidden="true" id="btnBusqueda" onclick="busqueda()"></i>
	                               </div>
	                               <input id="txtFilterBase" class="simple-input style-1" type="text" value="" placeholder="Buscar en catálogo" autocomplete="off">  
	                               <ul id="sugerencias"></ul>
	                           </form>
	                       </div>
	                   </div>
	               </div>
	               
	               <div class="empty-space col-xs-b5 col-sm-b10 col-md-b15"></div>  
	
                    <div class="align-inline spacing-1">
                        <div class="h4" id="idProvSelecAllProd"></div>
                    </div>
                    <div class="align-inline spacing-1">
<!--                        <div class="simple-article size-1">SHOWING <b class="grey">15</b> OF <b class="grey">2 358</b> RESULTS</div>-->
                    </div>
<!--                     <div class="align-inline spacing-1 hidden-xs"> -->
<!--                         <a class="pagination toggle-products-view active"><img src="img/icon-14.png" alt="" /><img src="img/icon-15.png" alt="" /></a> -->
<!--                         <a class="pagination toggle-products-view"><img src="img/icon-16.png" alt="" /><img src="img/icon-17.png" alt="" /></a> -->
<!--                     </div> --> 
<!--                     <div class="align-inline spacing-1 filtration-cell-width-1"> -->

<!--                             <option disabled="disabled" selected="selected">más populares</option> -->
<!--                             <option value="volvo">Volvo</option> -->
<!--                             <option value="saab">Saab</option> -->
<!--                             <option value="mercedes">Mercedes</option> -->
<!--                             <option value="audi">Audi</option> -->

<!--                     </div> -->

<!--                     <div class="align-inline spacing-1 filtration-cell-width-2"> -->

<!--                             <option disabled="disabled" selected="selected">Ver 30</option> -->
<!--                             <option value="volvo">30</option> -->
<!--                             <option value="saab">50</option> -->
<!--                             <option value="mercedes">100</option> -->
<!--                             <option value="audi">200</option> -->

<!--                     </div> -->

<!--                     <div class="empty-space col-xs-b25 col-sm-b60"></div> -->

                    <div class="products-content">
                        <div class="products-wrapper">
                            <div id="idContentAllProducts" class="row nopadding">
                               
                            </div>
                        </div>
                    </div>
                    <div class="empty-space col-xs-b35 col-sm-b0"></div>
                    <div class="row">
                        <div class="col-sm-3 hidden-xs">
<!--
                            <a class="button size-1 style-5" href="#">
                                <span class="button-wrapper">
                                    <span class="icon"><i class="fa fa-angle-left" aria-hidden="true"></i></span>
                                    <span class="text">prev page</span>
                                </span>
                            </a>
-->
                        </div>
                        <div class="col-sm-12 text-center">
                            <div id='botones' class="pagination-wrapper">
<!--                                 <a class="pagination active">1</a> -->
<!--                                 <a class="pagination">2</a> -->
<!--                                 <a class="pagination">3</a> -->
<!--                                 <a class="pagination">4</a> -->

<!--                                 <a class="pagination">23</a> -->
                            </div>
                        </div>
                        <div class="col-sm-3 hidden-xs text-right">
<!--
                            <a class="button size-1 style-5" href="#">
                                <span class="button-wrapper">
                                    <span class="icon"><i class="fa fa-angle-right" aria-hidden="true"></i></span>
                                    <span class="text">prev page</span>
                                </span>
                            </a>
-->
                        </div>
                    </div>

                    <div class="empty-space col-xs-b35 col-md-b70"></div>
                    
                </div>
                
               <div class="col-md-3 col-md-pull-9">
                    <div class="h4 col-xs-b10">categorías</div>
                    <ul class="categories-menu transparent">
                       <li>
                         <a href="okeymasTiendaProductos396f.html?idProveedor=1" >MATERIAL DEPORTIVO</a>  <ul>
                          	  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('CATÁLOGO GENERAL')">CATÁLOGO GENERAL</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('EQUIPAMIENTO')">EQUIPAMIENTO</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('NOVEDADES')">NOVEDADES</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('ADIDAS')">ADIDAS</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('ASICS')">ASICS</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('BABOLAT')">BABOLAT</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('BULLPADEL')">BULLPADEL</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('CMP')">CMP</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('CONVERSE')">CONVERSE</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('DC STRIPE CREW')">DC STRIPE CREW</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('DIADORA')">DIADORA</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('DR. MARTENS')">DR. MARTENS</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('DRY GRIP')">DRY GRIP</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('DUNLOP')">DUNLOP</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('EASTPAK ACCESORIOS')">EASTPAK ACCESORIOS</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('ENEBE PADEL')">ENEBE PADEL</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('FILA')">FILA</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('FISIOXTREME')">FISIOXTREME</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('HARLEM')">HARLEM</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('HAVAIANAS')">HAVAIANAS</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('HEAD')">HEAD</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('HEALTH')">HEALTH</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('HYBRID')">HYBRID</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('JHAYBER')">JHAYBER</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('KSWISS')">KSWISS</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('LACOSTE')">LACOSTE</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('LE COQ SPORTIF')">LE COQ SPORTIF</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('LOTTO')">LOTTO</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('MAMMUT')">MAMMUT</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('MIZUNO')">MIZUNO</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('MYSTICA')">MYSTICA</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('NEW BALANCE')">NEW BALANCE</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('NEW ERA')">NEW ERA</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('NEXUS')">NEXUS</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('NIKE')">NIKE</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('NOX')">NOX</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('PUMA')">PUMA</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('QUIKSILVER')">QUIKSILVER</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('REEBOK')">REEBOK</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('ROXY')">ROXY</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('RS PADEL')">RS PADEL</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SALEWA')">SALEWA</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SALMING')">SALMING</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SAUCONY')">SAUCONY</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SCOTT')">SCOTT</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SELECT')">SELECT</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SIUX')">SIUX</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SOFTEE PADEL')">SOFTEE PADEL</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SOFTEE RUNNING')">SOFTEE RUNNING</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('TIMBERLAND')">TIMBERLAND</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('UFC')">UFC</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('UNDER ARMOUR')">UNDER ARMOUR</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('VARIOS CALZADO')">VARIOS CALZADO</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('VIBOR-A PADEL')">VIBOR-A PADEL</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('WILLIAM MARTIN')">WILLIAM MARTIN</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('WILSON')">WILSON</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('CALCETINES Y MEDIAS')">CALCETINES Y MEDIAS</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('DEPORTIUM')">DEPORTIUM</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SQUBA')">SQUBA</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SOFTEE TEXTIL')">SOFTEE TEXTIL</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SOFTEE CALZADO')">SOFTEE CALZADO</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('RAQUETAS Y PELOTAS')">RAQUETAS Y PELOTAS</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SOFTEE TEAM')">SOFTEE TEAM</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('ROX')">ROX</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('BALONES')">BALONES</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('CHANCLAS')">CHANCLAS</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('BALL RESCUER')">BALL RESCUER</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SHOCKOUT & 4ON & ARAMICS')">SHOCKOUT & 4ON & ARAMICS</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SOFTEE BEACH')">SOFTEE BEACH</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('SOFTEE PICKLEBALL')">SOFTEE PICKLEBALL</a>
	                            </li>
							  
								<li>
	                                <a href="#" onclick="fn_busquedaCategoria('REDES ECOBALLUTION')">REDES ECOBALLUTION</a>
	                            </li>
							 
                          </ul>    
                        </li>
						<li>
							<a href="okeymasTiendaProductosbd5d.html?idProveedor=2" >SUPLEMENTACIÓN DEPORTIVA</a>
                        </li>
                         <li>
                                <a href="okeymasTiendaProductos8a83.html?idProveedor=3">PRODUCTOS NATURALES</a>
                            </li>
                     
                    </ul>

                    <div class="empty-space col-xs-b25 col-sm-b50"></div>

<!--                     <div class="h4 col-xs-b25">precio</div> -->
<!--                     <div id="prices-range"></div> -->


<!--                     <div class="empty-space col-xs-b25 col-sm-b50"></div> -->

<!--                     <div class="h4 col-xs-b25">modalidad</div> -->
<!--                     <label class="checkbox-entry"> -->

<!--                     </label> -->
<!--                     <div class="empty-space col-xs-b10"></div> -->
<!--                     <label class="checkbox-entry"> -->

<!--                     </label> -->
<!--                     <div class="empty-space col-xs-b10"></div> -->
<!--                     <label class="checkbox-entry"> -->

<!--                     </label> -->
<!--                     <div class="empty-space col-xs-b10"></div> -->
<!--                     <label class="checkbox-entry"> -->

<!--                     </label> -->
<!--                     <div class="empty-space col-xs-b10"></div> -->
<!--                     <label class="checkbox-entry"> -->

<!--                     </label> -->

<!--                     <div class="empty-space col-xs-b25 col-sm-b50"></div> -->

<!--                     <div class="h4 col-xs-b25">Choose Color</div> -->
<!--                     <div class="color-selection size-1"> -->
<!--                         <div class="entry active" style="color: #a7f050;"></div> -->
<!--                         <div class="entry" style="color: #50e3f0;"></div> -->
<!--                         <div class="entry" style="color: #eee;"></div> -->
<!--                         <div class="entry" style="color: #4d900c;"></div> -->
<!--                         <div class="entry" style="color: #edb82c;"></div> -->
<!--                         <div class="entry" style="color: #7d3f99;"></div> -->
<!--                         <div class="entry" style="color: #3481c7;"></div> -->
<!--                         <div class="entry" style="color: #bf584b;"></div> -->
<!--                     </div> -->

<!--                     <div class="empty-space col-xs-b25 col-sm-b50"></div> -->

<!--                     <div class="h4 col-xs-b25">marca</div> -->
<!--                     <label class="checkbox-entry"> -->

<!--                     </label> -->
<!--                     <div class="empty-space col-xs-b10"></div> -->
<!--                     <label class="checkbox-entry"> -->

<!--                     </label> -->
<!--                     <div class="empty-space col-xs-b10"></div> -->
<!--                     <label class="checkbox-entry"> -->

<!--                     </label> -->
<!--                     <div class="empty-space col-xs-b10"></div> -->
<!--                     <label class="checkbox-entry"> -->

<!--                     </label> -->
<!--                     <div class="empty-space col-xs-b10"></div> -->
<!--                     <label class="checkbox-entry"> -->

<!--                     </label> -->

                    
<!--                     <div class="empty-space col-xs-b25 col-sm-b60"></div> -->

                </div>
            </div>
        </div>

        <!-- FOOTER -->
    </div>

    <script>
    var provSelec ='1';
    var filtro ='';
    const inputBuscador = document.getElementById("txtFilterBase");
	const sugerencias = document.getElementById("sugerencias");
	let indexSeleccionado = -1;
	let sugerenciasVisibles = [];
	  
    $(document).ready(function() {
    	
    	
    	if(provSelec != null && provSelec != ''){
    		traerProductosByProv(provSelec);
    	}else{
    		traerProductos(1,filtro); 
    	}
    	
    	if(filtro != null && filtro != ''){
    		console.log("hay filtro:  " + filtro);
    	}
    	
    	/*$("#txtFilterBase").on("keypress", function(event) {
    	    if (event.which === 13) {  // 13 es el código de la tecla Enter
    	    	event.preventDefault();
    	    	//busqueda();
    	    	if (indexSeleccionado >= 0 && sugerenciasVisibles[indexSeleccionado]) {
    	    	    // Si hay sugerencia seleccionada, usarla
    	    	    inputBuscador.value = sugerenciasVisibles[indexSeleccionado].textContent;
    	    	  }
    	    	  
    	    	  sugerencias.innerHTML = "";

    	    	  // Aquí puedes ejecutar la búsqueda con el texto actual
    	    	  busqueda();
    	    }
    	  });*/
    	
    	// SUGERENCIAS DEL BUSCADOR
    	  
    	inputBuscador.addEventListener("input", function () {
    	    const texto = inputBuscador.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    	    sugerencias.innerHTML = "";
    	    sugerenciasVisibles = [];
    	    indexSeleccionado = -1;

    	    if (texto.length < 2) return; 
    	    
    	    if (allProducts == undefined) { 
    	    	cargarAllProductos(0, null).then(() => {
    	    		  console.log(allProducts); // ✅ También funciona
    	    		});
    	      }

    	    const resultados = allProducts
    	    .filter(p => p.nameEs.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(texto)
    	    ).slice(0, 15); // máximo 15 sugerencias  

    	    resultados.forEach((resultado, i) => {
    	      const li = document.createElement("li");
    	      li.textContent = resultado.nameEs;
    	      //li.dataset.id = resultado.idProduct;            // Guardamos el id oculto 
    	      li.tabIndex = 0;
    	      li.style.padding = "5px";
    	      li.style.cursor = "pointer";
    	      li.addEventListener("click", function () {
    	        //inputBuscador.value = resultado; 
    	        sugerencias.innerHTML = "";
    	        console.log("buscar lo que hay seleccionado y mostrar infoProducto"); 
    	        switch (resultado.idProveedor) { 
    	        case 1: // JIM
    	        	window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+resultado.idProduct+"&idProveedor=1";	
    	        break;
    	    	case 2: // HYPER
    	    		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+resultado.idProduct+"&idProveedor=2";	
    	    	break;
    	    	case 3: // NATUR
    	    		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+resultado.idProduct+"&idProveedor=3";
    	    		break;
    	    	default:
    	    		break;
    	        }
    	      
    	      });
    	      sugerencias.appendChild(li);
    	      sugerenciasVisibles.push(li);
    	    });
    	  });

    	  inputBuscador.addEventListener("keydown", function (e) {
    	    if (sugerenciasVisibles.length === 0) return;

    	    if (e.key === "ArrowDown") {
    	      e.preventDefault();
    	      indexSeleccionado = (indexSeleccionado + 1) % sugerenciasVisibles.length;
    	      actualizarSeleccion();
    	    }

    	    if (e.key === "ArrowUp") {
    	      e.preventDefault();
    	      indexSeleccionado = (indexSeleccionado - 1 + sugerenciasVisibles.length) % sugerenciasVisibles.length;
    	      actualizarSeleccion();
    	    }

    	    if (e.key === "Enter") {
    	    	  e.preventDefault();
    	    	  if (indexSeleccionado >= 0 && sugerenciasVisibles[indexSeleccionado]) {
    	    	    // Si hay sugerencia seleccionada, usarla
    	    	    inputBuscador.value = sugerenciasVisibles[indexSeleccionado].textContent;
    	    	  }
    	    	  sugerencias.innerHTML = "";
    	    	  // Aquí puedes ejecutar la búsqueda con el texto actual
    	    	  console.log("buscar lo que hay escrito");
    	    	  busqueda();
    	    	}

    	  });

    	  function actualizarSeleccion() {
    	    sugerenciasVisibles.forEach((li, i) => {
    	      li.style.backgroundColor = (i === indexSeleccionado) ? "#ddd" : "transparent";
    	    });
    	  }
    	  
    	
    	
     });
    </script>
    
    
	
		<script>
			document.getElementById("loader").classList.add("hidden"); 
		</script>
	

</body>
</html>

</div>
<div id="content-block">
	





 
 
<!DOCTYPE html>
<html lang="en">

<body class="fonts-1">





 
 

<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no, minimal-ui"/>
    
    <!-- fonts -->
    <link href="https://fonts.googleapis.com/css?family=Questrial|Raleway:700,900" rel="stylesheet">

<link href="resources/jimTienda/designUX/css/bootstrap.min-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/bootstrap.extension-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/style-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/swiper-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/sumoselect-2.css"  rel="stylesheet"></link>
<link href="resources/jimTienda/designUX/css/font-awesome.min-2.css"  rel="stylesheet"></link>
    
<!-- scripts -->
<script  src="resources/jimTienda/designUX/js/jquery-2.2.4.min.js"></script>
<script  src="resources/jimTienda/designUX/js/swiper.jquery.min.js"></script>
<script  src="resources/jimTienda/designUX/js/global.js"></script>

<!-- range slider -->
<script  src="resources/jimTienda/designUX/js/jquery-ui.min.js"></script>
<script  src="resources/jimTienda/designUX/js/jquery.ui.touch-punch.min.js"></script>


<script  src="resources/jimTienda/designUX/js/jquery.sumoselect.min.js"></script>


<script  src="resources/jimTienda/designUX/js/jquery.classycountdown.js"></script>
<script  src="resources/jimTienda/designUX/js/jquery.knob.js"></script>
<script  src="resources/jimTienda/designUX/js/jquery.throttle.js"></script>

<!-- masonry -->
<script src="resources/jimTienda/designUX/js/isotope.pkgd.min.js"></script>

<!--  estos scripts son necesarios para la parte de añadir productos a la cesta -->
<script src="../../cdn-na.infragistics.com/igniteui/latest/js/infragistics.core.js"></script>
<script src="../../cdn-na.infragistics.com/igniteui/latest/js/infragistics.dv.js"></script> 


<!-- MAP -->



<!-- CONTACT --> 
<script  src="resources/jimTienda/designUX/js/contact.form.js"></script>
    
<!-- OTROS -->  
<script src="resources/script/sweetalert.min.js"></script>
<script src="../../unpkg.com/bootstrap-table%401.15.5/dist/bootstrap-table.min.js"></script>


<link rel="shortcut icon" href="resources/jimTienda/designUX/img/favicon.ico" />

 <script src="../../cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
 
 <style>
        /* Loader toda la pantalla*/
        #loader {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* Fondo semitransparente */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* Animación de rotación */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Aplica la animación al SVG */
        #loader img {
            width: 50px; /* Ajusta el tamaño del SVG */
            height: 50px;
            animation: spin 1.5s linear infinite;
        }

        /* Ocultar el loader cuando esté listo */
        #loader.hidden {
            display: none;
        }
        
         /* Mostrar el loader cuando esté listo */
        #loader.show {
            display: block;
        }
        
    </style>
<title> </title>
</head>

<body>

<script type="text/javascript">
/***************************VARIABLES****************************/
var productosCarrito = [];
var numProdCarrito = 0;
var totales = 0; 
var pag = 1; 
var xPag = 30;//total de imágenes por página 
var nPag = 0;
var offset = 0;
var hasta = 0;

var cantidad=0;
var costeEnvio = 5;
var precioTotal = 0;
var listCarrito = [];
var jimSelect = 0;
var jimVarianteSelect = 0;
var listFilter = new Array(); 
var totalProd = 0;
var arrayProductos  = new Array();
var allProducts;
var allProductsJim; 
var allProductsHyper;
var allProductsNatur;

var elCliente;
var laDireccionEnvio;

var txtIva = " EUR (IVA INCLUIDO)"; 

var j=1;

var idProductoDevolver = 0;

var precio = '';
var nombre = '';
var ref =''; 
var stock = '';
var prov = '';
var nomProv = '';
var idProducto= '';
var idProdVariant = '';
var desc = '';

var isLoggedIn = '';
var direccionEnvio = '';
var emailLogged = '';
var pwdLogged = '';
var elProv ='1';
var idCli = '';


// var prodSesion = [];
/*
//Inicialmente agrega un estado ficticio al historial
history.pushState({ page: 1 }, "title 1", window.location.href);


// Escucha el evento "popstate"
window.addEventListener("popstate", function (event) {
  if (event.state && event.state.page === 1) {
    // Aquí se detecta cuando el usuario presiona "atrás"
    console.log("Botón 'Atrás' presionado");
    window.location.href = "https://gestplus.okmas.net/GestPlus/okeymasTiendaUX";
  }
});
*/ 

//------------------------------- Formulario de contacto -----------------------------------

/**
 * @author Juan Garcia
 *
 * Envia la respuesta recibida del formulario disponible en la pagina "okeymasTiendaContacto"
 */
function fn_sendContactForm() {
	
	var popup = ''; 
	
	// Rescatamos los datos del formulario con id = contactForm {contacto.jsp}
	var name 		= contactFormNombre.value;
	var lastname 	= contactFormApellidos.value;
	var phoneNumber = contactFormTelefono.value;
	var email		= contactFormEmail.value;
	var message		= contactFormMensaje.value;
	
	if(name && name !== ''
			&& lastname 	&& lastname !== ''
			&& phoneNumber 	&& phoneNumber !== ''
			&& email 		&& email !== ''
			&& message 		&& message !== ''){
		
		var params = {};
			params["nombre"] 	= name;
			params["apellidos"]	= lastname;
			params["movil"]		= phoneNumber;
			params["email"]		= email;
			params["mensaje"]	= message;
			
		 $.ajax({
	            url: "/GestPlus/sendContactForm",
	            type: "POST",
	            data: params,
	            success: function(data, textStatus) {
	                var errorMessage = data.error;
	                if (typeof (errorMessage) !== "undefined" && errorMessage !== null && errorMessage !== '') {
	                    swal("Se ha producido un error: " + errorMessage);
	                } else {
	                	
	                	popup = `
	    					<div class="popup-wrapper active">
	    					    <div class="bg-layer"></div>
	    					    <div class="popup-content active" data-rel="1">
	    					        <div class="layer-close"></div>
	    					        <div class="popup-container size-1">
	    					            <div class="popup-align">
	    					                <h3 class="h3 text-center">Gracias por confiar en nosotros</h3>
	    					                <div class="empty-space col-xs-b30"></div>
	    					                <h5 class="h5 text-center">Su solicitud será procesada por uno de nuestros agentes</h5>
	    					            </div>
	    					            <div class="button-close"></div>
	    					        </div>
	    					    </div>
	    					</div>`;
	    					
	                	// Inyectamos el popup en el cuerpo del documento
	                	document.body.innerHTML += popup;
	    					
	                }
	            },
	            dataType: "json"
	        });
	}else{
		popup = `
					<div class="popup-wrapper active">
					    <div class="bg-layer"></div>
					    <div class="popup-content active" data-rel="1">
					        <div class="layer-close"></div>
					        <div class="popup-container size-1">
					            <div class="popup-align">
					                <h3 class="h3 text-center">No podemos procesar la solicitud</h3>
					                <div class="empty-space col-xs-b30"></div>
					                <h5 class="h5 text-center">Debe rellenar todos los campos</h5>
					            </div>
					            <div class="button-close"></div>
					        </div>
					    </div>
					</div>`;
			// Inyectamos el popup en el cuerpo del documento
			document.body.innerHTML += popup;
					
	}
}

/*************************** INICIAR/CERRAR SESIÓN Y REGISTRO ****************************/

var compruebaEmail = function(email){ 
	if (email!==""){
		var params = {};
		params["email"]=email;
		$.ajax({
			url : "/GestPlus/compruebaEmailTienda",
			type : "POST",
			data : params,
			// myDataTable migth not exist
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"	&& errorMessage !== null 	&& errorMessage !== '') {
					swal("Se ha producido un error: "	+ errorMessage); 
				} else {
					var existeEmail = data.emailRegistrado; 
					if (existeEmail === true){
						swal("Este email ya pertenece a un usuario registrado.");
						$('#email').val(""); 
						$('#idEmailEnvio').val(""); 
					}
				}
			},
			dataType : "json"
		});	
	}
}
						
function fn_olvidoPwd(){
	
	if(idForgotEmail.value == ''){
		swal("Por favor, introduzca un email válido.");
		return false;
	}else if(idForgotPwd.value == ''){
		swal("Por favor, introduzca una nueva contraseña.");
		return false;
	}
	
	var params = {};
	params["email"] = idForgotEmail.value;
	params["newPwd"] = idForgotPwd.value;
	$.ajax({
		url : "/GestPlus/olvidoPwd",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal(errorMessage);
			} else {
				window.location.href= "okeymasTiendaMiCuenta.html";
			}
		},
		dataType : "json"
	});
}

function fn_login(isLogged){
	 
	if(idEmailLogin.value == ''){
		swal("Por favor, introduzca un email válido.");
		return false;
	}else if(idPwdLogin.value == ''){
		swal("Por favor, introduzca su contraseña.");
		return false;
	}
	
	var params = {};
	
	if(isLogged){
		params["email"] = emailLogged;
		params["pwd"] = pwdLogged;
	}else{
		params["email"] = idEmailLogin.value;
		params["pwd"] = idPwdLogin.value;
	}

	$.ajax({
		url : "/GestPlus/loginTienda",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal(errorMessage); 
			} else {
				// Si la cuenta existe, mostrar modal con el resumen de la compra
				// y un botón que lleve a la pasarela de pago 

			
				window.location.href= "okeymasTiendaMiCuenta.html";
				
				elCliente = data.cliente;
			}
		},
		/*error : function(data, textStatus) {
			var errorMessage = data.error;
			swal(errorMessage);  
		},*/
		dataType : "json"
	}); 
}

function fn_loginCh(isLogged){
	 
	if(idEmailLoginCh.value == ''){
		swal("Por favor, introduzca un email válido.");
		return false;
	}else if(idPwdLoginCh.value == ''){
		swal("Por favor, introduzca su contraseña.");
		return false;
	}
	
	var params = {};
	
	if(isLogged){
		params["email"] = emailLogged;
		params["pwd"] = pwdLogged;
	}else{
		params["email"] = idEmailLoginCh.value;
		params["pwd"] = idPwdLoginCh.value;
	}

	$.ajax({
		url : "/GestPlus/loginTienda",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal(errorMessage); 
			} else {
				// Si la cuenta existe, mostrar modal con el resumen de la compra
				// y un botón que lleve a la pasarela de pago 
				elCliente = data.cliente;
				window.location.href= "okeymasTiendaMiCuenta.html";
			}
		},
	
		dataType : "json"
	}); 
}

function fn_cerrarSesion(){
	if(confirm("¿Está seguro de cerrar sesión?")){
		var params = {};
		$.ajax({
			url : "/GestPlus/logoutTienda",
			type : "POST",
			data : params,
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal(errorMessage); 
				} else {
					window.location.href= "okeymasTiendaUX.html";

					
					//localStorage.clear(); // para limpiar el carrito almacenado en el navegador 
					//location.reload();
				}
			},
			dataType : "json"
		}); 
	}	
}

function fn_registrar(){
	if(validarCliente()){
		var params = {};
		params["nombre"] = nombreCliente.value;
		params["apellidos"] = apellidos.value;
		params["email"] = email.value;
		params["movil"] = movil.value;
		params["pwd"] = idPwd.value;
		
		params["direccion.provincia"] =  provincia.value; 
		params["direccion.street"] =  direccion.value; 
		params["direccion.street2"] = numero.value; 
		params["direccion.zip"] = codPost.value; 
		params["direccion.city"] = localidad.value;
		var tipoDirec = document.getElementById("tipo");
		params["direccion.tipo"] = tipoDirec.value;
		params["direccion.country_code"] = "ES";
		
		//params["direccion.partner_ref"] ="0001";//esto sería el purchase para identificar el pedido, por ejemplo j29231003125 
		//params["direccion.observations"] = "PEDIDO DE PRUEBA, NO TRAMITAR (SABE PABLO)";//observ.value
		//params["direccion.note"] ="Pedido Web DEPOROCIO\nReferencia Web, 0001";
		
		if(idAceptaCond.checked)
			params["aceptaCondiciones"]=1;
		else
			params["aceptaCondiciones"]=0;
		
		if(idAceptaPromos.checked)
			params["aceptaPromos"]=1;
		else
			params["aceptaPromos"]=0;
		
		if(idAceptaComun.checked)
			params["aceptaComunicaciones"]=1;
		else
			params["aceptaComunicaciones"]=0;
		
		$.ajax({
			url : "/GestPlus/registroTiendaOkmas",
			type : "POST",
			data : params,
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal(errorMessage);
				} else {
					elCliente = data.cliente;
					swal("Registro realizado con éxito");
					document.querySelector(".swal-button--confirm")?.addEventListener("click", () => window.location.href= "okeymasTiendaMiCuenta.html");
					// window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaMiCuenta"; 
				}
			},
			dataType : "json"
		});
	}
}

function validarCliente(){
	if ($('#nombreCliente').val()==''){
		swal("Nombre vacío.");
		return false;
	} else if ($('#apellidos').val()==''){
		swal("Apellidos  vacío.");
		return false;
	} else if ($('#email').val()==''){
		swal("Email  vacío.");
		return false;
	} else if ($('#movil').val()==''){
		swal("Móvil  vacío.");
		return false;
	} else if ($('#idPwd').val()==''){
		swal("Password  vacío.");
		return false;
	}  else if ($('#idRepeatPwd').val()==''){
		swal("Repite password  vacío.");
		return false;
	} else if ($('#idPwd').val() != $('#idRepeatPwd').val()){
		swal("Los passwords no coinciden.");
		return false;
	} else if ($('#direccion').val()==''){
		swal("Dirección  vacía."); 
		return false;
	} else if(!idAceptaCond.checked){
		swal("Debes aceptar las condiciones."); 
		return false;
	}
	return true;  
}

function fn_updateCuenta(){
	if(confirm("¿Está seguro de que desea modificar sus datos?")){
		var params = {};
		params["idCliente"] = idCuentaCliente;
		params["nombre"] = idMiNombre.value;
		params["apellidos"] = idMisApellidos.value;
		params["movil"] = idMiMovil.value;
		
		params["direccion.tipo"] = idCuentaTipo.value;
		params["direccion.provincia"] =  idCuentaProv.value; 
		params["direccion.street"] =  idCuentaDireccion.value; 
		params["direccion.street2"] = idCuentaNum.value; 
		params["direccion.zip"] = idCuentaCodPost.value; 
		params["direccion.city"] = idCuentaLocalidad.value;
		
		params["direccion.country_code"] = "ES";

		$.ajax({
			url : "/GestPlus/updateCuenta",
			type : "POST",
			data : params,
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal(errorMessage); 
				} else {
					elCliente = data.cliente;
					window.location.href= "okeymasTiendaMiCuenta.html"; 
					
				}
			},
			dataType : "json"
		}); 
	}	
}
/*************************** CARRITO ****************************/

/**
 * @author Deporocio
 *
 *
 * Almacena los productos del carrito en una variable de sesión.
 */
function fn_saveCarrito(){
	var params = {};
	var i = 0; 
	
	listCarrito.forEach((element) => {
		params["productos["+i+"].quantity"] = element.quantity,
	    params["productos["+i+"].product_id"] = element.idProduct;
	    params["productos["+i+"].variant_id"] = element.prodVariant; 
	    params["productos["+i+"].idProveedor"] = element.idProveedor;
	    params["productos["+i+"].price"] = element.price;
	    params["productos["+i+"].imageData"] = element.imageData;
	    params["productos["+i+"].reference"] = element.reference;
	    params["productos["+i+"].nameEs"] = element.nameEs;
	    i++;
	});  
	$.ajax({
		url : "/GestPlus/saveCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist 
		success : function(data, textStatus) {
			var s = data.productos;
			productosCarrito = data.productos;
		}
	}); 
}

/*function fn_verCarrito(){ // click en la cesta
	var params = {};
	var i=0;  
	
	if( prodSesion )
		prodSesion.forEach((element) => {  
	        params["productos[" + i + "].quantity"] 	= element.quantity;
	        params["productos[" + i + "].product_id"] 	= element.idProduct;
	        params["productos[" + i + "].variant_id"]	= element.prodVariant; 
	        params["productos[" + i + "].idProveedor"] 	= element.idProveedor;
	        params["productos[" + i + "].price"] 		= element.price;
	        params["productos[" + i + "].imageData"] 	= element.imageData;
	        params["productos[" + i + "].reference"] 	= element.reference;
	        params["productos[" + i + "].nameEs"] 		= element.nameEs;
	        
	        console.log("producto del carrito: " + element.nameEs + ", cantidad: " + element.quantity);
	        i++;
	    });  
	
	$.ajax({
		url : "/GestPlus/verCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist 
		success : function(data, textStatus) {
			var s = data.productos;
			productosCarrito = data.productos;
				
			//var url = "https://gestplus.okmas.net/GestPlus/okeymasTiendaCarrito?productosCarrito";
			//window.open(url,'_self'); //en la misma página
			//window.open(url);//en otra página
			//fn_abrirCarrito();
			window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaCarrito";

		}
	}); 
}*/

async function fn_verCarrito(){ 
	if(numProdCarrito < 1){
		swal("No hay productos en el carrito.");
		return;
	}
	
	const prodSesion = await traerProdSesion();
	var params = {};
	var i=0;  
	
	if( prodSesion )
		prodSesion.forEach((element) => {  
	        params["productos[" + i + "].quantity"] 	= element.quantity;
	        params["productos[" + i + "].product_id"] 	= element.idProduct;
	        params["productos[" + i + "].variant_id"]	= element.prodVariant; 
	        params["productos[" + i + "].idProveedor"] 	= element.idProveedor;
	        params["productos[" + i + "].price"] 		= element.price;
	        params["productos[" + i + "].imageData"] 	= element.imageData;
	        params["productos[" + i + "].reference"] 	= element.reference;
	        params["productos[" + i + "].nameEs"] 		= element.nameEs;
	        
	        console.log("producto del carrito: " + element.nameEs + ", cantidad: " + element.quantity);
	        i++;
	    });  
	
	$.ajax({
		url : "/GestPlus/verCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist 
		success : function(data, textStatus) {
			var s = data.productos;
			productosCarrito = data.productos;
				
			//window.open(url,'_self'); //en la misma página
			//window.open("https://gestplus.okmas.net/GestPlus/okeymasTiendaCarrito");//en otra página
			//fn_abrirCarrito();
			
			window.location.href= "okeymasTiendaCarrito.html";
			
		}
	}); 
}

/**
 * @author Deporocio
 * Trae los productos asociados a la variable de sesion del cliente.
 *
 *
 * @return {void}
 */
 function traerProdSesion() {
	  return new Promise((resolve, reject) => {
	    var params = {};

	    $.ajax({
	      url: "/GestPlus/verProdSesion",
	      type: "POST",
	      data: params,
	      success: function(data, textStatus) {
	        var errorMessage = data.error;
	        if (typeof errorMessage !== "undefined" && errorMessage !== null && errorMessage !== '') {
	          swal(errorMessage);
	          reject(new Error(errorMessage));
	        } else {
	          var prodSesion = data.productos;
	          console.log("Recibida respuesta del servidor, prodSesion: " + prodSesion);
	          resolve(prodSesion);
	        }
	      },
	      dataType: "json"
	    });
	  });
}
 
 /*
 function fn_comprobarCarrito(){
	 if(numProdCarrito < 1){
		 swal("No hay productos en el carrito");
	 }else{
		 window.location.href="https://gestplus.okmas.net/GestPlus/okeymasTiendaCheckout";
	 }
 }
 
 
/*function fn_checkout(){
	if(numProdCarrito == 0){
		swal("No hay productos en el carrito.");
		return;
	}
	
	var params = {};
	
	var i=0;   
	listCarrito.forEach((element) => {
		params["productos["+i+"].quantity"] = element.quantity,
	    params["productos["+i+"].product_id"] = element.idProduct;
	    params["productos["+i+"].variant_id"] = element.prodVariant; 
	    params["productos["+i+"].idProveedor"] = element.idProveedor;
	    params["productos["+i+"].price"] = element.price;
	    params["productos["+i+"].imageData"] = element.imageData;
	    params["productos["+i+"].reference"] = element.reference;
	    params["productos["+i+"].nameEs"] = element.nameEs;
	    i++;
	});  
	$.ajax({
		url : "/GestPlus/saveCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist 
		success : function(data, textStatus) {
			var s = data.productos;
			productosCarrito = data.productos;
				
			window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaCheckout";
		}
	}); 
}*/



async function fn_checkout() {
	console.log("----------------- fn_checkout() -----------------");
   
	if(numProdCarrito == 0){
		swal("No hay productos en el carrito.");
		return;
	}
	
	var params = {};
    var outOfStockProducts = []; // Lista para productos sin stock
    var i = 0;

    for (const element of listCarrito) {
    	try {
            var response = await fn_checkStock(element.idProduct, element.prodVariant, element.idProveedor, element.quantity);
            
            if (response === true) {
            	params["productos[" + i + "].quantity"] 	= element.quantity,
    		    params["productos[" + i + "].product_id"] 	= element.idProduct;
    		    params["productos[" + i + "].variant_id"] 	= element.prodVariant; 
    		    params["productos[" + i + "].idProveedor"]	= element.idProveedor;
    		    params["productos[" + i + "].price"] 		= element.price;
    		    params["productos[" + i + "].imageData"] 	= element.imageData;
    		    params["productos[" + i + "].reference"] 	= element.reference;
    		    params["productos[" + i + "].nameEs"] 		= element.nameEs;
               
            } else {
            	outOfStockProducts.push(element.nameEs);
            }
            i++;
            
        } catch (error) {
            console.error("Error verificando stock para :" + error);
        }
    }

    // Si hay productos sin stock, mostrarlos y detener el proceso
    if (outOfStockProducts.length > 0) {
        swal("Los siguientes productos no tienen stock suficiente: \n" + outOfStockProducts.join(", "));
        return;
    }

    // Si todos los productos tienen stock, hacer la petición AJAX
    $.ajax({
        url: "/GestPlus/saveCarrito",
        type: "POST",
        data: params,
        success: function (data, textStatus) {
            productosCarrito = data.productos;
            window.location.href = "okeymasTiendaCheckout.html";
        },
        error: function (xhr, status, error) {
            console.error("Error en la petición AJAX:", error);
        }
    });
}

function removeProducto(idItem){
	var params = {};
	params["idItemCesta"] = idItem;
	$.ajax({
		url : "/GestPlus/removeProdCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal("", "Error: " + errorMessage, "warning");
			}else{
				var s = data.productos;
				productosCarrito = data.productos;
					
				window.location.href= "okeymasTiendaCarrito.html";
			}
		},
		dataType : "json"
	});
}

function fn_recalcularMas(idItem, precio,pos,item){
	let numero = Number.parseInt(item.parent().parent().find("input[name='contador']").val());  
    item.parent().parent().find("input[name='contador']").val(numero + 1);
	
	 cantidad += 1; 
	 $("#cantidadCarrito").val("Carrito (" + cantidad + ")");   
	 precioTotal += precio;
	 $("#idTotal").val(precioTotal.toFixed(2) + txtIva); 
	 
	 // hay que actualizar el campo prodSelect[idItem].cantidad = numero+1;
	 listCarrito[pos].cantidad = numero+1;
	 //fn_clonar(); 
}

function fn_recalcularMenos(idItem, precio, pos,item){
	 let numero = Number.parseInt(item.parent().parent().find("input[name='contador']").val());
     if(numero>1){ // así evitamos los negativos y el 0
     	item.parent().parent().find("input[name='contador']").val(numero - 1);	
     	cantidad -= 1; 
		$("#cantidadCarrito").val("Carrito (" + cantidad + ")");   
		 precioTotal -= precio;
		 $("#idTotal").val(precioTotal.toFixed(2) + txtIva); 
		 listCarrito[pos].cantidad = numero-1;
		 //fn_clonar();  
     }
}

async function fn_checkStock(idProduct, idVariant, idProveedor, quantity) {
	try{
		console.log("--------------- fn_checkStock()-----------------");
		 var product = await fn_getProductById(idProduct, idVariant, idProveedor);
		 
		 if(!product || typeof product.stock === "undefined"){
			 console.log("El producto no se encuentra disponible");
			 return false;
		 }
		 
		 if(product.stock < quantity){
			 console.log("No hay suficiente stock del producto seleccionado");
			 return false;
		 }
		 
	}catch(error) {
		console.log("Ha ocurrido un error durante la solicitud: " + error);
		swal("No se ha podido procesar la solicitud, intentelo más tarde");
		return false;
	}
	console.log("Hay stock del producto " + idProduct);
	 return true;
}

/*function fn_addProd(){
	var cantSelec = document.getElementById('idSpanCantidad').innerText;
	console.log("Cantidad seleccionada: " + cantSelec);
	var stockDisp = document.getElementById('idStockProd').innerText;
	
	if(stockDisp.equals('0')){
		swal("No hay stock.");
	}else if(parseInt(stockDisp) < parseInt(cantSelec)){
		swal("No hay stock suficiente para la cantidad elegida.");
	}else{
		fn_addCarrito(idProducto, idProdVariant, elProv, cantSelec);
	}
}*/

function fn_addProd(){
	console.log("--------------- fn_addProd()-----------------");
	var cantSelec = document.getElementById('idSpanCantidad').innerText;
	var stockDisp = document.getElementById('idStockProd').innerText;
	
	if(stockDisp.equals('0')){
		swal("No hay stock.");
	}else if(parseInt(stockDisp) < parseInt(cantSelec)){
		swal("No hay stock suficiente para la cantidad elegida.");
	}else{
		/**
		*
		* idProducto, idProdVariant, elProv, cantSelec son variables globales, cuyos valores
		* han sido extraidos del codigo HTML
		*
		*/
		fn_addCarrito(idProducto, idProdVariant, elProv, cantSelec);
	}
}

function fn_learnMore(idProduct,prodVariant,idProveedor){
// 	Jim - https://gestplus.okmas.net/GestPlus/findVariantByProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=1
// 	Hyper - https://gestplus.okmas.net/GestPlus/findVariantByHyperProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=2
// 	Natur - https://gestplus.okmas.net/GestPlus/findVariantByNaturProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=3
		
	console.log("Encontrado producto: " + idProduct + ", " + prodVariant + ", " + idProveedor);
		
	var params = {};
	params["jim_id"] = idProduct;
	params["idProveedor"]=idProveedor;
	switch (idProveedor) {
	case 1: // jim sport
		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+idProduct+"&idProveedor=1";
		break;
	case 2: // hypertrophy
		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+idProduct+"&idProveedor=2";
		break;
	case 3: // naturatal
		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+idProduct+"&idProveedor=3";
		break;
	default:
		break;
	}
}

function fn_findVariant(idProduct,prodVariant,idProveedor){

	var params = {};
	switch (idProveedor) {
	case 1: // jim sport
		params["jim_id"] = idProduct;
		$.ajax({
			url : "/GestPlus/findVariantByProductOld",
			type : "POST",
			data : params,
			// myDataTable migth not exist
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal("", "Error: " + errorMessage, "warning");
				}else{
					fn_learnMore(idProduct,prodVariant,idProveedor);
					/*if(data.totalRecords <= 1){ 
						fn_addCarrito(idProduct, prodVariant, idProveedor, 1);
					}else{
						fn_learnMore(idProduct,prodVariant,idProveedor);
					}*/
				}
			},
			dataType : "json"
		});
		break;
	case 2: // hypertrophy
		params["idProduct"] = idProduct;	
		$.ajax({
			url : "/GestPlus/findVariantByHyperProductOld",
			type : "POST",
			data : params,
			// myDataTable migth not exist
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal("", "Error: " + errorMessage, "warning");
				}else{
					fn_learnMore(idProduct,prodVariant,idProveedor);
					/*if(data.totalRecords <= 1){ 
						fn_addCarrito(idProduct,prodVariant,idProveedor,1);
					}else{
						fn_learnMore(idProduct,prodVariant,idProveedor);
					}*/
				}
			},
			dataType : "json"
		});
		break;
	case 3: // naturatal
		params["idProduct"] = idProduct;		
		$.ajax({
			url : "/GestPlus/findVariantByNaturProductOld",
			type : "POST",
			data : params,
			// myDataTable migth not exist
			success : function(data, textStatus) {
				var errorMessage = data.error;
				if (typeof (errorMessage) !== "undefined"
						&& errorMessage !== null && errorMessage !== '') {
					swal("", "Error: " + errorMessage, "warning");
				}else{
					
					fn_learnMore(idProduct, prodVariant, idProveedor);
					/*if(data.totalRecords <= 1){ 
						fn_addCarrito(idProduct, prodVariant, idProveedor, 1);
					}else{
						fn_learnMore(idProduct,prodVariant,idProveedor);
					}*/
				}
			},
			dataType : "json"
		});
		break;
	default:
		break;
	}
}

/*
function fn_updateCarrito(prod,cant){
	console.log("updateee");
	var params = {};
	params["idItemCesta"] = prod;
	params["cantidad"] = cant;
	$.ajax({
		url : "/GestPlus/updateCarrito",
		type : "POST",
		data : params,
		// myDataTable migth not exist
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal("", "Error: " + errorMessage, "warning");
			}else{
				var s = data.productos;
				productosCarrito = data.productos;
				window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaCarrito";
			}
		},
		dataType : "json"
	});
}*/


function fn_actualizarVblesGlobales(){
	precioTotal = '0'; // sin el IVA
	precioTotal = parseFloat(precioTotal);
	numProdCarrito = '0';
	if(numProdCarrito != null){
		if(!numProdCarrito.equals(""))
			numProdCarrito = parseInt(numProdCarrito); 
		else{
			numProdCarrito = 0; 
		}
	}
	console.log("precioTotal: " + precioTotal);
	console.log("numProdCarrito:  " + numProdCarrito);   
}

/*function fn_actualizarCarrito(){
 	var subT = 0;
	// Obtener todas las filas del tbody
	const filas = document.querySelectorAll('#idTablaCarrito tbody tr');
	
	filas.forEach((fila, i) => {
		  // Obtener todas las celdas de la fila
		  var p = fila.querySelector("#idProductoCarrito").innerText;
		  var c = fila.querySelector("#idCantidadCarrito").innerText;
		  //actualizo el total de esa fila:
		  fila.querySelector("#idTotalProductoCarrito").innerText = c * fila.querySelector("#idPriceCarrito").innerText;
		  //actualizo el subtotal:
		  subT += parseFloat(fila.querySelector("#idTotalProductoCarrito").innerText);
		  //falta actualizar la variable de sesión "productos" en el action
		  fn_updateCarrito(p,c);
	});
	//document.getElementById('idSubTotal').innerHTML = subT.toFixed(2);
	//document.getElementById('idTotalPagar').innerHTML = subT+5;
}*/

async function fn_actualizarCarrito(){
	console.log("--------------- fn_actualizarCarrito()-----------------");
	
	if( window.location.href.includes("okeymasTiendaCarrito") ) {
		console.log("Actualizando vista okeymasTiendaCarrito...");
		var subT = 0;
		// Obtener todas las filas del tbody
		const filas = document.querySelectorAll('#idTablaCarrito tbody tr');
		
		   for (const fila of filas) {
		        // Obtener todas las celdas de la fila
		        var idProduct = fila.querySelector("#idProductoCarrito").innerText;
		        var idVariant = fila.querySelector("#idVariantCarrito").innerText;
		        var idProveedor = fila.querySelector("#idProvCarrito").innerText;
		        var productQuantity = fila.querySelector("#idCantidadCarrito").innerText;
		        
		        try {
		            // Esperar la respuesta de fn_checkStock
		            var response = await fn_checkStock(idProduct, idVariant, idProveedor, productQuantity);
		            if (response) {
		                // Actualizo el total de esa fila:
		                fila.querySelector("#idTotalProductoCarrito").innerText = productQuantity * parseFloat(fila.querySelector("#idPriceCarrito").innerText);
		                
		                // Actualizo el subtotal:
		                subT += parseFloat(fila.querySelector("#idTotalProductoCarrito").innerText);
		                
		                // Faltaría actualizar la variable de sesión "productos" en el action
		                fn_updateCarrito(idProduct, productQuantity);
		            } else {
		                console.log("Stock insuficiente");
		            }
		        } catch (error) {
		            console.log("Ha ocurrido un error procesando la solicitud, por favor intentalo más tarde");
		        }
		    }
		   	
			document.getElementById('idSubTotal').innerHTML = subT.toFixed(2);
			document.getElementById('idTotalPagar').innerHTML = subT+5;
			location.reload();
	}else{
		console.log(" El cliente no esta situado en la ventana okeymastiendacarrito. ");
	}
}



/*function fn_addCarrito(idP,idV,idProveedor,quantity){
	//aquí ya hay q guardar en la sesión los productos de la cesta
	
	cantidad = 0; 
	//$(window).scrollTop(0);  // para volver al inicio de la página  
	if(idP == null && idV == null) {  
		cantidad += quantity; 
		var prodSelect = null; 
		prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 
		if(prodSelect != null){
			listCarrito.add(prodSelect[0]);   
			//session.setAttribute("listaCarrito",listCarrito);
			$('#idCesta').append("<div class='cart-entry clearfix' id="+ prodSelect[0].id +">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+prodSelect[0].nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+prodSelect[0].price+"</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
			//$('#idCestaProd').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+prodSelect[0].nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+prodSelect[0].price+"</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>     <td>      <div class='button-close'></div>     </td>    </tr>   </table>  </div> </div>");
			numProdCarrito += quantity;
			document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
			document.getElementById('idCircleCarrito').innerHTML = numProdCarrito;
			precioTotal += prodSelect[0].price;
			document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
			document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
			fn_saveCarrito();
		} 
	}else{ 
		var params = {};
		switch (idProveedor) {
		case '1': // JIMSPORT
		case 1: // JIMSPORT
			params["jim_id"] = idP;
			params["idVariant"] = idV;
			$.ajax({
				url : "/GestPlus/findVariantProduct",
				type : "POST",
				data : params,
				// myDataTable migth not exist
				success : function(data, textStatus) {
					var errorMessage = data.error;
					if (typeof (errorMessage) !== "undefined"
							&& errorMessage !== null && errorMessage !== '') {
						swal("", "Error: " + errorMessage, "warning");
					}else{
						listCarrito.add(data.variantProduct); 
						cantidad += quantity; 
						var t = cantidad * data.variantProduct.price;
						precioTotal += t;
						$('#idCesta').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src="+data.variantProduct.image+" alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+data.variantProduct.nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+data.variantProduct.price+"</div>      <div class='simple-article size-1'>TOTAL: "+t.toFixed(2)+"</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>   </tr>   </table>  </div> </div>");
						
						numProdCarrito += cantidad;
						document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
						document.getElementById('idCircleCarrito').innerHTML = numProdCarrito;
						document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
						document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
						fn_saveCarrito();
					}
				},
				dataType : "json"
			});
			break;
		case '2': // HYPERTROPHY
		case 2: // HYPERTROPHY
			params["idProduct"] = idP;
			params["idVariant"] = idV;
			$.ajax({
				url : "/GestPlus/findHyperVariantProduct",
				type : "POST",
				data : params,
				// myDataTable migth not exist
				success : function(data, textStatus) {
					var errorMessage = data.error;
					if (typeof (errorMessage) !== "undefined"
							&& errorMessage !== null && errorMessage !== '') {
						swal("", "Error: " + errorMessage, "warning");
					}else{
						cantidad += quantity; 
						listCarrito.add(data.variantProduct); 
						var t = cantidad * data.variantProduct.price;
						precioTotal += t;
						$('#idCesta').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src="+data.variantProduct.imageData+" alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+data.variantProduct.nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+data.variantProduct.price+"</div>      <div class='simple-article size-1'>TOTAL: "+t.toFixed(2)+"</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>   </tr>   </table>  </div> </div>");
						//$('#idCestaProd').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src="+data.variantProduct.imageData+" alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+data.variantProduct.nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+data.variantProduct.price+"</div>      <div class='simple-article size-1'>TOTAL: "+t+"</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>     <td>      <div class='button-close'></div>     </td>    </tr>   </table>  </div> </div>");
						numProdCarrito += cantidad;
						document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
						document.getElementById('idCircleCarrito').innerHTML = numProdCarrito;
						document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
						document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
						fn_saveCarrito();
					}
				},
				dataType : "json"
			});
			break;
			case '3': // NATURATAL
			case 3: // NATURATAL
				params["idProduct"] = idP;
				$.ajax({
					url : "/GestPlus/findNaturProductById",
					type : "POST",
					data : params,
					// myDataTable migth not exist
					success : function(data, textStatus) {
						var errorMessage = data.error;
						if (typeof (errorMessage) !== "undefined"
								&& errorMessage !== null && errorMessage !== '') {
							swal("", "Error: " + errorMessage, "warning");
						}else{
							cantidad += quantity; 
							listCarrito.add(data.infoProduct); 							
							var t = cantidad * data.infoProduct.price;
							precioTotal += t;
							$('#idCesta').append("<div class='cart-entry clearfix'>  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src="+data.infoProduct.image+" alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>"+data.infoProduct.nameEs+"</a></div>      <div class='simple-article size-1'>CANTIDAD: "+cantidad+"</div>     </td>     <td>      <div class='simple-article size-3 grey'>"+data.infoProduct.price+"</div>      <div class='simple-article size-1'>TOTAL: "+t.toFixed(2)+"</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>   </tr>   </table>  </div> </div>");
							numProdCarrito += cantidad;
							document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
							document.getElementById('idCircleCarrito').innerHTML = numProdCarrito;
							document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
							document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
							fn_saveCarrito();
						}
					},
					dataType : "json"
				});
				break;
		default:
			break;
		}
	}
}*/

function fn_getTotalProductsInCart(cartProducts){
	console.log("--------------- fn_getTotalProductsInCart()-----------------");
	 var totalProducts = 0;
	 console.log(cartProducts);
	 if( cartProducts ){
		 cartProducts.forEach((cartProduct) => {
			 totalProducts += parseInt(cartProduct.quantity);
		 });
	 }

	 return totalProducts;
}

function fn_getProductById(idP, idV, idProveedor){
	console.log("--------------- fn_getProductById()-----------------");
	 return new Promise((resolve, reject) => {
	        var params = {};
	        var actionURL = null;

	        switch(idProveedor) {
	            case '1': case 1:  /* JimSport */
	                params["jim_id"] = idP;
	                params["idVariant"] = idV;
	                actionURL = "findVariantProduct.json";
	                break;

	            case '2': case 2: /* HyperTrophy */
	                params["idProduct"] = idP;
	                params["idVariant"] = idV;
	                actionURL = "findHyperVariantProduct.json";
	                break;

	            case '3': case 3: /* Naturatal */
	                params["idProduct"] = idP;
	                actionURL = "findNaturProductById.json";
	                break;

	            default:
	                console.log("El producto seleccionado no pertenece a ningun proveedor - Pongase en contacto con el administrador de la web.");
	                break;
	        }

	        $.ajax({
	            url: "/GestPlus/" + actionURL + "",
	            type: "POST",
	            data: params,
	            success: function(data, textStatus) {
	                var errorMessage = data.error;
	                if (typeof (errorMessage) !== "undefined" && errorMessage !== null && errorMessage !== '') {
	                    swal("Error: " + errorMessage, "warning");
	                    reject(new Error(errorMessage));
	                } else {
	                	product = data.variantProduct;
	                    console.log(product);
	                    if (idProveedor == 3) { 
	                        product = data.infoProduct; 
	                        console.log("El producto es de naturatal" + data.infoProduct);
	                    }
	                    resolve(product);
	                }
	            },
	            dataType: "json"
	        });
		 
	 });
}

/*async function fn_addCarrito(idP, idV, idProveedor, quantity) {
    //TASK: aquí ya hay que guardar en la sesión los productos de la cesta
    listCarrito = [];
    cantidad = 0;
    quantity = parseInt(quantity);

    const cartProducts = await traerProdSesion();

    if (idP == null && idV == null) {  
        cantidad += quantity; 
        var prodSelect = null; 
        prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 

        if (prodSelect != null) {
            listCarrito.add(prodSelect[0]);
            $('#idCesta').append("<div class='cart-entry clearfix' id=" + prodSelect[0].id + ">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>" + prodSelect[0].nameEs + "</a></div>      <div class='simple-article size-1'>CANTIDAD: " + cantidad + "</div>     </td>     <td>      <div class='simple-article size-3 grey'>" + prodSelect[0].price + "</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
            numProdCarrito += quantity;
            document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
            precioTotal += prodSelect[0].price;
            document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
            document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
            fn_saveCarrito();
        }
    } else { 
        try{
      	  var product = await fn_getProductById(idP, idV, idProveedor);
            
            if( product ) {
                var productSession = null;
                cantidad += quantity;
     

                if (cartProducts) {
                    cartProducts.forEach(function(e) { 
                        console.log("Elemento de cartProducts: " + e.nameEs + ", idProveedor = " + e.idProveedor + ", idProducto = " + e.product_id + ", variante = " + e.variant_id);
                    });
                    productSession = cartProducts.find((p) => (p.idProveedor == idProveedor && p.product_id == idP && p.variant_id == idV));
                }

                if (productSession == null) {
                    console.log("El producto no existe, añadimos con cantidad 1, y el valor de isNewProduct = " + productSession);
                    product.quantity = quantity;
                } else {
                    product.quantity = (parseInt(productSession.quantity) + cantidad);
                    console.log("Producto " + product.nameEs + ", cantidad: " + product.quantity + "stock: " + product.stock);
                }
                
                if (document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito')) document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito').innerHTML = totalPorProducto;
                if (document.getElementById('idStockProd')) document.getElementById('idStockProd').innerHTML = product.stock;
                if (document.getElementById('cantidadCarrito')) document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
                if (document.getElementById('idTotal')) document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
                if (document.getElementById('totalConIva')) document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;

                fn_saveCarrito();
            } else {
                swal("No hay Stock del producto. ");
            }
            
      }catch(error) {
    	  	console.log("Ha ocurrido un error durante la solicitud: " + error);
  			alert("No se ha podido procesar la solicitud, intentelo más tarde");
      }
    }
}*/

async function fn_addCarrito(idP, idV, idProveedor, quantity) {
	console.log("--------------- fn_addCarrito()-----------------");
    //TASK: aquí ya hay que guardar en la sesión los productos de la cesta
    listCarrito = [];
    cantidad = 0;
    quantity = parseInt(quantity);

    const cartProducts = await traerProdSesion();

    if (idP == null && idV == null) {  
        cantidad += quantity; 
        var prodSelect = null; 
        prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 

        if (prodSelect != null) {
            listCarrito.add(prodSelect[0]);
            $('#idCesta').append("<div class='cart-entry clearfix' id=" + prodSelect[0].id + ">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>" + prodSelect[0].nameEs + "</a></div>      <div class='simple-article size-1'>CANTIDAD: " + cantidad + "</div>     </td>     <td>      <div class='simple-article size-3 grey'>" + prodSelect[0].price + "</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
            numProdCarrito += quantity;
            document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
            precioTotal += prodSelect[0].price;
            document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
            document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
            fn_saveCarrito();
        }
    } else { 
        try{
      	  var product = await fn_getProductById(idP, idV, idProveedor);
            
            if( product ) {
                var productSession = null;
                cantidad += quantity;
     

                if (cartProducts) {
                    cartProducts.forEach(function(e) { 
                        console.log("Elemento de cartProducts: " + e.nameEs + ", idProveedor = " + e.idProveedor + ", idProducto = " + e.product_id + ", variante = " + e.variant_id);
                    });
                    productSession = cartProducts.find((p) => (p.idProveedor == idProveedor && p.product_id == idP && p.variant_id == idV));
                }

                if (productSession == null) {
                    console.log("El producto no existe, añadimos con cantidad 1, y el valor de isNewProduct = " + productSession);
                    product.quantity = quantity;
                } else {
                    product.quantity = (parseInt(productSession.quantity) + cantidad);
                    console.log("Producto " + product.nameEs + ", cantidad: " + product.quantity + "stock: " + product.stock);
                }
                
                var  response = await fn_checkStock(idP, idV, idProveedor, parseInt(product.quantity));
                if( response === true ) {
                	product.stock = parseInt(product.stock) - parseInt(product.quantity);
                    listCarrito.add(product);

                    precioTotal += product.price;
                    var totalPorProducto = product.quantity * product.price;

                    if ($('#idCesta').find('#' + idP + idV + idProveedor).length) {
                        $('#idCesta').find('#' + idP + idV + idProveedor).remove();
                    }

                    $('#idCesta').append(
                        "<div id=\"" + idP + idV + idProveedor + "\" class='cart-entry clearfix'>"
                        + " <a style='width: 15%;' class='cart-entry-thumbnail' href='#'>"
                        + "<img src='" + product.imageData + "' alt='' />"
                        + "</a>"
                        + " <div class='cart-entry-description'>"
                        + "   <table>"
                        + "     <tr>"
                        + "       <td>"
                        + "         <div class='h6'>"
                        + "           <a href='#'>" + product.nameEs + "</a>"
                        + "         </div>"
                        + "         <div class='simple-article size-1'>CANTIDAD: <div id='" + idP + idV + idProveedor + "'>" + product.quantity + "</div></div>"
                        + "       </td>"
                        + "       <td>"
                        + "         <div class='simple-article size-3 grey'>" + product.price + "</div>"
                        + "         <div class='simple-article size-1'>TOTAL: " + totalPorProducto + "</div>"
                        + "       </td>"
                        + "       <td>"
                        + "         <div class='cart-color' style='background: #facc22;'></div>"
                        + "       </td>"
                        + "       <td>"
                        + "        </div>"
                        + "       </td>"
                        + "     </tr>"
                        + "   </table>"
                        + " </div>"
                        + "</div>"
                    );

                    if( productSession ) { 
                    	numProdCarrito = fn_getTotalProductsInCart( cartProducts ) + quantity;
                    }else{
                    	numProdCarrito += cantidad;
                    }
                    
                    if (document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito')) document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito').innerHTML = totalPorProducto;
                    if (document.getElementById('idStockProd')) document.getElementById('idStockProd').innerHTML = product.stock;
                    if (document.getElementById('cantidadCarrito')) document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
                    if (document.getElementById('idTotal')) document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
                    if (document.getElementById('totalConIva')) document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
					
                    fn_saveCarrito();
                } else {
                    swal("No hay Stock del producto. ");
                }
                fn_actualizarCarrito();
            }
            
      }catch(error) {
    	  	console.log("Ha ocurrido un error durante la solicitud: " + error);
  			swal("No se ha podido procesar la solicitud, intentelo más tarde");
      }
    }
}

/*async function fn_removeCarrito(idP, idV, idProveedor, quantity) {
	    //TASK: aquí ya hay que guardar en la sesión los productos de la cesta
	    listCarrito = [];
	    cantidad = 0;
	    quantity = parseInt(quantity);
	    const cartProducts = await traerProdSesion();

	    if (idP == null && idV == null) {  
	        cantidad += quantity; 
	        var prodSelect = null; 
	        prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 

	        if (prodSelect != null) {
	            listCarrito.add(prodSelect[0]);
	            $('#idCesta').append("<div class='cart-entry clearfix' id=" + prodSelect[0].id + ">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>" + prodSelect[0].nameEs + "</a></div>      <div class='simple-article size-1'>CANTIDAD: " + cantidad + "</div>     </td>     <td>      <div class='simple-article size-3 grey'>" + prodSelect[0].price + "</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
	            numProdCarrito += quantity;
	            document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
	            precioTotal += prodSelect[0].price;
	            document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
	            document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
	            fn_saveCarrito();
	        }
	    } else { 
	        var product = await fn_getProductById(idP, idV, idProveedor);
	        
	        if( product ) {
	            var productSession = null;
	            cantidad += quantity;
	            console.log(product);

	            if (cartProducts) {
	                cartProducts.forEach(function(e) { 
	                    console.log("Elemento de cartProducts: " + e.nameEs + ", idProveedor = " + e.idProveedor + ", idProducto = " + e.product_id + ", variante = " + e.variant_id);
	                });
	                productSession = cartProducts.find((p) => (p.idProveedor == idProveedor && p.product_id == idP && p.variant_id == idV));
	            }

	            if (productSession) {
	                product.quantity = (parseInt(productSession.quantity) - cantidad);
	                console.log("Producto " + product.nameEs + ", cantidad: " + product.quantity + "stock: " + product.stock);
	            }
	            product.stock = parseInt(product.stock) + cantidad;
	            
	            if( product.stock > 0 ) {
	                listCarrito.add(product);

	                precioTotal -= product.price;
	                var totalPorProducto = product.quantity * product.price;

	                if ($('#idCesta').find('#' + idP + idV + idProveedor).length) {
	                    $('#idCesta').find('#' + idP + idV + idProveedor).remove();
	                }

	                $('#idCesta').append(
	                    "<div id=\"" + idP + idV + + idProveedor + "\" class='cart-entry clearfix'>"
	                    + " <a style='width: 15%;' class='cart-entry-thumbnail' href='#'>"
	                    + "<img src='" + product.imageData + "' alt='' />"
	                    + "</a>"
	                    + " <div class='cart-entry-description'>"
	                    + "   <table>"
	                    + "     <tr>"
	                    + "       <td>"
	                    + "         <div class='h6'>"
	                    + "           <a href='#'>" + product.nameEs + "</a>"
	                    + "         </div>"
	                    + "         <div class='simple-article size-1'>CANTIDAD: <div id='" + idP + idV + idProveedor + "'>" + product.quantity + "</div></div>"
	                    + "       </td>"
	                    + "       <td>"
	                    + "         <div class='simple-article size-3 grey'>" + product.price + "</div>"
	                    + "         <div class='simple-article size-1'>TOTAL: " + totalPorProducto + "</div>"
	                    + "       </td>"
	                    + "       <td>"
	                    + "         <div class='cart-color' style='background: #facc22;'></div>"
	                    + "       </td>"
	                    + "       <td>"
	                    + "         <div class='button-close'></div>"
	                    + "       </td>"
	                    + "     </tr>"
	                    + "   </table>"
	                    + " </div>"
	                    + "</div>"
	                );

	               if( productSession ) { 
                	numProdCarrito = fn_getTotalProductsInCart( cartProducts ) - quantity;
                }else{
                	numProdCarrito += cantidad;
                }
	              
	             	if (document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito')) document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito').innerHTML = totalPorProducto;
	                if (document.getElementById('idStockProd')) document.getElementById('idStockProd').innerHTML = product.stock;
	                if (document.getElementById('cantidadCarrito')) document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
	                if (document.getElementById('idTotal')) document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
	                if (document.getElementById('totalConIva')) document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;

	                fn_saveCarrito();
	            } else {
	                swal("No hay Stock del producto. ");
	            }
	        }
	    }
}*/

async function fn_removeCarrito(idP, idV, idProveedor, quantity) {
	console.log("--------------- fn_removeCarrito()-----------------");
	    //TASK: aquí ya hay que guardar en la sesión los productos de la cesta
	    listCarrito = [];
	    cantidad = 0;
	    quantity = parseInt(quantity);
	    const cartProducts = await traerProdSesion();

	    if (idP == null && idV == null) {  
	        cantidad += quantity; 
	        var prodSelect = null; 
	        prodSelect = listFilter.filter((p) => (p.idProduct == idP)); 

	        if (prodSelect != null) {
	            listCarrito.add(prodSelect[0]);
	            $('#idCesta').append("<div class='cart-entry clearfix' id=" + prodSelect[0].id + ">  <a style='width: 15%;' class='cart-entry-thumbnail' href='#'><img src='resources/jimTienda/designUX/img/product-3.png' alt='' /></a>  <div class='cart-entry-description'>   <table>    <tr>     <td>      <div class='h6'><a>" + prodSelect[0].nameEs + "</a></div>      <div class='simple-article size-1'>CANTIDAD: " + cantidad + "</div>     </td>     <td>      <div class='simple-article size-3 grey'>" + prodSelect[0].price + "</div>      <div class='simple-article size-1'>TOTAL: 310.00</div>     </td>     <td>      <div class='cart-color' style='background: #facc22;'></div>     </td>      </tr>   </table>  </div> </div>");
	            numProdCarrito += quantity;
	            document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
	            precioTotal += prodSelect[0].price;
	            document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
	            document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;
	            fn_saveCarrito();
	        }
	    } else {
	    	try{
	    		 var product = await fn_getProductById(idP, idV, idProveedor);
	 	        
	 	        if( product ) {
	 	            var productSession = null;
	 	            cantidad += quantity;
	 	            console.log(product);

	 	            if (cartProducts) {
	 	                cartProducts.forEach(function(e) { 
	 	                    console.log("Elemento de cartProducts: " + e.nameEs + ", idProveedor = " + e.idProveedor + ", idProducto = " + e.product_id + ", variante = " + e.variant_id);
	 	                });
	 	                productSession = cartProducts.find((p) => (p.idProveedor == idProveedor && p.product_id == idP && p.variant_id == idV));
	 	            }
					
	 	            if (productSession) {
	 	            	if(productSession.quantity > 1) {
	 	            		product.quantity = (parseInt(productSession.quantity) - cantidad);
		 	               	product.stock = parseInt(product.stock) + cantidad;

		 	                listCarrito.add(product);

		 	                precioTotal -= product.price;
		 	                var totalPorProducto = product.quantity * product.price;

		 	                if ($('#idCesta').find('#' + idP + idV + idProveedor).length) {
		 	                    $('#idCesta').find('#' + idP + idV + idProveedor).remove();
		 	                }

		 	                $('#idCesta').append(
		 	                    "<div id=\"" + idP + idV + + idProveedor + "\" class='cart-entry clearfix'>"
		 	                    + " <a style='width: 15%;' class='cart-entry-thumbnail' href='#'>"
		 	                    + "<img src='" + product.imageData + "' alt='' />"
		 	                    + "</a>"
		 	                    + " <div class='cart-entry-description'>"
		 	                    + "   <table>"
		 	                    + "     <tr>"
		 	                    + "       <td>"
		 	                    + "         <div class='h6'>"
		 	                    + "           <a href='#'>" + product.nameEs + "</a>"
		 	                    + "         </div>"
		 	                    + "         <div class='simple-article size-1'>CANTIDAD: <div id='" + idP + idV + idProveedor + "'>" + product.quantity + "</div></div>"
		 	                    + "       </td>"
		 	                    + "       <td>"
		 	                    + "         <div class='simple-article size-3 grey'>" + product.price + "</div>"
		 	                    + "         <div class='simple-article size-1'>TOTAL: " + totalPorProducto + "</div>"
		 	                    + "       </td>"
		 	                    + "       <td>"
		 	                    + "         <div class='cart-color' style='background: #facc22;'></div>"
		 	                    + "       </td>"
		 	                    + "       <td>"
		 	                    + "         </div>"
		 	                    + "       </td>"
		 	                    + "     </tr>"
		 	                    + "   </table>"
		 	                    + " </div>"
		 	                    + "</div>"
		 	                );

		 	               	if( productSession ) { 
		                 		numProdCarrito = fn_getTotalProductsInCart( cartProducts ) - quantity;
		                 	}else{
		                 		numProdCarrito += cantidad;
		                 	}
		 	              
		 	             	if (document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito')) document.getElementById('' + idP + idV + idProveedor + 'idTotalProductoCarrito').innerHTML = totalPorProducto;
		 	                if (document.getElementById('idStockProd')) document.getElementById('idStockProd').innerHTML = product.stock;
		 	                if (document.getElementById('cantidadCarrito')) document.getElementById('cantidadCarrito').innerHTML = numProdCarrito;
		 	                if (document.getElementById('idTotal')) document.getElementById('idTotal').innerHTML = precioTotal.toFixed(2);
		 	                if (document.getElementById('totalConIva')) document.getElementById('totalConIva').innerHTML = precioTotal.toFixed(2) + " " + txtIva;

		 	                fn_saveCarrito();
	 	            	}else{
	 	            		removeProducto(idP);
	 	            	}
	 	            	fn_actualizarCarrito();
	 	            }
	 	        }
	    	}catch{
	    		console.log("Ha ocurrido un error durante la solicitud: " + error);
	  			swal("No se ha podido procesar la solicitud, intentelo más tarde");
	    	} 
	    }
}

/****************************MIS PEDIDOS ****************************************/

function fn_misPedidos(){
	var params = {};
	params["idCliente"] = idCli;
	$.ajax({
		url : "/GestPlus/misPedidos",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal("Se ha producido un error: " + errorMessage);
			} else {
				data.misPedidos.forEach(item => {
					var fila = document.createElement("tr");
					
					var celdaId = document.createElement("td");
					celdaId.textContent = item.id;
					fila.appendChild(celdaId);

					var celdaProd = document.createElement("td");
					celdaProd.textContent = item.producto;
					fila.appendChild(celdaProd);

					var celdaRef = document.createElement("td");
					celdaRef.textContent = item.reference;
					fila.appendChild(celdaRef);

					var celdaFecha = document.createElement("td");
					celdaFecha.textContent = item.fechaCompra;
					fila.appendChild(celdaFecha);
					
					var celdaDev = document.createElement("td");
					if(item.devuelto){
						var celdaLabel = document.createElement("label");
						celdaLabel.textContent = 'Devuelto';
						celdaDev.appendChild(celdaLabel);
					}else{
						var celdaButton = document.createElement("button");
						celdaButton.textContent = 'Devolver';
						//celdaButton.classList.add(fn_devolver(item.id,item.producto));
						celdaButton.addEventListener("click", function() {
				            fn_devolver(item.id,item.producto); 
        				});
						celdaDev.appendChild(celdaButton); 
					}
					
					fila.appendChild(celdaDev);
					
					tablePedidos.appendChild(fila); 
				});
			}
		},
		dataType : "json" 
	});
}

function fn_devolver(idProdDev, nombreProducto){
	idProductoDevolver = idProdDev;
	idNombreProdDev.value = nombreProducto;
	document.getElementById('idDivMotivoDevol').style.display='block';
}

function fn_sendDevolucion(){ // le llega un correo a Pedro y él gestiona la devolución con el proveedor que corresponda
	var params = {};
	params["idProductoPedido"] = idProductoDevolver;
	params["idCliente"] = idCli;
	params["idMotivo"] = idM.value;
	params["observaciones"] = idObservaciones.value;
	
	$.ajax({
		url : "/GestPlus/sendDevolucion",
		type : "POST",
		data : params,
		success : function(data, textStatus) {
			var errorMessage = data.error;
			if (typeof (errorMessage) !== "undefined"
					&& errorMessage !== null && errorMessage !== '') {
				swal("Se ha producido un error: " + errorMessage);
			} else {
				 swal("Producto devuelto con éxito.");
				 window.location.href= "okeymasTiendaMisPedidos.html";
			}
		},
		dataType : "json"
	});
}

function fn_showhidePolitica(){
	if(document.getElementById('politicaDevol').style.display == 'block'){
		document.getElementById('politicaDevol').style.display='none';
	}else{
		document.getElementById('politicaDevol').style.display='block';
	}
}

/***************************TODOS LOS PRODUCTOS****************************/

function traerProductosByProv(idProveedor){ 
	console.log("traerProductosByProv");
	document.getElementById("loader").classList.remove("hidden"); //mostrar el cargando
	switch (idProveedor) { 
	case 1: // JIM
	case '1': // JIM
		document.getElementById('idProvSelecAllProd').innerHTML = "MATERIAL DEPORTIVO";
		document.getElementById('idMenuProvSelec').innerHTML = "MATERIAL DEPORTIVO";
		if(allProductsJim == undefined){
			var allProductsJimPromise = $.getJSON("/GestPlus/findAllProducts", function(json) {
		        allProductsJim = json.listProductos;
		        
		        mostrar(0,xPag,idProveedor);
			    nPag = Math.ceil(allProductsJim.length / xPag);
			    $("#botones").empty();
			    mostrarPaginacion(nPag,allProductsJim,idProveedor); 
		    });
		}else{
	        mostrar(0,xPag,idProveedor);
		    nPag = Math.ceil(allProductsJim.length / xPag);
		    $("#botones").empty();
		    mostrarPaginacion(nPag,allProductsJim,idProveedor); 
		}
		break;
	case 2: // HYPER
	case '2':
		document.getElementById('idProvSelecAllProd').innerHTML = "SUPLEMENTACIÓN DEPORTIVA"; 
		document.getElementById('idMenuProvSelec').innerHTML = "SUPLEMENTACIÓN DEPORTIVA";
		if(allProductsHyper == undefined){
			var allProductsHyperPromise = $.getJSON("/GestPlus/findAllHyperProducts", function(json) {
				allProductsHyper = json.listProductos;
		        mostrar(0,xPag,idProveedor);
			    nPag = Math.ceil(allProductsHyper.length / xPag);
			    $("#botones").empty();
			    mostrarPaginacion(nPag,allProductsHyper,idProveedor); 
		    });
		}else{
			 mostrar(0, xPag, idProveedor);
             nPag = Math.ceil(allProductsHyper.length / xPag);
             $("#botones").empty();
             mostrarPaginacion(nPag, allProductsHyper, idProveedor);
		}
        break;
	     
	case 3: // NATUR 
	case '3':
		document.getElementById('idProvSelecAllProd').innerHTML = "PRODUCTOS NATURALES";
		document.getElementById('idMenuProvSelec').innerHTML = "PRODUCTOS NATURALES";
		
		if(allProductsNatur == undefined){
			var allProductsNaturPromise = $.getJSON("/GestPlus/findAllNaturProducts", function(json) {
		        allProductsNatur = json.listProductos;
		        mostrar(0,xPag,idProveedor);
			    nPag = Math.ceil(allProductsNatur.length / xPag);
			    $("#botones").empty();
			    mostrarPaginacion(nPag,allProductsNatur,idProveedor); 
		    });
		}else{ // para no volver a llamar al action
			mostrar(0,xPag,idProveedor);
		    nPag = Math.ceil(allProductsNatur.length / xPag);
		    $("#botones").empty();
		    mostrarPaginacion(nPag,allProductsNatur,idProveedor); 
		}
		break;
	default:
		break;
	} 
	
	$.when(allProductsJimPromise, allProductsHyperPromise, allProductsNaturPromise).done(function() {
		document.getElementById("loader").classList.add("hidden"); //para quitar el cargando
    });
}


/*function mostrarPaginacion(t,prods,idProveedor){
    var botones = '';
    for(var i = 0; i < t; i++){
        var cada = '';
        cada = "<a class='pagination'>"+(i+1)+"</a>";
        botones += cada; 
    }
    $('#botones').append(botones);
 	  // Poner oyentes a cada botón
    var losBotones = document.querySelectorAll('#botones a');
    for(var i = 0; i < losBotones.length; i++){
        losBotones[i].addEventListener('click',function(){
       	 	quitarActivo(); 
            var indice = parseInt(this.textContent);
            var o = (indice -1) * xPag;
            var h = indice * xPag;
            mostrar(o,h,idProveedor);
            mostrarPaginacion(t,prods,idProveedor);
            $(this).addClass('active');  //para que el botón se vea resaltado
            //$(window).scrollTop(0);  // para volver al inicio de la página  
        });
    } 
}*/

function mostrarPaginacion(t,prods,idProveedor){
	console.log("Se esta llamando a mostrar Paginacion");
	mostrarBotones(t, prods, idProveedor);
	
	/*var botones = '';
    for(var i = 0; i < t; i++){
        var cada = '';
        cada = "<a class='pagination'>"+(i+1)+"</a>";
        botones += cada; 
    }
    $('#botones').append(botones);
 	  // Poner oyentes a cada botón
    var losBotones = document.querySelectorAll('#botones a');
    for(var i = 0; i < losBotones.length; i++){
        losBotones[i].addEventListener('click',function(){
       	 	quitarActivo(); 
            var indice = parseInt(this.textContent);
            var o = (indice -1) * xPag;
            var h = indice * xPag;
            mostrar(o,h,idProveedor);
            mostrarPaginacion(t,prods,idProveedor);
            $(this).addClass('active');  //para que el botón se vea resaltado
            //$(window).scrollTop(0);  // para volver al inicio de la página  
        });
    } */
}

function mostrar(desde,hasta,idProveedor){ // cuando filtramos por proveedor en la pantalla de allProducts
	listFilter = new Array();
	switch (idProveedor) {
	case 1:
	case '1':
		listFilter = allProductsJim;
		totales = listFilter.length;
		break;
	case 2:
	case '2':
		listFilter = allProductsHyper;
		totales = listFilter.length;
		break;
	case 3:
	case '3': 
		listFilter = allProductsNatur;
		totales = listFilter.length;
		break;
	default:
		break;
	}
		
	$("#idContentAllProducts").empty();
	
	var h = hasta;
	if(hasta>totales){
		h=totales;
	}   
	
    
    for(var i = desde; i < h; i++){    
		if(listFilter[i].idProveedor == 1){ // si es Jimsport la imagen no está en base64

			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=1'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",1)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span> <span class='glyphicon glyphicon-euro color'></span></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].descripcion+"</div>   </div> </div> </div>");			
		}else if(listFilter[i].idProveedor == 2){ // si es Hypertrophy la imagen SI está en base64
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+listFilter[i].idProduct+"&idProveedor=2'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",2)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span> <span class='glyphicon glyphicon-euro color'></span></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].nameEs+"</div>   </div> </div> </div>");
		}else if(listFilter[i].idProveedor == 3){ // si es Naturatal
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+listFilter[i].idProduct+"&idProveedor=3'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",3)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span> <span class='glyphicon glyphicon-euro color'></span></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].descripcion+"</div>   </div> </div> </div>");

		}
    }
}

/***************************CARGAR PRODUCTOS****************************/

//para los productos de Hypertrophy
/*var fetchCompressedJson = async function () {
    try {
        // Solicitar los datos
        const response = await fetch('findAllHyperProducts');

        // Leer directamente el JSON sin descomprimir
        const jsonData = await response.json();
        
        return jsonData; // Devolver los datos
    } catch (error) {
        console.error("Error al obtener el JSON:", error);
        return null; // Manejo del error
    }
};*/


function traerProductos(pagina, filtro){ 
	console.log("traerProductos");
	console.log("1: " + new Date());
	console.log("FILTRO:  " + filtro);
	document.getElementById("loader").classList.remove("hidden");//mostrar el cargando
	//window.addEventListener("load", function() {
		// Llamadas AJAX con promesas 
	    var allProductsJimPromise = $.getJSON("/GestPlus/findAllProducts", function(json) {
	        allProductsJim = json.listProductos;
	        //document.getElementById('idCargarJim').click(); // aquí no porque sino no funciona la página de allProducts
	    }); 
	
	    var allProductsNaturPromise = $.getJSON("/GestPlus/findAllNaturProducts", function(json) {
	        allProductsNatur = json.listProductos;
	    });
	    
	    var allProductsHyperPromise = $.getJSON("/GestPlus/findAllHyperProducts", function(json) {
	    	allProductsHyper = json.listProductos;
	    });  
	
	    
	    // Llamada a la función y asignación del resultado
	   //var allProductsHyperPromise = (async () => { allProductsHyper = await fetchCompressedJson();   })();
	    
	    /*var allProductsHyperPromise = $.Deferred(function(defer) {
            fetchCompressedJson().then(function(data) {
                allProductsHyper = data;
                defer.resolve(); // Resolver la promesa Deferred
            }).catch(function(error) {
                defer.reject();
            });
        }).promise();*/   
	
	    // Usar $.when para asegurarte de que todas las llamadas AJAX terminen antes de ejecutar mostrarListaTodos  
	    $.when(allProductsJimPromise, allProductsHyperPromise, allProductsNaturPromise).done(function() {
	        //mostrarListaTodos();  // Se ejecuta solo después de que todas las llamadas AJAX hayan finalizado  
	        console.log("2: " + new Date());  
		    mostrarListaTodos(0,xPag);
		    allProducts = allProductsJim.concat(allProductsHyper).concat(allProductsNatur);	//concateno las listas de todos los proveedores 
		    nPag = Math.ceil(allProducts.length / xPag);
		    mostrarBotones(nPag,allProducts); 
		    document.getElementById("loader").classList.add("hidden"); 
		    
		    if(pagina==0){
		    	document.getElementById('idCargarJim').click();
		    } 
		    if(filtro != null && filtro != '' ){
		    	busqueda(filtro);
		    }
	    });
	//});  
}

function cargarAllProductos(pagina, filtro){ 
	    var allProductsJimPromise = $.getJSON("/GestPlus/findAllProducts", function(json) {
	        allProductsJim = json.listProductos;
	    }); 
	
	    var allProductsNaturPromise = $.getJSON("/GestPlus/findAllNaturProducts", function(json) {
	        allProductsNatur = json.listProductos;
	    });
	    
	    var allProductsHyperPromise = $.getJSON("/GestPlus/findAllHyperProducts", function(json) {
	    	allProductsHyper = json.listProductos;
	    });  
		 return $.when(allProductsJimPromise, allProductsHyperPromise, allProductsNaturPromise).done(function() {
	      
		    allProducts = allProductsJim.concat(allProductsHyper).concat(allProductsNatur);	//concateno las listas de todos los proveedores 
		    
	    }); 
}


function cargarProductosByProv(idProveedor){ // no se puede usar este en allProducts porque no existen los elementos idCargarJim, idCargarHyper...
	switch (idProveedor) { 
	case 0: // todos los proveedores
		break;
	case 1: // JIM
		listFilter = allProductsJim;	
		document.getElementById('idCargarJim').click(); //para habilitar esa parte y sea visible
	break;
	case 2: // HYPER
		listFilter = allProductsHyper;	
		document.getElementById('idCargarHyper').click();
	break;
	case 3: // NATUR
		listFilter = allProductsNatur;	
		document.getElementById('idCargarNatur').click();
	break;
	default:
		break;
	}
	totales = listFilter.length;  
    nPag = Math.ceil(totales / xPag);
    offset = (pag - 1) * xPag;
    hasta = pag * xPag;
	mostrarLista(0,hasta, listFilter,totales);
	
}

/********************************************BÚSQUEDA********************************************/

function busqueda(filter){ //debe buscar en todos los proveedores 
	
	
	if(filter == null) filter = "Buscar...";
	if(txtFilterBase.value == ''){
		txtFilterBase.value = filter;
	}
	//console.log("buscar: " + txtFilterBase.value + ", filter value: " + filter);
	
	// Lee la frase del input
     var input = document.getElementById("txtFilterBase").value;
     
     // Separa la frase en palabras (elimina espacios adicionales)
     var words = input.split(/\s+/).filter(Boolean);
     console.log("Array de palabras:", words);
     
     
	
	//comprobar que las variables globales de los productos no sean null
	//porq hay pantallas donde esas variable están vacías
	
	if(allProductsJim == null || allProductsHyper == null || allProductsNatur == null){
		window.location.href= "https://gestplus.okmas.net/GestPlus/okeymasTiendaProductos?filter="+txtFilterBase.value;
		return;
	}
	
	allProducts = allProductsJim.concat(allProductsHyper).concat(allProductsNatur);	//concateno las listas de todos los proveedores 
	
	//listFilter = allProducts; 
	listFilter = []; 
	try{
		//if(txtFilterBase.value != "Buscar...") 
			
		words.forEach(function(word) {
			//listFilter = allProducts.filter((p) => (p.nameEs.includes(word) ||  p.nameEs.includes(word.toUpperCase()) ||  p.reference.includes(word) ||  p.reference.includes(word.toUpperCase()) || p.descripcion.includes(word) || p.descripcion.includes(word.toUpperCase()) )  );
			
			listFilter = listFilter.concat(allProducts.filter((p) => (
			  p.nameEs.includes(word) ||
			  p.nameEs.includes(word.toUpperCase()) ||
			  p.reference.includes(word) ||
			  p.reference.includes(word.toUpperCase()) ||
			  p.descripcion.includes(word) ||
			  p.descripcion.includes(word.toUpperCase())
			)));
		});
	}catch (e) {
		console.log(e);  
	}
	
	
	$("#contentFilterSearch").empty();
	$("#idContentAllProducts").empty(); 
	
	console.log("Tamaño de la lista de productos: " + listFilter.length);
	if(listFilter.length > 0){
		mostrarResultadoBusqueda(0,pag * xPag, listFilter,listFilter.length);  
		nPag = Math.ceil(listFilter.length / xPag);
	    offset = (pag - 1) * xPag;
	    hasta = pag * xPag;
		
	    mostrarBotones(nPag,listFilter, null);
	}
	
	if(document.getElementById('resultSearch') != null){
		document.getElementById('resultSearch').click();
	}
	
}

function normalizeText(text) {
    return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}

/**
 * Realiza una búsqueda de productos basada en palabras clave ingresadas por el usuario.
 * Aplica un sistema de ponderación para priorizar los resultados más relevantes.
 * 
 * Funcionalidad:
 * - Extrae palabras clave de la consulta eliminando palabras vacías (stopwords).
 * - Normaliza los textos para hacer comparaciones más precisas.
 * - Asigna diferentes pesos a las coincidencias en distintos campos (nombre, categoría, referencia y descripción).
 * - Aplica bonificaciones si todas las palabras clave están en el nombre o si hay coincidencias en la categoría.
 * - Ordena los resultados según el puntaje de relevancia y los muestra en la interfaz.
 * - Si no hay productos cargados en memoria, redirige a otra página para ejecutar la búsqueda allí.
 * 
 * @function busqueda
 * @returns {void}
 */
 
 
/*function busqueda() { 
    document.getElementById("loader").classList.remove("hidden");

    if (txtFilterBase.value == '') return;

    if (allProductsJim == null || allProductsHyper == null || allProductsNatur == null) {
        window.location.href = "https://gestplus.okmas.net/GestPlus/okeymasTiendaProductos?filter=" + txtFilterBase.value;
        return;
    }
    
    function extractKeywords(text) {
        const stopwords = new Set(["de", "la", "los", "el", "las", "y", "a", "en", "con", "por", "para", "del", "un", "una", "unos", "unas", "al"]);
        
        return text
            .split(/\s+/) // Dividir por espacios
            .filter(word => !stopwords.has(word)) // Filtrar palabras vacías
            .join(" "); // Volver a unir en una string limpia
    }
    var cleanedQuery = extractKeywords(normalizeText(txtFilterBase.value));
    console.log("keywords: " + cleanedQuery);

    var words = normalizeText(cleanedQuery).split(" "); // Separar palabras clave
    console.log(words);

    listFilter = allProducts
      .map((p) => {
        // Normalizar los textos de cada campo
        var nameText = normalizeText(p.nameEs);
        var categText = normalizeText(p.categ);
        var referenceText = normalizeText(p.reference);
        var descriptionText = normalizeText(p.descripcion);
        
        if(categText == "balones") categText = "balon";

        // Ajustamos los pesos de los campos
        var weights = {
          name: 5,        
          category: 2,    
          reference: 1.5, 
          description: 0.5 
        };

        // Asignar pesos decrecientes a las palabras según su posición
        var wordWeights = words.map((_, index) => {
          if (index === 0) return 2.0; 
          if (index === 1) return 1.5; 
          return 1.0; 
        });

        // Función para contar coincidencias exactas y aplicar ponderación
        var countMatches = (text, fieldWeight, wordWeight = 1.0) => {
          return words.reduce((total, word, index) => {
            var regex = new RegExp("\\b" + word + "\\b", "gi"); // Búsqueda exacta con regex
            var matches = text.match(regex);
            return total + (matches ? matches.length * fieldWeight * wordWeights[index] : 0);
          }, 0);
        };

        // Calcular el puntaje total ponderado
        var matchCount =
          countMatches(nameText, weights.name) +
          countMatches(categText, weights.category) +
          countMatches(referenceText, weights.reference) +
          countMatches(descriptionText, weights.description);

        //  Si todas las palabras están en el nombre, el producto se prioriza FUERTE
        if (words.every(word => nameText.includes(word))) {
          matchCount *= 2.0; 
        }

        //  Si todas las palabras están en el nombre Y la categoría es relevante, subimos un poco más
        if (words.every(word => nameText.includes(word)) && words.some(word => categText.includes(word))) {
          matchCount *= 1.3; 
        }

        // Si al menos una palabra está en la categoría, le damos un mini-bono
        if (words.some(word => categText.includes(word))) {
          matchCount *= 1.1; 
        }

        if (matchCount > 0)
          console.log("Para el producto " + p.nameEs + ", existen " + matchCount + " coincidencias ponderadas");

        return { product: p, matchCount };
      })
      .filter((item) => item.matchCount > 0) // Filtrar productos con al menos 1 coincidencia
      .sort((a, b) => b.matchCount - a.matchCount) // Ordenar de mayor a menor coincidencia
      .map((item) => item.product); // Extraer los productos


    $("#contentFilterSearch").empty();
    $("#idContentAllProducts").empty(); 

    if (listFilter.length > 0) {
        mostrarResultadoBusqueda(0, pag * xPag, listFilter, listFilter.length);  
        nPag = Math.ceil(listFilter.length / xPag);
        mostrarBotones(nPag, listFilter, null);
    }

    if (document.getElementById('resultSearch') != null) {
        document.getElementById('resultSearch').click();
    }

    document.getElementById("loader").classList.add("hidden");
}*/



 /**
  * Realiza una búsqueda de productos filtrando por una categoría específica.
  * 
  * Funcionalidad:
  * - Asigna el nombre de la categoría al campo de búsqueda (`txtFilterBase`).
  * - Llama a la función `busqueda()` para ejecutar la búsqueda con el nuevo filtro.
  * 
  * @function fn_busquedaCategoria
  * @param {string} productName - Nombre de la categoría a buscar.
  * @returns {void}
  */
function fn_busquedaCategoria(productName) {
	if(normalizeText(productName).trim().toLowerCase() === 'catalogo general') window.location.href = "okeymasTiendaProductos.html";
	
	txtFilterBase.value = productName;
	busqueda();
}


/******************************* INFO DE UNA VARIANTE EN CONCRETO *********************************/

function fn_mostrarVariante(){
	console.log(idListAtrib1.value);
	console.log(idListAtrib2.value);
	//cambiar el precio, la referencia, el stock y la imagen
	
	var params = {};
	params["atributo1"]   = idListAtrib1.value;
	params["atributo2"]   = idListAtrib2.value;
	params["idProveedor"] = elProv;
	params["idProduct"]   = idProducto;
	
	$.ajax({
		url : "/GestPlus/filterByAtributos",
		type : "POST",
		data : params,
		// myDataTable migth not exist  
		success : function(data, textStatus) {
			// Selecciona el elemento por su id
			var imagenProdDiv = document.getElementById("idImagenProd");

			switch (elProv) {
			case '1':
				if(data.productoJim != null){
					// Asigna una nueva URL de imagen
					//const nuevaImagenURL = data.productoJim.imageData;
					//imagenProdDiv.setAttribute("data-background", nuevaImagenURL);
					imagenProdDiv.setAttribute("data-background", data.productoJim.imageData);
					//swiper.lazy.load();
					
					
					document.getElementById('idPrecioProd').innerText = data.productoJim.price;
				    document.getElementById('idNombreProd').innerText = data.productoJim.nameEs;
				    document.getElementById('idProdSelect').innerText = data.productoJim.nameEs;
				    document.getElementById('idRefProd').innerText = data.productoJim.reference;
				    document.getElementById('idStockProd').innerText = data.productoJim.stock;
				    document.getElementById('idProvProd').innerText = data.productoJim.nomProveedor;  // para la info de la derecha
					document.getElementById('idProvSelect').innerText = data.productoJim.nomProveedor;
					idProducto = data.productoJim.idProduct;
					idProdVariant= data.productoJim.prodVariant;
				}else{
					document.getElementById('idPrecioProd').innerText = 'No existe';
				    document.getElementById('idRefProd').innerText = 'No existe';
				    document.getElementById('idStockProd').innerText = 'No existe';
				    document.getElementById('btnAddCarrito').removeAttribute('href');//deshabilito el botón de Añadir
				}
				break;
			case '2':
				if(data.productoHyper != null){
					document.getElementById('idPrecioProd').innerText = data.productoHyper.price;
				    document.getElementById('idNombreProd').innerText = data.productoHyper.nameEs;
				    document.getElementById('idProdSelect').innerText = data.productoHyper.nameEs;
				    document.getElementById('idRefProd').innerText = data.productoHyper.reference;
				    document.getElementById('idStockProd').innerText = data.productoHyper.stock;
				    document.getElementById('idProvProd').innerText = data.productoHyper.nomProveedor;  // para la info de la derecha
					document.getElementById('idProvSelect').innerText = data.productoHyper.nomProveedor;
					idProducto = data.productoHyper.idProduct;
					idProdVariant= data.productoHyper.prodVariant;
				}else{
					document.getElementById('idPrecioProd').innerText = 'No existe';
				    document.getElementById('idRefProd').innerText = 'No existe';
				    document.getElementById('idStockProd').innerText = 'No existe';
				    document.getElementById('btnAddCarrito').removeAttribute('href');//deshabilito el botón de Añadir
				}
				break;
			case '3':
				if(data.productoNatur != null){
					document.getElementById('idPrecioProd').innerText = data.productoNatur.price;
				    document.getElementById('idNombreProd').innerText = data.productoNatur.nameEs;
				    document.getElementById('idProdSelect').innerText = data.productoNatur.nameEs;
				    document.getElementById('idRefProd').innerText = data.productoNatur.reference;
				    document.getElementById('idStockProd').innerText = data.productoNatur.stock;
				    document.getElementById('idProvProd').innerText = data.productoNatur.nomProveedor;  // para la info de la derecha
					document.getElementById('idProvSelect').innerText = data.productoNatur.nomProveedor;
					idProducto = data.productoNatur.idProduct;
					idProdVariant= data.productoNatur.prodVariant;
				}else{
					document.getElementById('idPrecioProd').innerText = 'No existe';
				    document.getElementById('idRefProd').innerText = 'No existe';
				    document.getElementById('idStockProd').innerText = 'No existe'; 
				    document.getElementById('btnAddCarrito').removeAttribute('href');//deshabilito el botón de Añadir
				}
				break;
			}
		}, 
		dataType : "json"   
	});
}

/******************************* VER PRODUCTOS *********************************/
function mostrarBotones(size, products, idProveedor) {
    console.log("Llamada a mostrarBotones");
    var btnItems = ''; // Contenedor de los botones
    var btn;

    var btnActive = document.querySelector('#botones .pagination.active');
    var pageIndex = 1;
    if (btnActive) pageIndex = parseInt(btnActive.textContent); // Si existe un botón activo, obtenemos el valor

    var btnBefore = "<a class='pagination' id='btnBefore'>&lt;</a>";
    var btnNext = "<a class='pagination' id='btnNext'>&gt;</a>";

    // Limpiar el contenedor de los botones
    $('#botones').empty();

    if (size >= 10) {
        var nButtons = 3; // Número de botones
        var firstInit = (pageIndex > 1 && pageIndex <= size - 10) ? pageIndex - 1 : 1;
        var secondInit = (pageIndex <= size - nButtons) ? size - nButtons : size - nButtons + 1;

        for (var i = 0; i < nButtons; i++) {
            if ((firstInit + i) < secondInit) {
                btn = "<a class='pagination'>" + (firstInit + i) + "</a>";
            } else {
                btn = "<a class='pagination'>" + (i + 1) + "</a>";
            }
            btnItems += btn;
        }

        if (secondInit > firstInit) {
            btnItems += "<a class='pagination'> ... </a>";
            for (var i = 0; i < nButtons; i++) {
            	if(secondInit + i < size)
                	btnItems += "<a class='pagination'>" + (secondInit + i) + "</a>";
            }
        }
    } else {
        for (var i = 0; i < size; i++) {
            btnItems += "<a class='pagination'>" + (i + 1) + "</a>";
        }
    }

    $('#botones').append(btnBefore + btnItems + btnNext);
    
    // Seleccionar todos los botones generados
    var btnElements = $('#botones .pagination');
	
    // Marcar como activo boton de la pagina actual
    btnElements.each(function (index, element) {
        if (parseInt($(element).text()) === pageIndex) {
            $(element).addClass('active');
        }
    });

    // Poner oyentes a cada botón
    $('#botones .pagination').click(function () {
        quitarActivo();
        console.log("He pulsado el boton " + this.textContent);

        var indice = parseInt(this.textContent);
        if (!isNaN(indice)) {
            var o = (indice - 1) * xPag;
            var h = indice * xPag;
            $(this).addClass("active");

            mostrarResultadoBusqueda(o, h, products, products.length);
            mostrarBotones(size, products, idProveedor);
        }
    });

    // Evento de clic para "Anterior"
    $('#btnBefore').click(function () {
        if (pageIndex > 1) {
            quitarActivo();
            pageIndex--;
            console.log("He pulsado el boton Anterior");

            var o = (pageIndex - 1) * xPag;
            var h = pageIndex * xPag;
            
            
            
            $('#botones a').each(function () {
                if (parseInt($(this).text()) === pageIndex) {
                    $(this).addClass('active');
                }
            });
            
            mostrarResultadoBusqueda(o, h, products, products.length);
            mostrarBotones(size, products, idProveedor);
        }
    });

    // Evento de clic para "Siguiente"
    $('#btnNext').click(function () {
        if (pageIndex < size) {
            quitarActivo();
            pageIndex++;
            console.log("He pulsado el boton Siguiente");

            var o = (pageIndex - 1) * xPag;
            var h = pageIndex * xPag;
            
            $('#botones a').each(function () {
                if (parseInt($(this).text()) === pageIndex) {
                    $(this).addClass('active');
                }
            });
            mostrarResultadoBusqueda(o, h, products, products.length);
            mostrarBotones(size, products, idProveedor);
        }
    });
}

 
function quitarActivo(){
    var losBotones = document.querySelectorAll('#botones a');
    for(var i = 0; i < losBotones.length; i++){
        $(losBotones[i]).removeClass('active');
    }
}

function mostrarLista(desde,hasta, prods,totales){
	$("#contentFilterJim").empty();
	$("#contentFilterHyper").empty();
	$("#contentFilterNatur").empty();
	var h = hasta;
	if(hasta>totales){
		h=totales;
	} 
	var lista = '';     
	
	for(var i = desde; i < h; i++){    
		if(prods[i].idProveedor == 1){ // si es Jimsport la imagen no está en base64

			$('#contentFilterJim').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>MATERIAL DEPORTIVO</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src=" + prods[i].imageData + " alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+prods[i].idProduct+"&idProveedor=1' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",1)'>	  <span class='button-wrapper'> 	<span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong>  <span class='glyphicon glyphicon-euro'></span>  </div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].descripcion+"</div>  		</div> 	</div> </div>"); 
		}else if(prods[i].idProveedor == 2){ // si es Hypertrophy la imagen SI está en base64
			if(prods[i].imageData != null){
				$('#contentFilterHyper').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>SUPLEMENTACIÓN DEPORTIVA</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'>  <img src=" + prods[i].imageData + " alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=2' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",2)'>		<span class='button-wrapper'> 	<span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span></div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].nameEs+"</div>  	</div> 	</div> </div>");
			}else{
				$('#contentFilterHyper').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>SUPLEMENTACIÓN DEPORTIVA</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src='https://gestplus.okmas.net/GestPlus/resources/image/noImage.png' alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=2' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",2)'>		<span class='button-wrapper'> 	<span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span></div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].nameEs+"</div>  	</div> 	</div> </div>");
			}
		}else if(prods[i].idProveedor == 3){ // si es Naturatal
			$('#contentFilterNatur').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>PRODUCTOS NATURALES</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src=" + prods[i].imageData + " alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=3' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",3)'>	<span class='button-wrapper'> 	<span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span> </div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].descripcion+"</div>  	</div> 	</div> </div>");

		}
    }
	
} 

/**
 * @author Deporocio
 *
 * Función muestra productos pertenecientes al array "listFilter", desde el producto que se encuentre en la posicion indicado por la variable "desde"
 * hasta el producto que se encuentra en la variable "hasta - 1".
 */
function mostrarListaTodos(desde,hasta){
	allProducts = allProductsJim.concat(allProductsHyper).concat(allProductsNatur);	//concateno las listas de todos los proveedores 
	
	listFilter = new Array();
	listFilter = allProducts;
	totales = listFilter.length;
	
	$("#idContentAllProducts").empty();
	
// 	nPag = Math.ceil(totales / xPag); 
//     offset = (pag - 1) * xPag;
//     hasta = pag * xPag;
    
    
	var h = hasta;
	if(hasta>totales){
		h=totales;
	}   
    
    for(var i = desde; i < h; i++){    
		if(listFilter[i].idProveedor == 1){ // si es Jimsport la imagen no está en base64

			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+listFilter[i].idProduct+"&idProveedor=1'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",1)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].descripcion+"</div>   </div> </div> </div>");			
		}else if(listFilter[i].idProveedor == 2){ // si es Hypertrophy la imagen SI está en base64
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+listFilter[i].idProduct+"&idProveedor=2'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",2)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].nameEs+"</div>   </div> </div> </div>");
		}else if(listFilter[i].idProveedor == 3){ // si es Naturatal
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+listFilter[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+listFilter[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ listFilter[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+listFilter[i].idProduct+"&idProveedor=3'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ listFilter[i].idProduct +","+ listFilter[i].prodVariant +",3)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+listFilter[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+listFilter[i].descripcion+"</div>   </div> </div> </div>");

		}
    }
}

//mostrarResultadoBusqueda(0,pag * xPag, listFilter,listFilter.length);  
function mostrarResultadoBusqueda(desde, hasta, prods, totales){
	$("#contentFilterSearch").empty();
	$("#idContentAllProducts").empty();
	
	
	var h = hasta;
	if(hasta>totales){
		h=totales;
	} 
	var lista = '';     
	
	for(var i = desde; i < h; i++){    
		if(prods[i].idProveedor == 1){ 

			//relleno el content de okeymasTiendaUX
			$('#contentFilterSearch').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>MATERIAL DEPORTIVO</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src=" + prods[i].imageData + " alt='' /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+prods[i].idProduct+"&idProveedor=1' >      <span class='button-wrapper'>     <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span>      <span class='text'>Saber más</span></span> </a>  </span> 	</a>   	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",1)'>		<span class='button-wrapper'> 	<span class='icon'><img src='img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span></div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].descripcion+"</div>  		</div> 	</div> </div>"); 
			//relleno el content de okeymasTiendaProductos
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+prods[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ prods[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?jim_id="+prods[i].idProduct+"&idProveedor=1'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",1)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+prods[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+prods[i].descripcion+"</div>   </div> </div> </div>");
		}else if(prods[i].idProveedor == 2){ // si es Hypertrophy la imagen SI está en base64
			$('#contentFilterSearch').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>SUPLEMENTACIÓN DEPORTIVA</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src='https://gestplus.okmas.net/GestPlus/resources/image/noImage.png 'alt=''  /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=2'>  <span class='button-wrapper'>  <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span></span></a> 	</span> 	</a> 	</span> 	</a> 	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",2)'>		<span class='button-wrapper'> 	<span class='icon'><img src='img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span></div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].nameEs+"</div>  		</div> 	</div> </div>");
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+prods[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ prods[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=2'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",2)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+prods[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+prods[i].nameEs+"</div>   </div> </div> </div>");
		}else if(prods[i].idProveedor == 3){ // si es Naturatal
			$('#contentFilterSearch').append("<div class='col-sm-4'> <div class='product-shortcode style-1'><div class='title'><div class='simple-article size-1 color col-xs-b5'><a>PRODUCTOS NATURALES</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div></div><div class='preview'> <img src=" + prods[i].imageData + " alt=''  /><div class='preview-buttons valign-middle'> 	<div class='valign-middle-content'> <a class='button size-2 style-2' href='#'> 		<span class='button-wrapper'> 		<span class='icon'><img src='img/icon-1.png' alt=''></span> 	<a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=3'>  <span class='button-wrapper'>  <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span></span></a> 	</span> 	</a>  	</span> 	</a> 	<a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",3)'>		<span class='button-wrapper'> 	<span class='icon'><img src='img/icon-3.png' alt=''></span> 	<span class='text'>Añadir</span> </span> </a> 	</div> </div> </div> <div class='price'><div class='simple-article size-4 dark'><strong>"+prods[i].price+"</strong> <span class='glyphicon glyphicon-euro'></span> </div></div> 	<div class='description'><div class='simple-article text size-2'>"+prods[i].descripcion+"</div>  		</div> 	</div> </div>");
			$('#idContentAllProducts').append("<div class='col-sm-4'> <div class='product-shortcode style-1'> <div class='title'> <div class='simple-article size-1 color col-xs-b5'><a>"+prods[i].categ+"</a></div> <div class='h6 animate-to-green'><a>"+prods[i].nameEs+"</a></div> </div> <div class='preview'> <img src="+ prods[i].imageData +" alt=''> <div class='preview-buttons valign-middle'> <div class='valign-middle-content'> <a class='button size-2 style-2' href='https://gestplus.okmas.net/GestPlus/okeymasTiendaProduct?idProduct="+prods[i].idProduct+"&idProveedor=3'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-1.png' alt=''></span> <span class='text'>Saber más</span> </span> </a> <a class='button size-2 style-3' href='#' onclick='fn_findVariant("+ prods[i].idProduct +","+ prods[i].prodVariant +",3)'> <span class='button-wrapper'> <span class='icon'><img src='resources/jimTienda/designUX/img/icon-3.png' alt=''></span> <span class='text'>Añadir</span> </span> </a> </div> </div> </div> <div class='price'> <div class='simple-article size-4'><span class='color'><strong>"+prods[i].price+" </strong></span><span class='glyphicon glyphicon-euro color'></div> </div> <div class='description'> <div class='simple-article text size-2'>"+prods[i].descripcion+"</div>   </div> </div> </div>");

		}
    }
	
	
	//comprobar si contentFilter está vacío 
	var elem = document.getElementById('contentFilterSearch');
	if(elem != null && elem.children.length == 0){
		$('#contentFilterSearch').append("<div><h3>No hay artículos disponibles</h3></div>"); // una imagen de no hay artículos 
	}
	
	//si estoy en la pantalla de allProducts comprobar si idContentAllProducts está vacío 
	var elem = document.getElementById('idContentAllProducts');
	if(elem != null && elem.children.length == 0){
		$('#idContentAllProducts').append("<div><h3>No hay artículos disponibles</h3></div>"); // una imagen de no hay artículos 
	}

	//$(this).scrollTop(0); 
} 

/******************************************************FILTRO POR CATEGORÍA************************************************/
function filterProducts(categoria,idProveedor){ 
	var params = {};
	params["idCategoria"] = categoria; 
	
	switch (idProveedor) {
	case 1:
		$.ajax({
			url : "/GestPlus/filterByCategory",
			type : "POST",
			data : params,
			// myDataTable migth not exist 
			success : function(data, textStatus) {
				listFilter = new Array();
				listFilter = data.listProductos;
				totales = data.totalRecords;     
				mostrarLista(0,pag * xPag, data.listProductos,totales);  
				nPag = Math.ceil(data.totalRecords / xPag); 
				mostrarBotones(nPag,listFilter);
				document.getElementById('idContentFilterJim').style.display='block';
				document.getElementById('idContentFilterHyper').style.display='none';
				document.getElementById('idContentFilterNatur').style.display='none';
			}, 
			dataType : "json"   
		});  
		break;
	case 2:
		$.ajax({
			url : "/GestPlus/filterByHyperCategory",
			type : "POST",
			data : params,
			// myDataTable migth not exist 
			success : function(data, textStatus) {  
				listFilter = new Array();
				listFilter = data.listProductos;
				totales = data.totalRecords;   
				mostrarLista(0,pag * xPag, data.listProductos,totales);  
				nPag = Math.ceil(data.totalRecords / xPag); 
				mostrarBotones(nPag,listFilter);
			}, 
			dataType : "json"
		});  
	break;
	default:
		break;
	}
}

/******************************************************PAGO************************************************/
function validar(){
	 if ($('#idNombreEnvio').val()==''){
		swal("El nombre es obligatorio.");
		return false;
	 } else if ($('#idApellidosEnvio').val()==''){
		swal("El apellido es obligatorio.");
		return false;
	 } else if ($('#idDireccion').val()==''){
		swal("La dirección es obligatoria");
		return false;
	 } else if ($('#idNumeroEnvio').val()==''){
		swal("El número es obligatorio.");
		return false;
	 }  else if ($('#idLocalidad').val()==''){
		swal("La localidad es obligatoria");
		return false;
	 }else if ($('#idProvinciaEnvio').val()==''){
		swal("La provincia es obligatoria");
		return false;
	 }else if ($('#idCodPost').val()==''){
		swal("El cod postal es obligatorio.");
		return false;
	 } 
	 return true;
}

/*function fn_pago(){ // este paso lo que hace es crear el purchase en bd y abrir la pasarela de pago Redsys 
	
	if(validar()){
		if(confirm("Sus datos serán registrado en nuestra base de datos Es necesario registrarse para proceder con el pago, ¿está de acuerdo en que usemos sus datos?")){
			
			var params = {};
					
			params["nombre"] = idNombreEnvio.value;
			params["apellidos"] = idApellidosEnvio.value;
			params["email"] = idEmailEnvio.value;
			params["movil"] = idMovilEnvio.value;
			params["pwd"] = idPwdEnvio.value;
			//params["pwd"] = idRepeatPwdEnvio.value;
			
			if(idAceptaCondCh.checked)
				params["aceptaCondiciones"]=1;
			else
				params["aceptaCondiciones"]=0;
			
			if(idAceptaPromosCh.checked)
				params["aceptaPromos"]=1;
			else
				params["aceptaPromos"]=0;
			
			if(idAceptaComunCh.checked)
				params["aceptaComunicaciones"]=1;
			else
				params["aceptaComunicaciones"]=0;
		
			params["direccion.tipo"] = idTipoEnvio.value;
			params["direccion.street"] =  idDireccionEnvio.value; 
			params["direccion.street2"] = idNumeroEnvio.value; 
			params["direccion.zip"] = idCodPostEnvio.value; 
			params["direccion.city"] = idLocalidadEnvio.value;
			params["direccion.provincia"] =  idProvinciaEnvio.value; 
			params["direccion.country_code"] = "ES";
			
			var i=0;
			listCarrito.forEach((element) => {
				params["productos["+i+"].quantity"] = 1,
			    params["productos["+i+"].product_id"] = element.idProduct;
			    params["productos["+i+"].variant_id"] = element.prodVariant; 
			    params["productos["+i+"].idProveedor"] = element.idProveedor;
			    params["productos["+i+"].price"] = element.price;
			    params["productos["+i+"].imageData"] = element.imageData;
			    params["productos["+i+"].reference"] = element.reference;
			    params["productos["+i+"].nameEs"] = element.nameEs;
			    i++;
			}); 
		
			params["total"]=document.getElementById('idTotalPagar').innerHTML;  
			//params["total"] = 2.55;   	
			
			$.ajax({
				url : "/GestPlus/pagoTienda",
				type : "POST",
				data : params,
				// myDataTable migth not exist
				success : function(data, textStatus) {
					var errorMessage = data.error;
					if (typeof (errorMessage) !== "undefined"
							&& errorMessage !== null && errorMessage !== '') {
						swal("Se ha producido un error: " + errorMessage);
					} else {
						paramPurchase = data.paramPurchase;
						$("#paramPurchase").val(paramPurchase);
						signaturePurchase = data.signaturePurchase;
						$("#signaturePurchase").val(signaturePurchase);
						$('#frmPurchase').submit();
					}
				},
				dataType : "json"
			});
		}
	}
	return true;
}*/


function fn_pago() { 
    if (validar()) {
    	if(isLoggedIn.equals('true')){ 
	    	pagar(); 
    	}else{
    		if(confirm("Gracias por completar el formulario. Vamos a proceder a crear una cuenta con los datos proporcionados. ¿Desea continuar?")){
	    		pagar();
		    }
    	}
    }
    return true;
}

async function pagar(){
	var params = {};
    
    params["nombre"] = idNombreEnvio.value;
	params["apellidos"] = idApellidosEnvio.value;
	params["email"] = idEmailEnvio.value;
	params["movil"] = idMovilEnvio.value;
	params["pwd"] = idPwdEnvio.value;
	
	if(idAceptaCondCh.checked)
		params["aceptaCondiciones"]=1;
	else
		params["aceptaCondiciones"]=0;
	
	if(idAceptaPromosCh.checked)
		params["aceptaPromos"]=1;
	else
		params["aceptaPromos"]=0;
	
	if(idAceptaComunCh.checked)
		params["aceptaComunicaciones"]=1;
	else
		params["aceptaComunicaciones"]=0;

	params["direccion.tipo"] = idTipoEnvio.value;
	params["direccion.street"] =  idDireccionEnvio.value; 
	params["direccion.street2"] = idNumeroEnvio.value; 
	params["direccion.zip"] = idCodPostEnvio.value; 
	params["direccion.city"] = idLocalidadEnvio.value;
	params["direccion.provincia"] =  idProvinciaEnvio.value; 
	params["direccion.country_code"] = "ES";
	
	
	
    var i = 0;
    var productsWithoutStock = "";

    for (let element of listCarrito) {
        const product = await fn_getProductById(element.idProduct, element.prodVariant, element.idProveedor);

        if (parseInt(product.stock) >= parseInt(element.quantity)) {
            params["productos[" + i + "].quantity"] = element.quantity;
            params["productos[" + i + "].product_id"] = element.idProduct;
            params["productos[" + i + "].variant_id"] = element.prodVariant; 
            params["productos[" + i + "].idProveedor"] = element.idProveedor;
            params["productos[" + i + "].price"] = element.price;
            params["productos[" + i + "].imageData"] = element.imageData;
            params["productos[" + i + "].reference"] = element.reference;
            params["productos[" + i + "].nameEs"] = element.nameEs;
        } else {
            productsWithoutStock = productsWithoutStock + ", " + element.nameEs;
        }

        i++;
    }

    if (productsWithoutStock) {
        swal("Los productos: " + productsWithoutStock + ". No tienen stock suficiente para realizar el pedido");
    }

    params["total"] = document.getElementById('idTotalPagar').innerHTML;

    $.ajax({
        url: "/GestPlus/pagoTienda",
        type: "POST",
        data: params,
        success: function(data, textStatus) {
            var errorMessage = data.error;
            if (typeof (errorMessage) !== "undefined" && errorMessage !== null && errorMessage !== '') {
                swal("Se ha producido un error: " + errorMessage);
            } else {
                paramPurchase = data.paramPurchase;
                $("#paramPurchase").val(paramPurchase);
                signaturePurchase = data.signaturePurchase;
                $("#signaturePurchase").val(signaturePurchase);
                $('#frmPurchase').submit();
            }
        },
        dataType: "json"
    });
}



/******************************************************CONSULTAR UN PRODUCTO************************************************/

function fn_infoProduct(){	
	console.log("fn_infoProducttt");
	switch (elProv) {
	case '1':
	case 1:
		precio = '';
		//nombre = '';
		nombre= '';
		ref = '';
		stock = '';
		prov = '';
		nomProv = '';
		idProducto = '';
		idProdVariant= '';  
		desc = '';
		break;
	case '2':
	case 2:
		precio = ''; 
		nombre = ''; // c:out respeta las ñ y tildes
		ref = '';
		stock = '';
		prov = '';
		nomProv = '';
		idProducto = '';
		idProdVariant= '';  
		desc = '';
		
		break;
	case '3':
	case 3:
		precio = ''; 
		//nombre = '';
		nombre= '';  
		ref = '';
		stock = '';
		prov = '';
		nomProv = '';
		idProducto = '';
		idProdVariant= '';
		
		desc = '';
		
		aptoD = '' === "true" ? "SI" : "NO";
		aptoV = '' === "true" ? "SI" : "NO";
		bio = '' === "true" ? "SI" : "NO";
		cantMedida = '';
		congelado = '' === "true" ? "SI" : "NO";
		frio = '' === "true" ? "SI" : "NO";
		gluten = '' === "true" ? "SI" : "NO";
		huevo = '' === "true" ? "SI" : "NO";
		lactosa = '' === "true" ? "SI" : "NO";
		break;
	default:
		break;
	}
	document.getElementById("loader").classList.add("hidden");
}

function decodeHTML(html) { //para decodificar el texto cuando está escapado
    var textarea = document.createElement('textarea');
    textarea.innerHTML = html;
    //return textarea.value; 
 // Decodificar el texto y eliminar saltos de línea o espacios innecesarios
    return textarea.value.replace(/^\s+|\s+$/g, '').replace(/\n+/g, '\n').trim();
}

function sanitizeHTML(html) {
    // Reemplazar etiquetas duplicadas o mal formadas
    html = html.replace(/&lt;&lt;/g, '&lt;');
    html = html.replace('h2', 'h6');//cambio h2 por h8 
    // Crear un elemento para decodificar el texto
    var textarea = document.createElement('textarea');
    textarea.innerHTML = html;

    return textarea.value;
}

</script>

</body>
</html>
<!--   <div class="footer-form-block"> -->
<!--             <div class="container"> -->
<!--                 <div class="row"> -->
<!--                     <div class="col-lg-5 col-xs-b10 col-lg-b0"> -->
<!--                         <div class="cell-view empty-space col-lg-b50"> -->
<!--                             <h3 class="h3 light">no pierdas tu oportunidad</h3> -->
<!--                         </div> -->
<!--                     </div> -->
<!--                     <div class="col-lg-3 col-xs-b10 col-lg-b0"> -->
<!--                         <div class="cell-view empty-space col-lg-b50"> -->
<!--                             <div class="simple-article size-3 light transparent">cosigue tu descuento</div> -->
<!--                         </div> -->
<!--                     </div> -->
<!--                     <div class="col-lg-4"> -->
<!--                         <div class="single-line-form"> -->
<!--                             <input class="simple-input light" type="text" value="" placeholder="Escribe tu email aquí..."> -->
<!--                             <div class="button size-2 style-1"> -->




<!--                                 <input type="submit" value=""> -->
<!--                             </div> -->
<!--                         </div> -->
<!--                     </div> -->
<!--                 </div> -->
<!--             </div> -->
<!--         </div> -->
  <footer>
            <div class="container">
                <div class="footer-top">
                    <div class="row">
                        <div class="col-sm-6 col-md-3 col-xs-b30 col-md-b0">
                            <img style="    width: 150px;" src="index30dc.html" alt="" />
                            <div class="empty-space col-xs-b20"></div>
                            <div class="simple-article size-2 light fulltransparent">Encuentra los mejores precios en material y suplementación deportiva. Ofrecemos productos de alta calidad.</div>
                            <div class="empty-space col-xs-b20"></div>
                            <div class="footer-contact"><i class="fa fa-envelope-o" aria-hidden="true"></i> email: <a href="mailto:info@okeymas.es">info@okeymas.es</a></div>
                            <div class="footer-contact"><i class="fa fa-map-marker" aria-hidden="true"></i> dirección: <a href="#">El Puerto de Santa María, Cádiz.</a></div>
                        </div>
                        <div class="col-sm-6 col-md-3 col-xs-b30 col-md-b0">
                            <h6 class="h6 light">ENLACES</h6>
                            <div class="empty-space col-xs-b20"></div>
                            <div class="footer-column-links">
                                <div class="row">
                                    <div class="col-xs-5">
                                        <a href="okeymasTiendaUX.html">INICIO</a>
                                    <a href="#">DEPOROCIO</a>
                                    <a href="#">PRODUCTOS</a>
                                    <a href="https://okeymas.es/">OKEYMAS</a>
                                    <a href="#">contact</a>
                                    </div>
                                    
                                    <div class="col-xs-7">
                                       <a href="http://82.223.22.233:8080/GestPlus/resources/PoliticaPrivacidad.pdf">pOLÍTICA DE PRIVACIDAD</a>
	                                    <a href="#">POLÍTICA DE COOKIES</a>
	                                    <a href="http://82.223.22.233:8080/GestPlus/resources/AvisoLegalDeporOcio.pdf">AVISO LEGAL</a>
	                                    <a href="http://82.223.22.233:8080/GestPlus/resources/CondGeneralesContratacion.pdf">CONDICIONES GENERALES DE CONTRATACIÓN</a>
	                                  
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-md-3 col-xs-b30 col-md-b0">
                            <h6 class="h6 light">ENLACES</h6>
                            <div class="empty-space col-xs-b20"></div>
                            <div class="footer-column-links">
                                <div class="row">
                                    <div class="col-xs-12">
                                        <a href="okeymasTiendaProductos396f.html?idProveedor=1">MATERIAL DEPORTIVO</a>
                                        <a href="okeymasTiendaProductosbd5d.html?idProveedor=2">SUPLEMENTACIÓN DEPORTIVA</a>
                                       
                                    </div>
                                    
                                    
                                    
                                    
                                </div>
                            </div>
                        </div>
                       
                        <div class="col-sm-6 col-md-3">
                            <h6 class="h6 light">OKEYMAS</h6>
                            <div class="empty-space col-xs-b20"></div>
                            <div class="footer-column-links">
                                <div class="row">
                                    <div class="col-xs-12">
                                        <a href="https://okeymas.es/">VISITAR SITIO WEB</a>
                                    </div>
                                    
                                    
                                    
                                    
                                </div>
                            </div>
                            <div class="tags clearfix">
                                <a class="tag" href="altaOnlineUX.html">ALTA ONLINE</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="footer-bottom">
                    <div class="row">
                        <div class="col-lg-8 col-xs-text-center col-lg-text-left col-xs-b20 col-lg-b0">
                            <div class="copyright">&copy; © 2015 Todos los derechos reservados. Desarrollo por <a href="#" target="_blank">Crear & Co</a></div>
                            <div class="follow">
                                <a class="entry" href="https://www.facebook.com/okeymas.fitness.club/"><i class="fa fa-facebook"></i></a>
                                <a class="entry" href="https://www.instagram.com/okeymas.fitness.club/"><i class="fa fa-instagram"></i></a>
                            </div>
                        </div>
                        <div class="col-lg-4 col-xs-text-center col-lg-text-right">
                            <div class="footer-payment-icons">
                                
                                <a class="entry"><img src="index4dd7.html" alt="" /></a>
                                <a class="entry"><img src="index1c79.html" alt="" /></a>
                                <a class="entry"><img src="indexb66c.html" alt="" /></a>
                                <a class="entry"><img src="index2304.html" alt="" /></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        
</body>
</html>
</div>

<!-- <div id="loadingDiv" -->
<!-- 	style="z-index: 10002; position: fixed; top: 0px; left: 0px; overflow: visible; height: 100%; width: 100%; background: #FFFFFF; opacity: 0.8; -ms-filter: progid: DXImageTransform.Microsoft.Alpha(Opacity=80); filter: alpha(opacity = 80); -moz-opacity: 0.8; -khtml-opacity: 0.8;" -->
<!-- 	class="hiddenDiv"> -->
<!-- 	<table style="height: 10%; width: 10%"> -->
<!-- 		<tr valign="middle"> -->

<!-- 		</tr> -->
<!-- 	</table> -->
<!-- </div> -->



<!-- // var showLoading = function() { -->
<!-- // 	document.getElementById('loadingDiv').className='showDiv'; -->
<!-- // } -->
<!-- // var hideLoading = function () { -->
<!-- // 	document.getElementById('loadingDiv').className='hiddenDiv'; -->
<!-- // } -->



</body>
</html>
